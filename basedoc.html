<!DOCTYPE html>
<html lang="fr">
<head>
<link rel="apple-touch-icon" href="./icons/icon-180.png?v=2">
<link rel="apple-touch-icon" sizes="512x512" href="./icon-512.png?v=2">
<link rel="apple-touch-icon" sizes="192x192" href="./icon-192.png?v=2">
<link rel="apple-touch-icon" sizes="180x180" href="./icon-180.png?v=2">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="apple-mobile-web-app-orientations" content="landscape">
<link rel="manifest" href="./manifest.webmanifest">
<link rel="apple-touch-icon" href="./icons/icon-180.png">
<meta name="theme-color" content="#0f1115">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ServiceFlow">

<title>SWISS ServiceFlow â€” Seatmap & Service â€” v.1.0</title>

<style>

/* ThÃ¨me CLAIR (proche app officielle) */
body.theme-light{
  --bg:#F5F6F8;
  --panel:#FFFFFF;
  --panel-2:#F7F8FA;
  --panel-border:#E3E8EF;
  --hairline:#E5EAF0;

  --text:#1F2937;  /* encre */
  --muted:#6B778C;

  --accent:#2F6BFF;   /* action principale */
  --ok:#2EAE6A;
  --warn:#F2B84B;
  --danger:#E24A4A;
  --gold:#C7A600;

  --hon:#111111; --ftl:#8E98A8;

  --grid:#E9EDF5;
  --seat:#F3F6FB;
  --seat-border:#D6DFEA;
  --seat-active:#E9F1FF;

  --chip:#F2F4F7;
  --aisle:#FAFBFD;

  --vip:#8B5CF6; --pad:#39D98A; --fcl:#FF5757;
}

/* ThÃ¨me SOMBRE (tes couleurs actuelles) */
body.theme-dark{
  --bg:#0f1115; --panel:#151924; --panel-2:#1b2030; --text:#e7ecf3; --muted:#9aa4b2;
  --accent:#6aa4ff; --ok:#43c174; --warn:#f2b84b; --danger:#ef5b5b; --gold:#ffd24d;
  --hon:#111; --ftl:#8e98a8; --grid:#23293a; --seat:#1e2433; --seat-border:#2b3347;
  --vip:#9b5cff; --pad:#39d98a; --fcl:#ff5757; --seat-active:#2a3350; --chip:#232a3c; --aisle:#0d1220;
  --panel-border:#232a3d; --hairline:#202636;
}

/* Ajustements de styles pour le thÃ¨me clair */
body.theme-light header{
  background:linear-gradient(180deg,rgba(255,255,255,.95),rgba(255,255,255,.9));
  border-bottom:1px solid var(--hairline);
}
body.theme-light html, body.theme-light body{ background:var(--bg); color:var(--text); }

body.theme-light input,
body.theme-light select,
body.theme-light textarea{
  background:var(--panel);
  border:1px solid var(--panel-border);
  color:var(--text);
}

body.theme-light .btn{
  background:var(--panel-2);
  border:1px solid var(--panel-border);
  color:var(--text);
}
body.theme-light .btn.ghost{ background:transparent; border-color:var(--panel-border); }
body.theme-light .btn.primary{ background:var(--accent); border-color:transparent; color:#fff; }

body.theme-light aside,
body.theme-light .section,
body.theme-light .seatmap{
  background:var(--panel);
  border:1px solid var(--panel-border);
}

body.theme-light .badge{
  background:#EFF4FF;           /* pastille claire type â€œinfoâ€ */
  border:1px solid var(--panel-border);
  color:#1E40AF;
}

body.theme-light .legend .item{
  background:var(--chip);
  border:1px solid var(--panel-border);
  color:var(--muted);
}

body.theme-light .aisle{
  background:var(--aisle);
  border:1px dashed #D5DDE8;
}

body.theme-light .seat{
  background:var(--seat);
  border:1px solid var(--seat-border);
}
body.theme-light .seat.occupied{
  outline:2px solid #BBD0FF;
  background:var(--seat-active);
}

body.theme-light .title{ color:#1F2937; }

/* VisibilitÃ© en thÃ¨me clair : tags, icÃ´nes siÃ¨ge et flow */
body.theme-light .iconbar .icon,
body.theme-light .meal-tag{
  background: var(--chip);           /* clair */
  border: 1px solid var(--panel-border);
  color: var(--text);
}

body.theme-light .mini .dot{
  border-color: var(--seat-border);  /* au lieu de #2a3246 */
}

body.theme-light .flow-item{
  border: 1px solid var(--panel-border);
  background: var(--panel);
}
body.theme-light .flow-item:hover{
  background: var(--panel-2);        /* hover clair, lisible */
}

body.theme-light .flow-seat{
  color: var(--text);
}

/* Sous-ligne discrÃ¨te (libellÃ© boisson du plat) */
.flow-sub{
  flex-basis: 100%;     /* prend toute la largeur disponible */
  text-align: left;    /* colle Ã  gauche */
  font-size: 12px;
  color: var(--muted);
  line-height: 1.2;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

body.theme-light .tag{
  background: var(--chip);           /* pastille claire */
  border: 1px solid var(--panel-border);
  color: var(--text);
}

/* exceptions dÃ©jÃ  colorÃ©es (gardent leur contraste) */
body.theme-light .tag.hon{ background:#000; color:#fff; }
body.theme-light .tag.sen{ background:#3a2e00; color:#ffd24d; }
body.theme-light .tag.later{ background:#eaf6ea; border-color: var(--panel-border); }
body.theme-light .tag.sleep{ background:#eef0f5; border-color: var(--panel-border); }
body.theme-light .tag.vip{ background: var(--vip); color:#fff; }
body.theme-light .tag.pad{ background: var(--pad); color:#fff; }
body.theme-light .tag.fcl{ background: var(--fcl); color:#fff; }
body.theme-light .tag.ftl{ background: var(--ftl); color:#fff; }

  *{box-sizing:border-box}
  html,body{height:100%;background:var(--bg);color:var(--text);margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
  header{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,rgba(18,20,27,.95),rgba(18,20,27,.85));backdrop-filter:saturate(1.2) blur(6px);border-bottom:1px solid #202636}
  .wrap{max-width:1200px;margin:0 auto;padding:10px 14px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
/* Force la rangÃ©e "impression / export" Ã  passer sur une nouvelle ligne
   et Ã  s'aligner Ã  gauche, utile quand les libellÃ©s (DE) sont plus longs */
header .wrap { display:flex; flex-wrap:wrap; }               /* explicite */
header .wrap > .row:last-child{
  flex: 1 0 100%;        /* prend toute la largeur = nouvelle ligne */
  justify-content: flex-start;  /* aligne Ã  gauche */
}
  input,select,textarea{background:var(--panel);border:1px solid #242b3c;color:var(--text);padding:10px 12px;border-radius:10px;outline:none;min-width:0}
  textarea{width:100%;min-height:70px;resize:vertical}
  input[type=number]{width:90px}
  .btn{background:var(--panel-2);border:1px solid #2a3246;color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer}
  .btn:hover{background:#26304a}
.btn:disabled{opacity:.5; cursor:not-allowed}
  .btn.ghost{background:transparent;border-color:#2a3246}
  .btn.primary{background:var(--accent);border-color:transparent;color:#0b1220;font-weight:700}
#clientView.btn.primary{box-shadow:0 0 0 2px rgba(11,18,32,.15) inset}
#serveAperitif.btn.primary, #serveMeal.btn.primary{box-shadow:0 0 0 2px rgba(11,18,32,.15) inset}
  .btn.danger{background:var(--danger);border-color:transparent;color:#1a0b0b;font-weight:700}
  .btn.icon{ padding:2px 6px; font-size:16px; line-height:1 }
.btn.icon.active {
  outline: 2px solid var(--accent);
  outline-offset: 2px;
}
  .spacer{flex:1 1 auto}
  .pill{background:var(--chip);padding:8px 10px;border-radius:999px;border:1px solid #2a3246;color:var(--muted)}
/* === DRINK GRID â€“ layout & feedback === */
.pill-grid { display:flex; flex-direction:column; gap:12px; }

.group-card {
  border:1px solid var(--panel-border);
  border-radius:12px;
  padding:10px;
  background:var(--panel);
}
.group-title {
  display:inline-block;
  border:1px solid var(--panel-border);
  border-radius:999px;
  padding:4px 10px;
  font-weight:600;
  margin-bottom:8px;
  user-select:none;
}

/* Force la grille des boissons Ã  occuper toute la ligne */
#drinkGrid{
  flex: 1 1 100%;
  width: 100%;
  min-width: 0;   /* Ã©vite lâ€™overflow en flex */
}

/* (optionnel, par sÃ©curitÃ©) Ã©tirer chaque carte sur la largeur */
#drinkGrid .group-card{
  width: 100%;
}


/* Titres encadrÃ©s pour les sous-sections d'options */
/* Titres encadrÃ©s des sous-options (lait, sucre, etc.) */
.opt-title{
  display:inline-block;
  margin: 8px 0 4px;
  padding: 4px 8px;
  border: 1px solid var(--panel-border);
  border-radius: 999px;
  font-weight: 600;
  font-size: 0.9rem;
  background: var(--panel-2);
  color: var(--text);
}

/* Les toggles (ex: ğŸ§Š ğŸ‹ ğŸ˜‡) sont des buttons .pill, comme les autres */
.pill.toggle[aria-pressed="true"],
.pill.active { outline:2px solid var(--accent); outline-offset:2px; border-radius:14px; }


/* rangÃ©es & boutons */
.pill-row {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  width: 100%;       /* ğŸ‘ˆ prend toute la largeur disponible */
  justify-content: flex-start; /* ğŸ‘ˆ garde lâ€™alignement Ã  gauche */
}
/* Wrap emoji + lÃ©gende (ligne en dessous) */
.pill-wrap{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:2px;
  min-width:56px;         /* stabilitÃ© dâ€™alignement */
}

/* La lÃ©gende sous lâ€™emoji */
.pill-cap{
  font-size:10px;         /* petit, lisible */
  line-height:1.05;
  color: var(--muted);    /* sâ€™adapte clair/sombre */
  text-align:center;
  max-width:70px;         /* coupe proprement si long */
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* Hook pour futur toggle (on pourra masquer/afficher en 1 classe) */
#drinkGrid.caps-off .pill-cap{
  display:none;
}

.pill.big { font-size:1.8rem; line-height:1; padding:8px 12px; }
.pill { margin: 2px; font-size:1.6rem; line-height:1; padding:8px 10px; }

/* feedback actif (clic) */
.pill.active,
label:has(input[type=checkbox]:checked) {
  outline:2px solid var(--accent);
  outline-offset:2px;
  border-radius:14px;
}
.pill:focus-visible { outline:2px dashed var(--accent); outline-offset:2px; }

/* cases optionnelles sous une rangÃ©e */
.pill-subrows { display:flex; flex-direction:column; gap:6px; }

  /* SPML : ne pas s'Ã©tirer en largeur */
#lblSpml { display:inline-block; }
#spmlAddCode { width:auto; }
/* Fix spacing titre "Notes boissons repas" */
#mealDrinkNotesBlock { padding-top: 2px; }
#mdMealDrinkNotes {
  display: inline-block;     /* Ã©vite l'Ã©crasement vertical */
  line-height: 1.25;         /* plus dâ€™air au-dessus/dessous du texte */
  padding: 2px 8px;          /* coussin interne haut/bas */
  margin: 2px 0 6px;         /* espace avec ce qui suit (textarea) */
}

.grid{
  display:grid;
  grid-template-columns: 280px minmax(0,1fr) 300px;  /* milieu compressible */
  gap:12px;
  max-width:1200px;
  padding:14px;
  margin:0 auto;
}

/* iPad & Ã©crans â€œmoyensâ€ : un peu plus compact sur les cÃ´tÃ©s */
@media (max-width:1180px){
  .grid{
    grid-template-columns: 260px minmax(0,1fr) 260px;
  }
}

@media (max-width:980px){
  /* 1 colonne en mobile */
  .grid{ 
    display:flex; 
    flex-direction:column; 
  }

  /* ordre des panneaux */
  .grid > main{ order:1; }
  .grid > aside{ order:2; }
  #flowAside{ order:3; }

  aside{ position: static; }   /* plus de sticky en mobile */
  .seatmap{ position: relative; z-index: 1; }

  /* stabilise la rangÃ©e dâ€™actions du header */
  header .wrap > .row:last-child{
    flex-wrap: nowrap;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  #phaseChips{ flex:0 0 auto; }
  .chips{ flex-wrap: nowrap; }
#filterSelect, #exportJSON, #importJSON, #exportPNG{ flex:0 0 auto; }
}

  aside{background:var(--panel-2);border:1px solid #232a3d;border-radius:16px;padding:12px;position:sticky;top:68px;height:fit-content}
  aside h3{margin:6px 0 8px 0;font-size:14px;color:var(--muted);font-weight:600;letter-spacing:.4px}
  .inventory{display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center}
  .badge{min-width:34px;text-align:center;padding:6px 8px;border-radius:10px;background:#24304a;border:1px solid #2a3246;color:#cfe0ff;font-weight:700}
  .badge.ok{background:#183826;color:#b5f1c9;border-color:#215235}
  .badge.low{background:#3a300f;color:#ffe79a;border-color:#5a4816}
  .badge.zero{background:#3b1818;color:#ffc3c3;border-color:#5a2424}
  .seatmap{background:var(--panel);border:1px solid #232a3d;border-radius:16px;padding:12px}
/* Seatmap sans scroll forcÃ© */
.seatmap{ overflow: visible; }         /* au lieu de overflow:auto/hidden */
.seatmap .seatgrid{ overflow: visible; max-width:100%; }  /* enlÃ¨ve tout scroll interne */
  .seatgrid{display:grid;gap:6px;margin-top:10px}
  .seatgrid.moving .seat { outline:2px dashed #3a4e7c; }
.seatgrid.moving .seat:hover { outline-style:solid; }
  .row-label{color:var(--muted);font-size:12px;text-align:right;padding-right:6px;display:flex;align-items:center;justify-content:flex-end}
  .aisle{background:var(--aisle);border:1px dashed #2a3148;border-radius:12px;min-height:48px}
  .seat{background:var(--seat);border:1px solid var(--seat-border);border-radius:10px;min-height:48px;display:flex;align-items:center;justify-content:center;gap:6px;position:relative;user-select:none;touch-action:manipulation;cursor:pointer;overflow:hidden}
  .seat.bus{background:linear-gradient(180deg,#24314b,#21283b)}
  .seat.occupied{outline:2px solid #3a4e7c;background:var(--seat-active)}
  .seat .mini{position:absolute;top:4px;left:6px;display:flex;gap:4px;z-index:2}
  .mini .dot{width:9px;height:9px;border-radius:50%;border:1px solid #2a3246}
  .dot.ftl{background:var(--ftl)} .dot.sen{background:var(--gold)} .dot.hon{background:var(--hon);border-color:#555}
.dot.vip{background:var(--vip)}
.dot.pad{background:var(--pad)}
.dot.fcl{background:var(--fcl)}
  .iconbar{position:absolute;bottom:4px;left:4px;display:flex;gap:4px;font-size:13px;opacity:.95;z-index:2}
  .icon{background:#222a3a;padding:2px 6px;border-radius:8px;border:1px solid #2a3246}
  .sleeping{filter:grayscale(1) opacity(.85)}
  .seat-label{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:600;z-index:1;pointer-events:none}
  .legend{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px;font-size:12px;color:#bcc7d8}
  .legend .item{display:flex;gap:6px;align-items:center;background:#172033;border:1px solid #26314d;padding:6px 8px;border-radius:10px}
  .legend .square{width:12px;height:12px;border-radius:3px;border:1px solid #2a3246}
.legend {
  display: flex;
  flex-direction: column; /* chaque ligne lâ€™une sous lâ€™autre */
  gap: 6px;
}

.legend-row {
  display: flex;
  gap: 8px;
  flex-wrap: wrap; /* permet le retour Ã  la ligne si lâ€™Ã©cran est Ã©troit */
}
  .square.ftl{background:var(--ftl)} .square.sen{background:var(--gold)} .square.hon{background:var(--hon);border-color:#555}
.square.vip{background:var(--vip)}
.square.pad{background:var(--pad)}
.square.fcl{background:var(--fcl)}
  .section{background:var(--panel);border:1px solid #232a3d;border-radius:16px;padding:12px;margin-top:12px}
  .title{font-weight:700;margin:0 0 6px 0;color:#cfe0ff}
  .chips{display:flex;gap:6px;flex-wrap:wrap}
  .chip{background:var(--chip);border:1px solid #2a3246;border-radius:999px;padding:6px 10px;color:#cfe0ff;cursor:pointer}
  .chip.active{background:#2b3a5a;border-color:#385080}
  .meal-tag{position:absolute;top:4px;right:6px;font-size:12px;background:#222a3a;border:1px solid #2a3246;padding:2px 6px;border-radius:8px;z-index:3}
  @media print{header,aside,.modal-back,.legend{display:none!important} body{background:#fff;color:#000} .seat{min-height:24px;border:1px solid #999;border-radius:4px} .grid{grid-template-columns:1fr} .aisle{border:1px dashed #bbb}}
  @media print {
  #historySection, #flowAside { display: none !important; }
}

  /* Modal */
  .modal-back{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(5,8,15,.55); z-index:100}
  .modal{background:var(--panel-2); border:1px solid #2a3146; border-radius:16px; padding:12px; max-width:860px; width:min(95vw,860px); box-shadow:0 10px 30px rgba(0,0,0,.4)}
  /* Modale compacte pour la fiche pax */
.modal.mono {
  max-width: 560px;
  width: min(95vw, 560px);
}
.modal.mono .two {
  grid-template-columns: 1fr;
}
  .two{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  @media (max-width:780px){ .two{grid-template-columns:1fr} }

/* Mode client : vue Ã©purÃ©e */
body.client aside,
body.client #historySection,
body.client #importJSON,
body.client #exportJSON,
body.client #exportPNG,
body.client #filterSelect,
body.client #phaseChips,
body.client #saveTitle,
body.client #saveSnapshot,
body.client #resetFlight,
body.client .legend,
body.client .iconbar,
body.client .meal-tag,
body.client .seatmap {
  display: none !important;
}

#langButtons { margin-left:auto; }
/* Lang dropdown */
.lang-dropdown{ position:relative; }
#langActive{ min-width:56px; }
.lang-menu{
  position:absolute; top:100%; left:0; margin-top:4px;
  display:none; flex-direction:column; gap:6px;
  background:var(--panel); border:1px solid var(--panel-border);
  border-radius:10px; padding:6px; z-index:60;
}
.lang-dropdown.open #langMenu{ display:flex; }
.lang-menu .btn{ width:100%; justify-content:center; }

/* Panneau Service Flow (Ã  droite) */
#flowAside{background:var(--panel);border:1px solid var(--panel-border);border-radius:10px;padding:10px;}
/* Permet au panneau de droite de rÃ©trÃ©cir correctement en grid */
#flowAside{ min-width: 0; }

/* Dans chaque ligne du flow, la description peut se comprimer sans pousser hors Ã©cran */
.flow-item{ align-items:flex-start; }         /* Ã©vite des hauteurs trop fortes */
.flow-desc{ flex:1 1 auto; min-width:0; }     /* pas de dÃ©bordement horizontal */
#flowAside .section{margin-top:12px}
#flowAside .title{font-weight:600;margin-bottom:6px}
.flow-list{display:flex;flex-direction:column;gap:6px}
.flow-item{
  display: flex;
  flex-wrap: wrap;      /* â† autorise plusieurs lignes */
  align-items: center;
  gap: 6px;
  padding: 4px 8px;
}
.flow-item:hover{background:#0f1420}
.flow-seat{font-weight:700;min-width:42px;text-align:center}
.tag{font-size:12px;padding:2px 6px;border-radius:999px;background:#1b2334;border:1px solid #2a3246}
.tag.hon{background:#000;color:#fff}
.tag.sen{background:#3a2e00;color:#ffd24d}
.tag.chml{background:#2b1133;color:#eaa3ff}
.tag.vip { background: var(--vip); color:#fff }
.tag.pad { background: var(--pad); color:#fff }
.tag.fcl { background: var(--fcl); color:#fff }  
.tag.later{background:#1d2a1d}
.tag.sleep{background:#222}

/* === Datepicker (lÃ©ger, inline) === */
.dp {
  position: absolute;
  background: var(--panel);
  border: 1px solid var(--panel-border);
  border-radius: 12px;
  padding: 8px;
  box-shadow: 0 8px 24px rgba(0,0,0,.25);
  z-index: 200;
  width: 260px;
  user-select: none;
}
.dp header { display:flex; align-items:center; justify-content:space-between; margin-bottom:6px; }
.dp header .m { font-weight:600; }
.dp button { cursor:pointer; }
.dp .grid { display:grid; grid-template-columns: repeat(7, 1fr); gap:4px; }
.dp .w, .dp .d { text-align:center; padding:6px 0; border-radius:8px; }
.dp .w { color: var(--muted); font-size:12px; }
.dp .d { background: var(--panel-2); border:1px solid var(--panel-border); }
.dp .d:hover { filter: brightness(1.06); }
.dp .d.out { opacity:.35; }
.dp .d.today { outline:2px solid var(--accent); }
.dp .d.sel { background: var(--accent); color:#fff; border-color: transparent; }
/* Tag seat "eat together" : bas-centre */
.seat-tag{
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  bottom: 4px;
  font-size: 12px;
  background: #222a3a;
  border: 1px solid #2a3246;
  padding: 2px 6px;
  border-radius: 8px;
  z-index: 4;            /* au-dessus des icÃ´nes et du fond */
  pointer-events: none;  /* ne gÃªne pas les clics sur le siÃ¨ge */
}
.seat-tag.eatwith-tag{ opacity: .98; }
/* === SIZE OVERRIDES (COMPACT) â€” colle Ã  la fin du <style> === */
:root{
  --fz-base:16px;           /* taille de base du texte */
  --fz-small:12px;          /* petits textes (lÃ©gendes) */
  --fz-pill:1.05rem;        /* pills normales (mini-pills) */
  --fz-pill-big:1.25rem;    /* grosses pills (catÃ©gories) */
}

html{ font-size: var(--fz-base); }

/* Boutons & inputs plus compacts */
.btn{ padding:8px 10px; font-size:14px; }
.btn.icon{ font-size:18px; padding:6pxx 10px; }

input,select,textarea{ padding:8px 10px; font-size:14px; }

/* DRINK GRID : rÃ©duire la densitÃ© */
.pill-grid{ gap:8px; }                 /* Ã©tait 12px */
.group-card{ padding:8px; }            /* Ã©tait 10px */
.group-title{ font-size: var(--fz-small); padding:2px 8px; }

/* Pills (emojis) â€” tailles et espacements */
.pill{ font-size: var(--fz-pill); padding:6px 8px; }       /* Ã©tait 1.6rem / 8-10px */
.pill.big{ font-size: var(--fz-pill-big); padding:6px 10px; } /* Ã©tait 1.8rem / 8-12px */

/* LÃ©gendes & sous-infos plus petites */
.legend{ font-size:11px; }
.flow-sub{ font-size:11px; }

/* SiÃ¨ges & allÃ©e un poil moins hauts (facultatif) */
.seat{ min-height:40px; }   /* Ã©tait 48px */
.aisle{ min-height:40px; }  /* Ã©tait 48px */

/* SÃ©curitÃ© anti-blocage */
#drinkGrid, #drinkGrid * { pointer-events: auto; }
#tcBlock[hidden] #drinkGrid,
#mealBlock[hidden] #drinkGrid { pointer-events: none; } /* seulement si vraiment masquÃ© */

.pill.big[disabled] { pointer-events: none; }
.pill.big:not([disabled]) { pointer-events: auto; }

</style>
</head>
<body class="theme-dark">
<header>
  <div class="wrap row">
    <div class="row" style="gap:6px">
<button class="btn primary" id="clientView">ğŸ‘€ Mode client</button>
<label class="pill" id="lblFlight">Flight</label>
      <input id="flightNo" type="text" placeholder="(ex: LX2810)" style="width:160px">
<label class="pill" id="lblDate">Date</label>
<input id="flightDate" type="text" inputmode="none" autocomplete="off" style="width:170px" placeholder="">
      <input type="hidden" id="flightDateISO">      
<button class="btn ghost" id="saveSnapshot">ğŸ’¾</button>
<button class="btn ghost" id="importJSON">ğŸ“</button>
<input
  type="file"
  id="importFile"
  accept=".json,application/json"
  style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0"
/>
<button class="btn ghost" id="exportPNG">ğŸ–¼ï¸ PNG</button>

<button class="btn danger" id="resetFlight">RÃ©initialiser fin de vol</button>

<!-- Lang buttons (EN/DE/FR) -->
<div class="row" id="langButtons" style="gap:6px; margin-left:auto">
  <div class="lang-dropdown" id="langDropdown">
    <button class="btn" id="langActive" aria-haspopup="listbox" aria-expanded="false">ğŸ‡¬ğŸ‡§ â–¾</button>
    <div class="lang-menu" id="langMenu" role="listbox">
      <button class="btn" role="option" data-lang="EN">ğŸ‡¬ğŸ‡§</button>
      <button class="btn" role="option" data-lang="DE">ğŸ‡©ğŸ‡ª</button>
      <button class="btn" role="option" data-lang="FR">ğŸ‡«ğŸ‡·</button>
    </div>
  </div>
  <button class="btn" id="themeToggle">ğŸŒ™</button>
</div>

    </div>
    <div class="spacer"></div>
    <div class="row">
      <div id="phaseChips" class="chips">
        <div class="chip active" data-phase="fiche" id="chips_fiche">ğŸ§¾ Fiche</div>
        <div class="chip" data-phase="aperitif">ApÃ©ritif</div>
        <div class="chip" data-phase="repas">Plat</div>
        <div class="chip" data-phase="tc">ThÃ© & CafÃ©</div>

      </div>

      <select id="filterSelect" title="Filtrer">
        <option value="all">Tous les siÃ¨ges</option>
        <option value="toServe">Ã€ servir</option>
        <option value="sleeping">En train de dormir</option>
        <option value="later">Servir plus tard</option>
        <option value="clear">Ã€ dÃ©barrasser</option>
      </select>

    </div>
  </div>
</header>

<div class="grid">
  <aside>
<h3 id="hdrConfig">Curtain & configuration</h3>
<div class="row" style="margin-bottom:8px">
<label class="pill" id="lblLayout">Cabin layout</label>
    <select id="layoutSelect" title="Type d'appareil">
      <option value="A220">A22X</option>
      <option value="A320">A32X</option>
    </select>
  </div>
    <div class="row" style="margin-bottom:8px">
<label class="pill" id="lblRows">Rows</label>
<div class="row" style="gap:4px">
  <button class="btn" id="rowsBizMinus">â€“</button>
  <div class="badge" id="rowsBizDisplay">4</div>
  <button class="btn" id="rowsBizPlus">+</button>
</div>
    </div>
    <div class="section">
<div class="title" id="secMenuTitle">Meal labels</div>
<label class="pill" id="lblViande" style="display:inline-block;margin-bottom:8px">Option 1</label>
<input id="labelViande" type="text" placeholder="ex: Beef with red wine sauce">
<label class="pill" id="lblVege" style="margin-top:6px;display:inline-block;margin-bottom:8px">Option 2</label>
<input id="labelVege" type="text" placeholder="ex: Vegetarian lasagna">
    </div>
<h3 id="hdrInventaire">Inventory</h3>
    <div class="inventory" id="inv">
<div id="lblInvPlateaux">Trays</div>
      <div class="badge" data-badge="plateaux">0</div>
      <div class="row"><button class="btn" data-inv="-1" data-key="plateaux">â€“</button><button class="btn" data-inv="+1" data-key="plateaux">+</button></div>

<div id="lblInvViande">Option 1</div>
      <div class="badge" data-badge="hot_viande">0</div>
      <div class="row"><button class="btn" data-inv="-1" data-key="hot_viande">â€“</button><button class="btn" data-inv="+1" data-key="hot_viande">+</button></div>

<div id="lblInvVege">Option 2</div>
      <div class="badge" data-badge="hot_vege">0</div>
      <div class="row"><button class="btn" data-inv="-1" data-key="hot_vege">â€“</button><button class="btn" data-inv="+1" data-key="hot_vege">+</button></div>

<div id="lblInvSpecial">Special</div>
      <div class="badge" data-badge="hot_special" title="Somme des SPML">0</div>
      <div class="row"></div>

      <div class="inventory" id="spmlInv" style="grid-column:1 / -1"></div>

<div id="preHeader">Pre-order</div>
      <div class="badge" data-badge="hot_pre" title="Pre-order sum">0</div>
      <div class="row"></div>

      <div class="inventory" id="preInv" style="grid-column:1 / -1"></div>

<div style="grid-column:1 / -1; margin-top:6px; display:inline-grid; grid-template-columns:1fr; gap:8px; width:auto">
<!-- L1 : titre SPML seul -->
<div class="row" style="grid-column:1 / -1; margin-top:6px">
  <label class="pill" id="lblSpml" style="display:inline-block">SPML</label>
</div>

<!-- L2 : liste dÃ©roulante seule -->
<div class="row" style="grid-column:1 / -1">
  <select id="spmlAddCode" title="Ajouter code SPML" style="width:auto">
    <option value="">Ajouterâ€¦</option>
  </select>
</div>

<!-- L3 : quantitÃ© + bouton Ã  droite -->
<div class="row" style="grid-column:1 / -1">
  <input id="spmlAddQty" type="number" min="1" value="1" style="width:90px">
  <button class="btn" id="spmlAddBtn" data-i18n-btn="add">Add</button>
</div>

      <div class="row" style="grid-column:1 / -1; margin-top:6px">
<label class="pill" id="lblPreAdd">Pre-order</label>
        <input id="preAddLabel" type="text" placeholder="ex: Glutenfree pasta" style="width:180px">
        <input id="preAddQty" type="number" min="1" value="1" style="width:90px">
<button class="btn" id="preAddBtn" data-i18n-btn="add">Add</button>
      </div>
    </div>
  </aside>

<main>
  <div class="seatmap"> <!-- AJOUT -->
<div class="title" id="seatmapTitle"></div>

<div class="legend">
  <!-- Statuts -->
  <div class="row">
    <div class="item"><div class="square ftl"></div>FTL</div>
    <div class="item"><div class="square sen"></div>SEN</div>
    <div class="item"><div class="square hon"></div>HON</div>
    <div class="item"><div class="square vip"></div>VIP</div>
    <div class="item"><div class="square fcl"></div>FCL</div>
    <div class="item"><div class="square pad"></div>PAD</div>
  </div>

  <!-- Situations -->
  <div class="row">
    <div class="item"><span id="lgInfant">ğŸ‘¶ Infant</span></div>
    <div class="item"><span id="lgChild">ğŸ§’ Child</span></div>
    <div class="item"><span id="lgSleep">ğŸ˜´ Sleeping</span></div>
  </div>

  <!-- Ã‰tat service -->
  <div class="row">
    <div class="item"><span id="lgTogether">ğŸ¤ Serve with</span></div>
    <div class="item"><span id="lgLater">â³ Serve later</span></div>
    <div class="item"><span id="lgServed">âœ… Served</span></div>
    <div class="item"><span id="lgclear">ğŸ§¹ Tray cleared</span></div>
  </div>
</div>

    <div id="seatgrid" class="seatgrid"></div>
  </div> <!-- ce </div> existait dÃ©jÃ  juste aprÃ¨s #seatgrid : il devient la FERMETURE de .seatmap -->
<div class="section" id="historySection">
<div class="title" id="secHistoryTitle">History (newest on top)</div>
<!-- TRI simple -->
<div class="row" id="histSortBar" style="gap:8px;margin:6px 0">
<button class="btn ghost" id="histOrderBtn" title="Inverser l'ordre">â€”</button>

</div>
<div id="histControls" class="row" style="gap:8px;margin:6px 0 8px 0;align-items:center">
  <label class="pill" id="histLbl">Affichage</label>

  <select id="histMode" title="Filtrer l'historique">
    <option value="all">Tous les Ã©vÃ©nements</option>
    <option value="seat">Par siÃ¨ge</option>
    <option value="type">Par type</option>
  </select>

 <span id="histSeatWrap" class="row" style="gap:6px;display:none">
  <label class="pill" id="histLblSeat">SiÃ¨ge</label>
  <select id="histSeat" style="width:90px">
    <option value="">â€”</option>
  </select>
</span>

  <span id="histTypeWrap" class="row" style="gap:6px;display:none">
    <label class="pill" id="histLblType">Type</label>
    <select id="histType">
      <option value="apServed">ApÃ©ritif servi</option>
      <option value="mealDrinkServed">Meal drink</option>
      <option value="tcServed">ThÃ© & CafÃ© servi</option>
      <option value="mealServed">Plat servi</option>
      <option value="apCanceled">ApÃ©ritif annulÃ©</option>
      <option value="serviceCanceled">Service annulÃ©</option>
      <option value="trayCleared">Plateau dÃ©barrassÃ©</option>
      <option value="trayUncleared">Annuler dÃ©barrassage</option>
      <option value="reset">RÃ©initialisation vol</option>
      <option value="seatMoveStart">Move pax (dÃ©but)</option>
      <option value="seatSwapped">Seats swapped</option>
      <option value="text">Notes</option>
    </select>
  </span>

</div>
  <div id="history" style="display:flex;flex-direction:column;gap:6px"></div>
</div>
</main>

<aside id="flowAside">
  <h3 id="flowTitle">Order flow</h3>
<div class="section">
  <div class="title" id="remindersTitle">Upcoming reminders</div>
      <div id="remindersList" style="display:flex;flex-direction:column;gap:6px"></div>
    </div>

  <div class="section">
    <div class="title" id="flowLaterTitle">Plus tard</div>
    <div id="flowLater" class="flow-list"></div>
  </div>

 <div class="section">
    <div class="title" id="flowNowTitle">Ã€ servir maintenant</div>
    <div id="flowNow" class="flow-list"></div>
  </div>

    <div class="section">
    <div class="title" id="flowClearTitle">Ã€ dÃ©barrasser</div>
    <div id="flowClear" class="flow-list"></div>
  </div>


</aside>

</div>

<div class="modal-back" id="modalBack">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="row">
      <h3 id="modalTitle" class="title">SiÃ¨ge</h3>
      <div class="spacer"></div>
      <!-- NAVIGATION ENTRE MODES (Ã  cÃ´tÃ© de ğŸ˜´) -->
<div id="modalPhaseNav" class="row" style="gap:6px; margin:0 8px 0 4px">
  <button class="btn ghost icon" id="navFicheBtn"  title="Fiche">ğŸ§¾</button>
  <button class="btn ghost icon" id="navAperoBtn"  title="ApÃ©ritif">ğŸ·</button>
<button class="btn ghost icon" id="navMealBtn"   title="Plat">ğŸ±</button>
  <button class="btn ghost icon" id="navTCBtn"     title="ThÃ© & CafÃ©">â˜•</button>
</div>

        <button class="btn ghost icon" id="sleepModalBtn">ğŸ˜´</button>
      <button class="btn" id="movePaxBtn" data-i18n="moveSeat">ğŸ” Move</button>
<button class="btn ghost icon" id="closeModal">âœ–ï¸</button>
    </div>
    <div class="two">
      <div>
<div class="title" id="mdPass">Passenger</div>
<div class="row" style="margin-bottom:6px">
<label class="pill" id="mdOcc">Seat occupied</label>
  <label style="display:inline-flex;align-items:center;gap:8px">
    <input id="m_occ_chk" type="checkbox">
  </label>
</div>
<div class="row" style="margin-bottom:6px">
<label class="pill" id="mdType">Type</label>
  <div class="row" id="m_type_group" style="gap:12px">
    <label style="display:inline-flex;align-items:center;gap:8px">
      <input type="radio" name="m_type" id="m_type_adult" value="normal">
<span id="mdAdult">ğŸ™‚ Adult</span>
    </label>
    <label style="display:inline-flex;align-items:center;gap:8px">
      <input type="radio" name="m_type" id="m_type_child" value="child">
<span id="mdChild">ğŸ™‚ Child</span>
    </label>
    <label style="display:inline-flex;align-items:center;gap:8px">
      <input type="radio" name="m_type" id="m_type_infant" value="infant">
<span id="mdInfant">ğŸ‘¶ Infant</span>
    </label>
  </div>
</div>
        <div class="row" style="margin-bottom:6px">
<label class="pill" id="mdStatus">Status</label>
          <select id="m_status"><option value="none">â€”</option><option value="FTL">FTL</option><option value="SEN">SEN</option><option value="HON">HON</option><option value="FCL">FCL</option><option value="VIP">VIP</option><option value="PAD">PAD</option><option value="Other" id="optStatusOther">Other</option></select>
<label class="pill" id="mdLang">Language</label>
          <select id="m_lang"><option value="">â€”</option><option value="DE">DE</option><option value="EN">EN</option><option value="FR">FR</option><option value="IT">IT</option></select>
        </div>
        <!-- === Eat together with === -->
<div class="row" style="margin-bottom:6px">  <!-- AJOUT marge pour Ã©viter chevauchement -->
  <div class="pill" id="mdEatWith">Eat together with</div>
  <div class="cell">
<select id="m_eatWith" style="width:120px">
  <option value="">â€”</option>
</select>
  </div>
</div>

        <div class="row" style="margin-bottom:6px">
<label class="pill" id="mdLater">Serve later</label>
<select id="m_later">
  <option value="">â€”</option>
  <option value="5">+5 min</option>
  <option value="10">+10 min</option>
  <option value="20">+20 min</option>
  <option value="custom" id="mdLaterCustom">Timeâ€¦</option>
</select>
          <input id="m_later_time" type="time" style="display:none">
          <button id="m_later_apply" class="btn" disabled>
  <span id="mdLaterSet">ğŸ•°ï¸ Set time</span>
</button>
<button id="m_later_cancel" class="btn" style="display:none">
  <span id="mdLaterCancel">Cancel</span>
</button>
<span id="m_later_view" class="pill" style="display:none"></span>
        </div>
<div style="margin:10px 0">
  <label class="pill" style="display:inline-block;margin-bottom:8px" id="mdNotes">Notes</label>
  <input id="m_notes" type="text" placeholder="ex: DE only, no nuts" style="width:100%">
</div>
      </div>
<div id="rightCol">
  <div id="rightNotes"></div> <!-- NOUVEAU : colonne notes Ã  droite -->
  <div id="mealBlock">
<div class="title" id="mdMeal">Meal</div>
        <div class="row" style="margin-bottom:6px">
<label class="pill" id="mdNormal">Normal choice</label>
<select id="m_normalMeal">
  <option value="">â€”</option>
  <option value="viande" id="optNormalMeat">Option 1</option>
  <option value="vege" id="optNormalVeg">Option 2</option>
  <option value="plateau" id="optNormalTray">Tray (no casserole)</option>
</select>
        </div>
        <div class="row" style="margin-bottom:6px">
<label class="pill" id="mdSpml">SPML</label>
          <select id="m_spml"><option value="">â€”</option></select>
        </div>
        <div class="row" style="margin-bottom:6px">
<label class="pill" id="mdPre">Pre-order</label>
          <select id="m_pre"><option value="">â€”</option></select>
        </div>
        <div class="row" style="margin-bottom:6px">

<!-- Meal drink notes -->
<div id="mealDrinkNotesBlock" style="margin-top:8px">
  <label class="pill" id="mdMealDrinkNotes">Meal drink notes</label>
  <textarea id="m_mealDrinkNotes" placeholder=""></textarea>
</div>
<div class="row" style="margin-bottom:6px">
<!-- Meal drink actions (SOUS les notes) -->
<div id="mealDrinkServeRow" class="row" style="margin-top:6px; display:none">
  <button class="btn primary" id="serveMealDrink" data-i18n="serveMealDrink">Serve drink</button>
  <button class="btn ghost" id="serveMealDrinkNone" data-i18n="serveNone">Rien</button>
  <span id="mhMealDrinkInline" style="font-size:12px;color:var(--muted);margin-left:8px">â€”</span>
</div>

<button class="btn primary" id="serveMeal">Serve main</button>
<button class="btn ghost" id="serveMealNone" data-i18n="serveNone">Rien</button>
<button class="btn ghost" id="clearTrayBtn">Plateau dÃ©barrassÃ©</button>

        <div id="m_history" style="font-size:13px;color:var(--muted)"></div>
      </div>

<!-- === Bloc ApÃ©ritif (visible en phase ApÃ©ritif) === -->
<div id="tcBlock" style="display:none">
  <div class="title" id="tcTitle">ApÃ©ritif</div>

<div class="row" style="margin-bottom:6px">

<!-- === DRINK GRID (nouvelle UI unifiÃ©e) === -->
<div id="drinkGrid" class="pill-grid">

  <!-- === HOT DRINKS === -->
  <div class="group-card" id="grpHot">
    <div class="group-title" id="hdrHot">Hot drinks</div>
<div class="pill-row" id="hotRow">
  <div class="pill-wrap">
    <button class="pill big" data-cat="chaud" data-sub="cafe"     title="Coffee" aria-label="Coffee">â˜•</button>
    <div class="pill-cap" data-i18n-cap="drink_coffee">Coffee</div>
  </div>
  <div class="pill-wrap">
    <button class="pill big" data-cat="chaud" data-sub="deca"     title="Decaf" aria-label="Decaf">ğŸš«â˜•</button>
    <div class="pill-cap" data-i18n-cap="drink_decaf">Decaf</div>
  </div>
  <div class="pill-wrap">
    <button class="pill big" data-cat="chaud" data-sub="the"      title="Tea" aria-label="Tea">ğŸ«–</button>
    <div class="pill-cap" data-i18n-cap="drink_tea">Tea</div>
  </div>
  <div class="pill-wrap">
    <button class="pill big" data-cat="chaud" data-sub="chocolat" title="Caotina" aria-label="Caotina">ğŸ«</button>
    <div class="pill-cap" data-i18n-cap="drink_caotina">Caotina</div>
  </div>
</div>
    <div id="hotOpts" class="pill-subrows"></div>
  </div>

  <!-- === SOFT DRINKS === -->
  <div class="group-card" id="grpSoft">
    <div class="group-title" id="hdrSoft">Soft drinks</div>
<div class="pill-row" id="softRow">
  <div class="pill-wrap">
    <button class="pill big" data-cat="soft" data-sub="eau"   title="Water" aria-label="Water">ğŸ’§</button>
    <div class="pill-cap" data-i18n-cap="drink_water">Water</div>
  </div>
  <div class="pill-wrap">
    <button class="pill big" data-cat="soft" data-sub="coca"  title="Cola" aria-label="Cola">ğŸ¥¤</button>
    <div class="pill-cap" data-i18n-cap="drink_cola">Cola</div>
  </div>
  <div class="pill-wrap">
    <button class="pill big" data-cat="soft" data-sub="jus"   title="Juice" aria-label="Juice">ğŸ§ƒ</button>
    <div class="pill-cap" data-i18n-cap="drink_juice">Juice</div>
  </div>
  <div class="pill-wrap">
    <button class="pill big" data-cat="soft" data-sub="sprite" title="Sprite" aria-label="Sprite">ğŸŸ¢</button>
    <div class="pill-cap" data-i18n-cap="drink_sprite">Sprite</div>
  </div>
  <div class="pill-wrap">
    <button class="pill big" data-cat="soft" data-sub="tonic"  title="Tonic" aria-label="Tonic">ğŸ«§</button>
    <div class="pill-cap" data-i18n-cap="drink_tonic">Tonic</div>
  </div>
</div>
    <div id="softOpts" class="pill-subrows"></div>
  </div>

  <!-- === ALCOHOLIC DRINKS === -->
  <div class="group-card" id="grpAlco">
    <div class="group-title" id="hdrAlco">Alcoholic drinks</div>
<div class="pill-row" id="alcoRow">
  <div class="pill-wrap">
    <button class="pill big" data-cat="alcool" data-sub="champagne" title="Champagne" aria-label="Champagne">ğŸ¾</button>
    <div class="pill-cap" data-i18n-cap="drink_champagne">Champagne</div>
  </div>
  <div class="pill-wrap">
    <button class="pill big" data-cat="alcool" data-sub="vin_rouge" title="Red wine" aria-label="Red wine">ğŸ·</button>
    <div class="pill-cap" data-i18n-cap="drink_red">Red wine</div>
  </div>
  <div class="pill-wrap">
    <button class="pill big" data-cat="alcool" data-sub="vin_blanc" title="White wine" aria-label="White wine">ğŸ¥‚</button>
    <div class="pill-cap" data-i18n-cap="drink_white">White wine</div>
  </div>
  <div class="pill-wrap">
    <button class="pill big" data-cat="alcool" data-sub="biere"     title="Beer" aria-label="Beer">ğŸº</button>
    <div class="pill-cap" data-i18n-cap="drink_beer">Beer</div>
  </div>
  <div class="pill-wrap">
    <button class="pill big" data-cat="alcool" data-sub="cocktail"  title="Cocktail" aria-label="Cocktail">ğŸ¹</button>
    <div class="pill-cap" data-i18n-cap="drink_cocktail">Cocktail</div>
  </div>
  <div class="pill-wrap">
    <button class="pill big" data-cat="alcool" data-sub="digestif"  title="Digestif" aria-label="Digestif">ğŸ¥ƒ</button>
    <div class="pill-cap" data-i18n-cap="drink_digestif">Digestif</div>
  </div>
</div>
    <div id="alcoOpts" class="pill-subrows"></div>
  </div>

  <!-- Infobulle recettes cocktails -->
  <div id="drinkTip" class="pill-tip" style="display:none"></div>
</div>
<!-- === /DRINK GRID === -->

  <!-- ====== NOTES & BOUTONS (HORS de #tc_vin) ====== -->

  <!-- Notes apÃ©ritif (affichÃ©es uniquement en phase 'aperitif') -->
  <div id="aperoNotesBlock">
    <label class="pill" style="display:inline-block;margin-bottom:8px" id="mdAperoNotes">Drink / aperitif notes</label>
    <textarea id="m_aperoNotes" placeholder="ex: Eau gazeuse, vin blanc, cacahuÃ¨tes"></textarea>
  </div>

  <!-- Notes ThÃ© & CafÃ© (affichÃ©es uniquement en phase 'tc') -->
  <div id="tcNotesBlock">
    <label class="pill" style="display:inline-block;margin-bottom:8px" id="mdTCNotes">Tea & coffee notes</label>
    <textarea id="m_tcNotes" placeholder=""></textarea>
  </div>

  <!-- Bouton & horodatage APÃ‰RITIF (pilotÃ© par phase) -->
  <div id="aperoBlock" style="margin-top:12px;display:none">
    <div class="row" style="margin-top:6px">
        <button class="btn primary" id="serveAperitif">Serve aperitif</button>
      <button class="btn ghost" id="serveAperitifNone" data-i18n="serveNone">Rien</button>
      <div id="m_history_apero" style="font-size:13px;color:var(--muted);margin-top:6px"></div>
    </div>
  </div>

  <!-- Bouton & horodatage THÃ‰ & CAFÃ‰ (pilotÃ© par phase) -->
<div id="tcServeBlock" style="margin-top:12px;display:none">
  <div class="row" style="margin-top:6px">
    <button class="btn primary" id="serveTC">Serve tea & coffee</button>
    <button class="btn ghost" id="serveTCNone" data-i18n="serveNone">Rien</button>
    <span id="mhTCInline" style="font-size:12px;color:var(--muted);margin-left:8px">â€”</span>
  </div>
</div>

</div> <!-- â†â†â† FIN de #tcBlock (ne PAS enlever cette fermeture) -->
</div> <!-- fin #rightCol -->

<script>
// Fonction pour rendre un Ã©lÃ©ment cliquable sur PC et tactile
function addClickAndTouchListener(element, handler) {
    element.addEventListener("click", handler);
    element.addEventListener("touchstart", function(e) {
        e.preventDefault(); // Ã‰vite le double-clic fantÃ´me
        handler(e);
    }, { passive: false });
}

const SPML_CODES = ["AVML","BBML","CHML","GFML","HNML","KSML","LFML","LSML","MOML","NLML","VGML","VJML","VLML"];
const $ = (sel)=>document.querySelector(sel);
const store = {
  title:{ flightNo:"", date:"" },
config:{ rowsBiz:4, layout:"A220", lang:"EN", theme:"dark", histAsc:false },
  inventory:{ plateaux:0, hot_viande:0, hot_vege:0, hot_special:0, spml:{}, pre:{} },
  menu:{ viandeLabel:"", vegeLabel:"" },
  seats:{}, phase:"fiche", reminders:[], history:[], clientView:false
};

// === Demande de stockage persistant (si supportÃ©) ===
(async () => {
  try {
    if (navigator.storage && navigator.storage.persist) {
      const already = await navigator.storage.persisted();
      if (!already) { await navigator.storage.persist(); }
    }
  } catch (e) {
    console.warn("Persistent storage request failed:", e);
  }
})();

for(const code of SPML_CODES){ store.inventory.spml[code]=store.inventory.spml[code]||0; }

// ===== Mini Datepicker (lang EN/FR/DE, valeur ISO yyyy-mm-dd) =====
(function(){
  const el = document.getElementById("flightDate");
  if (!el) return;

  // Lang â†’ libellÃ©s + 1er jour de semaine (EN: dimanche / FR-DE: lundi)
  function dpLocale(){
    const lang = (store?.config?.lang || "EN").toUpperCase();
    if (lang === "FR") return {
      months: ["janv.","fÃ©vr.","mars","avr.","mai","juin","juil.","aoÃ»t","sept.","oct.","nov.","dÃ©c."],
      wk: ["L","M","M","J","V","S","D"], weekStart: 1
    };
    if (lang === "DE") return {
      months: ["Jan","Feb","MÃ¤r","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"],
      wk: ["M","D","M","D","F","S","S"], weekStart: 1
    };
    return { // EN
      months: ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],
      wk: ["S","M","T","W","T","F","S"], weekStart: 0
    };
  }

  function pad(n){ return String(n).padStart(2,"0"); }
  function toISO(y,m,d){ return `${y}-${pad(m+1)}-${pad(d)}`; } // m=0..11
  function today(){ const d=new Date(); return {y:d.getFullYear(), m:d.getMonth(), d:d.getDate()}; }
  function parseISO(str){
    const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(str||"");
    if(!m) return null;
    return { y:+m[1], m:(+m[2]-1), d:+m[3] };
  }

const isoInit = document.getElementById('flightDateISO')?.value || el.value;
let state = parseISO(isoInit) || today();

  // CrÃ©e/positionne le popup
  let popup;
  function openDP(){
    closeDP();
    popup = document.createElement("div");
    popup.className = "dp";
    document.body.appendChild(popup);
    renderDP();
    // position : sous l'input
    const r = el.getBoundingClientRect();
    popup.style.left = (window.scrollX + r.left) + "px";
    popup.style.top  = (window.scrollY + r.bottom + 6) + "px";

    // fermer si clic Ã  l'extÃ©rieur / ESC
    setTimeout(()=> {
      document.addEventListener("mousedown", onDocDown);
      document.addEventListener("keydown", onKey);
    },0);
  }
  function closeDP(){
    document.removeEventListener("mousedown", onDocDown);
    document.removeEventListener("keydown", onKey);
    if (popup && popup.parentNode) popup.parentNode.removeChild(popup);
    popup = null;
  }
  function onDocDown(e){ if (!popup) return; if (e.target===popup || popup.contains(e.target) || e.target===el) return; closeDP(); }
  function onKey(e){ if (e.key==="Escape") closeDP(); }

  function renderDP(){
    if (!popup) return;
    const L = dpLocale();
    popup.innerHTML = "";

    // header (mois)
    const h = document.createElement("header");
    const prev = document.createElement("button"); prev.textContent = "â—€";
    const next = document.createElement("button"); next.textContent = "â–¶";
    const mtxt = document.createElement("div"); mtxt.className="m";
    mtxt.textContent = `${L.months[state.m]} ${state.y}`;
    prev.addEventListener("click", ()=>{ state.m--; if(state.m<0){state.m=11; state.y--;} renderDP(); });
    next.addEventListener("click", ()=>{ state.m++; if(state.m>11){state.m=0; state.y++;} renderDP(); });
    h.appendChild(prev); h.appendChild(mtxt); h.appendChild(next);
    popup.appendChild(h);

    // grille jours
    const g = document.createElement("div"); g.className="grid";
    // entÃªtes jours
    const wk = L.wk.slice();
    if (L.weekStart===1) { const s=wk.shift(); wk.push(s); } // dÃ©caler pour Lundi
    wk.forEach(w=>{ const c=document.createElement("div"); c.className="w"; c.textContent=w; g.appendChild(c); });

    // premiers jours
    const first = new Date(state.y, state.m, 1);
    const startDay = (first.getDay() - (L.weekStart||0) + 7) % 7; // 0..6
    const daysInMonth = new Date(state.y, state.m+1, 0).getDate();
    const daysPrev = new Date(state.y, state.m, 0).getDate();

    // jours du mois prÃ©cÃ©dent (gris)
    for(let i=0;i<startDay;i++){
      const d = document.createElement("div"); d.className="d out"; d.textContent = String(daysPrev - startDay + 1 + i);
      g.appendChild(d);
    }
    // jours du mois courant
    const t = today();
const isoSel = document.getElementById('flightDateISO')?.value || el.value;
const sel = parseISO(isoSel);
    for(let d=1; d<=daysInMonth; d++){
      const cell = document.createElement("div"); cell.className="d"; cell.textContent=String(d);
      if (t.y===state.y && t.m===state.m && t.d===d) cell.classList.add("today");
      if (sel && sel.y===state.y && sel.m===state.m && sel.d===d) cell.classList.add("sel");
      cell.addEventListener("click", ()=>{
const iso = toISO(state.y, state.m, d);
document.getElementById('flightDateISO').value = iso; // stocke l'ISO
el.value = fmtDateLocalized(iso);                     // affiche localisÃ© dans l'input
updateFlightDatePretty();
el.dispatchEvent(new Event("input",{bubbles:true}));
el.dispatchEvent(new Event("change",{bubbles:true}));
closeDP();
      });
      g.appendChild(cell);
    }
    // complÃ©ter la fin de ligne avec le mois suivant
    const filled = startDay + daysInMonth;
    const trailing = (7 - (filled % 7)) % 7;
    for(let d=1; d<=trailing; d++){
      const c = document.createElement("div"); c.className="d out"; c.textContent=String(d);
      g.appendChild(c);
    }

    popup.appendChild(g);
  }

  // ouverture
  el.addEventListener("focus", openDP);
  el.addEventListener("click", openDP);

  // re-render si la langue change
  window._rerenderDatepickerLang = function(){
    // garde la date actuelle, re-render si le popup est ouvert
    if (popup) renderDP();
    // placeholder selon langue
    const lang = (store?.config?.lang || "EN").toUpperCase();
    el.placeholder = (lang==="FR") ? "AAAA-MM-JJ" : (lang==="DE" ? "JJJJ-MM-TT" : "YYYY-MM-DD");
  const iso = document.getElementById('flightDateISO')?.value;
if (iso) {
  document.getElementById('flightDate').value = fmtDateLocalized(iso);
  updateFlightDatePretty();
}
};
})();

function enforceWineExclusivity(fromInit=false){
  const vr = document.getElementById("tc_vin_rouge");
  const vb = document.getElementById("tc_vin_blanc");
  if (!vr || !vb) return;

  const r = vr.value;
  const b = vb.value;

  // Si les deux ont Ã©tÃ© sauvÃ©s par le passÃ©, on garde Rouge par dÃ©faut
  if (fromInit && r && b) {
    vb.value = "";
  }

  // RÃ¨gle dâ€™exclusivitÃ©
  vb.disabled = !!(vr.value);
  vr.disabled = !!(vb.value);
}

function clearTcUI(){
  // vider selects principaux (on ajoute les 3 sous-selects SOFT)
  [
    "tc_cat","tc_milk","tc_sweet","tc_the_type",
    "tc_digestif_type","tc_beer","tc_vin_rouge","tc_vin_blanc","tc_cocktail_type",
    "tc_soft_eau","tc_soft_jus","tc_soft_coca"  // â† ajout
  ].forEach(id => { const el=document.getElementById(id); if (el) el.value=""; });

  // dÃ©cocher glaces / citron / sel / poivre
  [
    "tc_digestif_ice","tc_champ_ice","tc_vin_ice",
    "tc_cocktail_ice","tc_cocktail_lemon","tc_cocktail_salt","tc_cocktail_pepper",
    // â†“â†“â†“ tous les checkboxes SOFT ajoutÃ©s â†“â†“â†“
    "tc_soft_ice","tc_soft_lemon",
    "tc_soft_ice2","tc_soft_lemon2","tc_soft_salt","tc_soft_pepper",
    "tc_soft_ice3","tc_soft_lemon3",
    "tc_soft_ice4","tc_soft_lemon4",
    "tc_soft_ice5","tc_soft_lemon5"
  ].forEach(id => { const el=document.getElementById(id); if (el) el.checked=false; });

  // nouveau flux 2 Ã©tages : remettre Ã  blanc les sÃ©lecteurs de niveau 1
  ["tc_group","tc_alcool_type","tc_chaud_type","tc_soft_type"].forEach(id=>{
    const el=document.getElementById(id);
    if (el) el.value="";
  });

  // masquer les blocs de niveau 1
  document.getElementById("tc_alcool") && (document.getElementById("tc_alcool").style.display="none");
  document.getElementById("tc_chaud")  && (document.getElementById("tc_chaud").style.display="none");

  // cacher tous les sous-blocs
  tc_showSub("");

  // exclusivitÃ© vin rouge/blanc propre
  enforceWineExclusivity(true);

  // Cacher lâ€™info-bulle cocktail et son bouton
const _tipBtn = document.getElementById("tc_tipBtn");
const _tipDiv = document.getElementById("tc_tip");
if (_tipBtn) _tipBtn.style.display = "none";
if (_tipDiv) _tipDiv.style.display = "none";

}
// === Nouvel Ã©tat UI unifiÃ©e (grille) ===
const drinkSel = {
  cat:"", sub:"",
  waterType:"", juiceType:"", cocaType:"",
  softIce:false, softLemon:false, spriteIce:false, spriteLemon:false, tonicIce:false, tonicLemon:false,
  juiceIce:false, juiceLemon:false, juiceSalt:false, juicePepper:false,
  beer:"", vinRouge:"", vinBlanc:"", vinNotes:"", vinIce:false,
  champIce:false,
  digestif:"", whiskyStyle:"", digIce:false,
  cocktail:"", cocktailIce:false, cocktailLemon:false, cocktailSalt:false, cocktailPepper:false,
  milk:"", sweet:"", theType:"", choco:false, theLemon:false,
juiceApfelschorle:false,
champMimosa:false,
campariMix:"",        // "orange" | "soda"
virginMary:false

};

// === NOUVEAU : dÃ©lÃ©gation unique DRINK GRID (pointer events)
(function bindDrinkGrid(){
  if (window.__DRINK_GRID_BOUND) return;
  window.__DRINK_GRID_BOUND = true;

  const isModalOpen = ()=>{
    const mb = document.getElementById('modalBack');
    return !!mb && (mb.style.display === '' || mb.style.display === 'flex');
  };

  document.addEventListener('pointerup', function(ev){
    if (!isModalOpen()) return;

    const grid = document.getElementById('drinkGrid');
    if (!grid) return;

    const t = ev.target.closest('#drinkGrid .pill');
    if (!t) return;

    // === 1) CLIC SUR UNE GROSSE PILL (catÃ©gorie)
    if (t.classList.contains('big')) {
      const active = t.classList.contains('active');

      // reset UI + state
      document.querySelectorAll('#drinkGrid .pill.big').forEach(x=>{
        x.classList.remove('active'); x.setAttribute('aria-pressed','false');
      });
      ['hotOpts','softOpts','alcoOpts'].forEach(id=>{
        const el=document.getElementById(id); if (el) el.innerHTML='';
      });
      Object.keys(drinkSel).forEach(k=>{
        drinkSel[k] = (typeof drinkSel[k]==='boolean') ? false : '';
      });

       if (typeof updateServeDrinkButtons==='function') updateServeDrinkButtons();

      if (active){
        if (typeof showAllDrinkGroups==='function') showAllDrinkGroups();
        if (typeof updateServeDrinkButtons==='function') updateServeDrinkButtons();
        return;
      }

      // nouvelle sÃ©lection
      t.classList.add('active'); t.setAttribute('aria-pressed','true');
      drinkSel.cat = t.dataset.cat || '';
      drinkSel.sub = t.dataset.sub || '';

// [FIX immÃ©diat] activer le bon bouton pour les 1er-niveau autorisÃ©s
(function(){
  const L1_OK = new Set(['cafe','deca','chocolat','sprite','tonic','champagne']);
  if (!L1_OK.has(drinkSel.sub)) return;

  let btn = null;
  if (store.phase === 'aperitif') btn = document.getElementById('serveAperitif');
  else if (store.phase === 'tc')  btn = document.getElementById('serveTC');
  else if (store.phase === 'repas') btn = document.getElementById('serveMealDrink');

  if (btn) btn.disabled = false;
})();

      if (typeof focusDrinkGroup==='function')  focusDrinkGroup(drinkSel.cat);
      if (typeof renderOptionsFor==='function') renderOptionsFor(drinkSel.cat, drinkSel.sub);
      if (typeof updateServeDrinkButtons==='function') updateServeDrinkButtons();
      return;
    }

    // === 2) OPTIONS EXCLUSIVES (data-opt="clÃ©:valeur")
    if (t.dataset.opt){
      const [key,val] = t.dataset.opt.split(':');
      const scope = t.closest('.pill-subrows') || grid;

// mÃ©moriser l'Ã©tat avant de vider le groupe
const wasActive = t.classList.contains('active');

// exclusivitÃ© dans le mÃªme groupe
scope.querySelectorAll(`.pill[data-opt^="${key}:"]`).forEach(x=>{
  x.classList.remove('active'); x.setAttribute('aria-pressed','false');
});

// toggle correct : si on reclique le mÃªme => on dÃ©sÃ©lectionne
if (wasActive) {
  t.classList.remove('active');
  t.setAttribute('aria-pressed','false');
  drinkSel[key] = '';
} else {
  t.classList.add('active');
  t.setAttribute('aria-pressed','true');
  drinkSel[key] = val || '';
}

      // rÃ¨gles d'affichage spÃ©ciales
      if (key === 'juiceType'){
        // sel+poivre visibles seulement pour ğŸ…
        document.querySelectorAll('#softOpts .jt-extra')
          .forEach(x=> x.style.display = (val==='tomate') ? '' : 'none');
      }
      if (key === 'cocktail'){
        const showC = (val==='campari');
        const showB = (val==='bloody_mary');
        const cr = document.getElementById('campariRow'), ct = document.getElementById('campariTitle');
        const br = document.getElementById('bmRow'),      bt = document.getElementById('bmTitle');
        const spBtn = document.querySelector('#alcoOpts .pill.toggle[data-flag="cocktailSP"]');
        if (cr&&ct){ cr.style.display = showC ? '' : 'none'; ct.style.display = showC ? '' : 'none'; }
        if (br&&bt){ br.style.display = showB ? '' : 'none'; bt.style.display = showB ? '' : 'none'; }
        if (spBtn) spBtn.style.display = showB ? '' : 'none';
      }

      if (typeof updateServeDrinkButtons==='function') updateServeDrinkButtons();
      return;
    }

    // === 3) TOGGLES (on/off) (data-flag)
    if (t.classList.contains('toggle') && t.dataset.flag){
      const key = t.dataset.flag;
      const next = !drinkSel[key];
      drinkSel[key] = next;
      t.classList.toggle('active', next);
      t.setAttribute('aria-pressed', String(next));

      // combos
      if (key === 'juiceSP'){      drinkSel.juiceSalt = next;    drinkSel.juicePepper = next; }
      if (key === 'cocktailSP'){   drinkSel.cocktailSalt = next; drinkSel.cocktailPepper = next; }

      if (typeof updateServeDrinkButtons==='function') updateServeDrinkButtons();
      return;
    }
  }, true); // capture pour passer avant d'Ã©ventuels stopPropagation
})();

// Remplit les lÃ©gendes sous chaque emoji depuis le title (fallback immÃ©diat)
(function initPillCaptions(){
  document.querySelectorAll('#drinkGrid .pill-wrap').forEach(wrap=>{
    const btn = wrap.querySelector('button.pill.big');
    const cap = wrap.querySelector('.pill-cap');
    if (!btn || !cap) return;
    // Si on a une clÃ© i18n plus tard, elle remplacera ce texte
    cap.textContent = cap.textContent && cap.textContent.trim()
      ? cap.textContent
      : (btn.getAttribute('aria-label') || btn.getAttribute('title') || '').trim();
  });
})();

function L(){ return I18N[store.config.lang || "EN"] || I18N.EN; }

function renderOptionsFor(cat, sub){
  const tip = document.getElementById('drinkTip');
  if (tip) tip.style.display = 'none';

  const L = (k,d)=> ((I18N[store.config.lang||'EN']||I18N.EN)[k] || d || "");
  const on = (sel, fn)=>{ document.querySelectorAll(sel).forEach(fn); };

  // --- HOT (cafÃ©, dÃ©ca, thÃ©, chocolat) ---
  if (cat==='chaud'){
    const box = document.getElementById('hotOpts'); if (!box) return;
    box.innerHTML = '';

    if (sub==='cafe' || sub==='deca'){
box.innerHTML = `
  <div class="opt-title">ğŸ¥› ${L('tcMilk','Milk/Cream')}</div>
  <div class="pill-row">
    <div class="pill-wrap">
      <button class="pill" data-opt="milk:creme"  title="${L('tcMilkCreme','Cream')}" aria-label="${L('tcMilkCreme','Cream')}">ğŸ¶</button>
      <div class="pill-cap">${L('tcMilkCreme','Cream')}</div>
    </div>
    <div class="pill-wrap">
      <button class="pill" data-opt="milk:avoine" title="${L('tcMilkAvoine','Oat milk')}" aria-label="${L('tcMilkAvoine','Oat milk')}">ğŸŒ¾</button>
      <div class="pill-cap">${L('tcMilkAvoine','Oat milk')}</div>
    </div>
    <div class="pill-wrap">
      <button class="pill" data-opt="milk:lait"   title="${L('tcMilkLait','Milk')}" aria-label="${L('tcMilkLait','Milk')}">ğŸ¥›</button>
      <div class="pill-cap">${L('tcMilkLait','Milk')}</div>
    </div>
    <div class="pill-wrap">
      <button class="pill" data-opt="milk:none"   title="${L('tcMilkNone','None')}" aria-label="${L('tcMilkNone','None')}">ğŸš«</button>
      <div class="pill-cap">${L('tcMilkNone','None')}</div>
    </div>
  </div>

  <div class="opt-title">ğŸ¬ ${L('tcSweet','Sweetener')}</div>
  <div class="pill-row">
    <div class="pill-wrap">
      <button class="pill" data-opt="sweet:sucre"       title="${L('tcSweetSugar','Sugar')}" aria-label="${L('tcSweetSugar','Sugar')}">ğŸ¬</button>
      <div class="pill-cap">${L('tcSweetSugar','Sugar')}</div>
    </div>
    <div class="pill-wrap">
      <button class="pill" data-opt="sweet:succedane"   title="${L('tcSweetSub','Substitute')}" aria-label="${L('tcSweetSub','Substitute')}">ğŸ’Š</button>
      <div class="pill-cap">${L('tcSweetSub','Substitute')}</div>
    </div>
    <div class="pill-wrap">
      <button class="pill" data-opt="sweet:none"        title="${L('tcSweetNone','None')}" aria-label="${L('tcSweetNone','None')}">ğŸš«</button>
      <div class="pill-cap">${L('tcSweetNone','None')}</div>
    </div>
  </div>`;
    }
    
    else if (sub==='the'){
box.innerHTML = `
  <div class="opt-title">ğŸ«– ${L('tcCatThe','Tea')}</div>
  <div class="pill-row">
    <div class="pill-wrap">
      <button class="pill" data-opt="theType:english"  title="${L('tcTeaEnglish','English Breakfast')}" aria-label="${L('tcTeaEnglish','English Breakfast')}">ğŸ‡¬ğŸ‡§</button>
      <div class="pill-cap">${L('tcTeaEnglish','English Breakfast')}</div>
    </div>
    <div class="pill-wrap">
      <button class="pill" data-opt="theType:vert"     title="${L('tcTeaVert','Green')}" aria-label="${L('tcTeaVert','Green')}">ğŸƒ</button>
      <div class="pill-cap">${L('tcTeaVert','Green')}</div>
    </div>
    <div class="pill-wrap">
      <button class="pill" data-opt="theType:menthe"   title="${L('tcTeaMenthe','Mint')}" aria-label="${L('tcTeaMenthe','Mint')}">ğŸŒ¿</button>
      <div class="pill-cap">${L('tcTeaMenthe','Mint')}</div>
    </div>
    <div class="pill-wrap">
      <button class="pill" data-opt="theType:hotwater" title="${L('tcHotWater','Hot water')}" aria-label="${L('tcHotWater','Hot water')}">ğŸ”¥</button>
      <div class="pill-cap">${L('tcHotWater','Hot water')}</div>
    </div>
  </div>

  <div class="opt-title">ğŸ¥› ${L('tcMilk','Milk/Cream')}</div>
  <div class="pill-row">
    <div class="pill-wrap">
      <button class="pill" data-opt="milk:creme"  title="${L('tcMilkCreme','Cream')}" aria-label="${L('tcMilkCreme','Cream')}">ğŸ¶</button>
      <div class="pill-cap">${L('tcMilkCreme','Cream')}</div>
    </div>
    <div class="pill-wrap">
      <button class="pill" data-opt="milk:avoine" title="${L('tcMilkAvoine','Oat milk')}" aria-label="${L('tcMilkAvoine','Oat milk')}">ğŸŒ¾</button>
      <div class="pill-cap">${L('tcMilkAvoine','Oat milk')}</div>
    </div>
    <div class="pill-wrap">
      <button class="pill" data-opt="milk:lait"   title="${L('tcMilkLait','Milk')}" aria-label="${L('tcMilkLait','Milk')}">ğŸ¥›</button>
      <div class="pill-cap">${L('tcMilkLait','Milk')}</div>
    </div>
    <div class="pill-wrap">
      <button class="pill" data-opt="milk:none"   title="${L('tcMilkNone','None')}" aria-label="${L('tcMilkNone','None')}">ğŸš«</button>
      <div class="pill-cap">${L('tcMilkNone','None')}</div>
    </div>
  </div>

  <div class="opt-title">ğŸ¬ ${L('tcSweet','Sugar')}</div>
  <div class="pill-row">
    <div class="pill-wrap">
      <button class="pill" data-opt="sweet:sucre"     title="${L('tcSweetSugar','Sugar')}" aria-label="${L('tcSweetSugar','Sugar')}">ğŸ¬</button>
      <div class="pill-cap">${L('tcSweetSugar','Sugar')}</div>
    </div>
    <div class="pill-wrap">
      <button class="pill" data-opt="sweet:succedane" title="${L('tcSweetSub','Substitute')}" aria-label="${L('tcSweetSub','Substitute')}">ğŸ’Š</button>
      <div class="pill-cap">${L('tcSweetSub','Substitute')}</div>
    </div>
    <div class="pill-wrap">
      <button class="pill" data-opt="sweet:none"      title="${L('tcSweetNone','None')}" aria-label="${L('tcSweetNone','None')}">ğŸš«</button>
      <div class="pill-cap">${L('tcSweetNone','None')}</div>
    </div>
  </div>

  <div class="opt-title">ğŸ‹ ${L('tcLemon','Lemon')}</div>
  <div class="pill-row">
    <div class="pill-wrap">
      <button class="pill toggle" data-flag="theLemon" title="${L('tcLemon','Lemon')}" aria-label="${L('tcLemon','Lemon')}">ğŸ‹</button>
      <div class="pill-cap">${L('tcLemon','Lemon')}</div>
    </div>
  </div>`;
    }

    else if (sub==='chocolat'){
box.innerHTML = `<div class="opt-title">ğŸ« ${L('tcCatChoco','Caotina')}</div>`;
    }

    // exclusifs + toggles
    attachExclusive('#hotOpts .pill[data-opt^="milk"]','milk');
    attachExclusive('#hotOpts .pill[data-opt^="sweet"]','sweet');
    attachExclusive('#hotOpts .pill[data-opt^="theType"]','theType');
  }

  // --- SOFT (eau/cola/jus/sprite/tonic) ---
  else if (cat==='soft'){
    const box = document.getElementById('softOpts'); if (!box) return;
    box.innerHTML = '';

    if (sub==='eau'){
      box.innerHTML = `
        <div class="opt-title">ğŸ’§ ${L('tcWater','Water')}</div>
  <div class="pill-row">
    <div class="pill-wrap">
      <button class="pill" data-opt="waterType:plate"   title="${L('tcWaterStill','Still')}"      aria-label="${L('tcWaterStill','Still')}">ğŸ’§</button>
      <div class="pill-cap">${L('tcWaterStill','Still')}</div>
    </div>
    <div class="pill-wrap">
      <button class="pill" data-opt="waterType:gazeuse" title="${L('tcWaterSpark','Sparkling')}"  aria-label="${L('tcWaterSpark','Sparkling')}">ğŸ’¦</button>
      <div class="pill-cap">${L('tcWaterSpark','Sparkling')}</div>
    </div>
  </div>
  <div class="opt-title">${L('tcExtras','Options')}</div>
  <div class="pill-row">
    <div class="pill-wrap">
      <button class="pill toggle" data-flag="softIce"   title="${L('tcIce','Ice')}"    aria-label="${L('tcIce','Ice')}">ğŸ§Š</button>
      <div class="pill-cap">${L('tcIce','Ice')}</div>
    </div>
    <div class="pill-wrap">
      <button class="pill toggle" data-flag="softLemon" title="${L('tcLemon','Lemon')}" aria-label="${L('tcLemon','Lemon')}">ğŸ‹</button>
      <div class="pill-cap">${L('tcLemon','Lemon')}</div>
    </div>
  </div>`;
    }

    else if (sub==='coca'){
box.innerHTML = `
<div class="opt-title">ğŸ¥¤ ${L('tcCola','Cola')}</div>
<div class="pill-row">
  <div class="pill-wrap">
    <button class="pill" data-opt="cocaType:normal" title="${L('tcCocaClassic','Classic')}" aria-label="${L('tcCocaClassic','Classic')}">ğŸŸ¥</button>
    <div class="pill-cap">${L('tcCocaClassic','Classic')}</div>
  </div>
  <div class="pill-wrap">
    <button class="pill" data-opt="cocaType:zero"   title="${L('tcCocaZero','Zero')}"       aria-label="${L('tcCocaZero','Zero')}">â¬›</button>
    <div class="pill-cap">${L('tcCocaZero','Zero')}</div>
  </div>
</div>
<div class="opt-title">${L('tcExtras','Options')}</div>
<div class="pill-row">
  <div class="pill-wrap">
    <button class="pill toggle" data-flag="softIce"   title="${L('tcIce','Ice')}"    aria-label="${L('tcIce','Ice')}">ğŸ§Š</button>
    <div class="pill-cap">${L('tcIce','Ice')}</div>
  </div>
  <div class="pill-wrap">
    <button class="pill toggle" data-flag="softLemon" title="${L('tcLemon','Lemon')}" aria-label="${L('tcLemon','Lemon')}">ğŸ‹</button>
    <div class="pill-cap">${L('tcLemon','Lemon')}</div>
  </div>
</div>`;
    }

    else if (sub==='sprite'){
box.innerHTML = `
  <div class="opt-title">ğŸŸ© ${L('tcSprite','Sprite')}</div>
  <div class="pill-row">
    <div class="pill-wrap">
      <button class="pill toggle" data-flag="spriteIce" title="${L('tcIce','Ice')}" aria-label="${L('tcIce','Ice')}">ğŸ§Š</button>
      <div class="pill-cap">${L('tcIce','Ice')}</div>
    </div>
    <div class="pill-wrap">
      <button class="pill toggle" data-flag="spriteLemon" title="${L('tcLemon','Lemon')}" aria-label="${L('tcLemon','Lemon')}">ğŸ‹</button>
      <div class="pill-cap">${L('tcLemon','Lemon')}</div>
    </div>
  </div>`;
    }

    else if (sub==='tonic'){
box.innerHTML = `
  <div class="opt-title">ğŸ«§ ${L('tcTonic','Tonic')}</div>
  <div class="pill-row">
    <div class="pill-wrap">
      <button class="pill toggle" data-flag="tonicIce" title="${L('tcIce','Ice')}" aria-label="${L('tcIce','Ice')}">ğŸ§Š</button>
      <div class="pill-cap">${L('tcIce','Ice')}</div>
    </div>
    <div class="pill-wrap">
      <button class="pill toggle" data-flag="tonicLemon" title="${L('tcLemon','Lemon')}" aria-label="${L('tcLemon','Lemon')}">ğŸ‹</button>
      <div class="pill-cap">${L('tcLemon','Lemon')}</div>
    </div>
  </div>`;
    }

    else if (sub==='jus'){
box.innerHTML = `
  <div class="opt-title">ğŸ§ƒ ${L('tcJuice','Juice')}</div>
  <div class="pill-row">
    <div class="pill-wrap">
      <button class="pill" data-opt="juiceType:orange" title="${L('tcJuiceOrange','Orange')}" aria-label="${L('tcJuiceOrange','Orange')}">ğŸŠ</button>
      <div class="pill-cap">${L('tcJuiceOrange','Orange')}</div>
    </div>
    <div class="pill-wrap">
      <button class="pill" data-opt="juiceType:pomme"  title="${L('tcJuiceApple','Apple')}"   aria-label="${L('tcJuiceApple','Apple')}">ğŸ</button>
      <div class="pill-cap">${L('tcJuiceApple','Apple')}</div>
    </div>
    <div class="pill-wrap">
      <button class="pill" data-opt="juiceType:tomate" title="${L('tcJuiceTomato','Tomato')}" aria-label="${L('tcJuiceTomato','Tomato')}">ğŸ…</button>
      <div class="pill-cap">${L('tcJuiceTomato','Tomato')}</div>
    </div>
  </div>

  <div class="opt-title">${L('tcExtras','Options')}</div>
  <div class="pill-row">
    <div class="pill-wrap">
      <button class="pill toggle" data-flag="juiceIce"    title="${L('tcIce','Ice')}"     aria-label="${L('tcIce','Ice')}">ğŸ§Š</button>
      <div class="pill-cap">${L('tcIce','Ice')}</div>
    </div>
    <div class="pill-wrap">
      <button class="pill toggle" data-flag="juiceLemon"  title="${L('tcLemon','Lemon')}" aria-label="${L('tcLemon','Lemon')}">ğŸ‹</button>
      <div class="pill-cap">${L('tcLemon','Lemon')}</div>
    </div>
    <div class="pill-wrap jt-extra" style="display:none">
      <button class="pill toggle" data-flag="juiceSP"
        title="${L('tcSalt','Salt')} + ${L('tcPepper','Pepper')}"
        aria-label="${L('tcSalt','Salt')} + ${L('tcPepper','Pepper')}">ğŸ§‚</button>
      <div class="pill-cap">${L('tcSalt','Salt')} + ${L('tcPepper','Pepper')}</div>
    </div>
  </div>

  <div class="opt-title" id="apfelTitle" style="display:none">${L('tcApfelschorle','Apfelschorle')}</div>
  <div class="pill-row" id="apfelRow" style="display:none">
    <div class="pill-wrap">
      <button class="pill toggle" data-flag="juiceApfelschorle" title="${L('tcApfelschorle','Apfelschorle')}" aria-label="${L('tcApfelschorle','Apfelschorle')}">ğŸ’¦</button>
      <div class="pill-cap">${L('tcApfelschorle','Apfelschorle')}</div>
    </div>
  </div>`;

      // montrer sel/poivre seulement pour ğŸ…
      on('#softOpts .pill[data-opt^="juiceType"]', b=>b.addEventListener('click', ()=>{
        const t = b.dataset.opt.split(':')[1];
        document.querySelectorAll('#softOpts .jt-extra')
          .forEach(x=> x.style.display = (t==='tomate')? '' : 'none');
        const onApple = (t==='pomme');
        const apfRow = document.getElementById('apfelRow');
        const apfTit = document.getElementById('apfelTitle');
        if (apfRow && apfTit){ apfRow.style.display = onApple?'':'none'; apfTit.style.display = onApple?'':'none'; }
      }));
    }

    attachExclusive('#softOpts .pill[data-opt^="waterType"]','waterType');
    attachExclusive('#softOpts .pill[data-opt^="cocaType"]', 'cocaType');
    attachExclusive('#softOpts .pill[data-opt^="juiceType"]','juiceType');
  }

  // --- ALCOOL (biÃ¨re, vins, champagne, digestif, cocktail) ---
  else if (cat==='alcool'){
    const box = document.getElementById('alcoOpts'); if (!box) return;
    box.innerHTML = '';

if (sub==='biere'){
box.innerHTML = `
  <div class="opt-title">${L('tcBeer','Beer')}</div>
  <div class="pill-row">
    <div class="pill-wrap">
      <button class="pill" data-opt="beer:quoellfrisch" title="${L('tcBeerQ','QuÃ¶llfrisch Lager')}" aria-label="${L('tcBeerQ','QuÃ¶llfrisch Lager')}">ğŸº</button>
      <div class="pill-cap">${L('tcBeerQ','QuÃ¶llfrisch Lager')}</div>
    </div>
    <div class="pill-wrap">
      <button class="pill" data-opt="beer:calvinus"     title="${L('tcBeerC','Calvinus Blanche')}"  aria-label="${L('tcBeerC','Calvinus Blanche')}">âšª</button>
      <div class="pill-cap">${L('tcBeerC','Calvinus Blanche')}</div>
    </div>
    <div class="pill-wrap">
      <button class="pill" data-opt="beer:leermond"     title="${L('tcBeerL','Leermond (0%)')}"     aria-label="${L('tcBeerL','Leermond (0%)')}">ğŸŒš</button>
      <div class="pill-cap">${L('tcBeerL','Leermond (0%)')}</div>
    </div>
  </div>`;

  attachExclusive('#alcoOpts .pill[data-opt^="beer"]','beer');
}

else if (sub==='vin_rouge'){
box.innerHTML = `
  <div class="opt-title">ğŸ· ${L('tcWines','Wines')} â€” ${L('tcRed','Red')}</div>
  <div class="pill-row">
    <div class="pill-wrap">
      <button class="pill" data-opt="vinRouge:suisse"   title="${L('tcCH','Swiss')}" aria-label="${L('tcCH','Swiss')}">ğŸ‡¨ğŸ‡­</button>
      <div class="pill-cap">${L('tcCH','Swiss')}</div>
    </div>
    <div class="pill-wrap">
      <button class="pill" data-opt="vinRouge:etranger" title="${L('tcForeign','Foreign')}" aria-label="${L('tcForeign','Foreign')}">ğŸŒ</button>
      <div class="pill-cap">${L('tcForeign','Foreign')}</div>
    </div>
  </div>`;
  attachExclusive('#alcoOpts .pill[data-opt^="vinRouge"]','vinRouge');
}

else if (sub==='vin_blanc'){
box.innerHTML = `
  <div class="opt-title">ğŸ¥‚ ${L('tcWines','Wines')} â€” ${L('tcWhite','White')}</div>
  <div class="pill-row">
    <div class="pill-wrap">
      <button class="pill" data-opt="vinBlanc:suisse"   title="${L('tcCH','Swiss')}"     aria-label="${L('tcCH','Swiss')}">ğŸ‡¨ğŸ‡­</button>
      <div class="pill-cap">${L('tcCH','Swiss')}</div>
    </div>
    <div class="pill-wrap">
      <button class="pill" data-opt="vinBlanc:etranger" title="${L('tcForeign','Foreign')}" aria-label="${L('tcForeign','Foreign')}">ğŸŒ</button>
      <div class="pill-cap">${L('tcForeign','Foreign')}</div>
    </div>
  </div>`;
  attachExclusive('#alcoOpts .pill[data-opt^="vinBlanc"]','vinBlanc');
}

    else if (sub==='champagne'){
box.innerHTML = `
  <div class="opt-title">ğŸ¾ ${L('tcChampagne','Champagne')}</div>
  <div class="pill-row">
    <div class="pill-wrap">
      <button class="pill toggle" data-flag="champIce"    title="${L('tcIce','Ice')}" aria-label="${L('tcIce','Ice')}">ğŸ§Š</button>
      <div class="pill-cap">${L('tcIce','Ice')}</div>
    </div>
    <div class="pill-wrap">
      <button class="pill toggle" data-flag="champMimosa" title="Mimosa" aria-label="Mimosa">ğŸŠ</button>
      <div class="pill-cap">Mimosa</div>
    </div>
  </div>`;
    }

    else if (sub==='digestif'){
box.innerHTML = `
  <div class="opt-title">${L('tcDigestif','Digestif')}</div>
  <div class="pill-row">
    <div class="pill-wrap">
      <button class="pill" data-opt="digestif:whisky_jw" title="${L('tcDigJW','Whisky â€” Johnnie Walker')}" aria-label="${L('tcDigJW','Whisky â€” Johnnie Walker')}">ğŸ¥ƒ</button>
      <div class="pill-cap">${L('tcDigJW','Johnnie Walker')}</div>
    </div>
    <div class="pill-wrap">
      <button class="pill" data-opt="digestif:whisky_jb" title="${L('tcDigJB','Whisky â€” Jim Beam (Bourbon)')}" aria-label="${L('tcDigJB','Whisky â€” Jim Beam (Bourbon)')}">ğŸ¤ </button>
      <div class="pill-cap">${L('tcDigJB','Jim Beam')}</div>
    </div>
    <div class="pill-wrap">
      <button class="pill" data-opt="digestif:cognac"    title="${L('tcDigCognac','Cognac')}" aria-label="${L('tcDigCognac','Cognac')}">ğŸ‡</button>
      <div class="pill-cap">${L('tcDigCognac','Cognac')}</div>
    </div>
    <div class="pill-wrap">
      <button class="pill" data-opt="digestif:baileys"   title="${L('tcDigBaileys','Baileys')}" aria-label="${L('tcDigBaileys','Baileys')}">ğŸ®</button>
      <div class="pill-cap">${L('tcDigBaileys','Baileys')}</div>
    </div>
  </div>

  <div class="opt-title">${L('tcExtras','Options')}</div>
  <div class="pill-row">
    <div class="pill-wrap">
      <button class="pill toggle" data-flag="digIce" title="${L('tcIce','Ice')}" aria-label="${L('tcIce','Ice')}">ğŸ§Š</button>
      <div class="pill-cap">${L('tcIce','Ice')}</div>
    </div>
  </div>`;

  attachExclusive('#alcoOpts .pill[data-opt^="digestif"]','digestif');
    }

else if (sub==='cocktail'){
box.innerHTML = `
  <div class="opt-title">ğŸ¸ ${L('tcCocktail','Cocktail')}</div>
  <div class="pill-row">
    <div class="pill-wrap">
      <button class="pill" data-opt="cocktail:campari"       title="${L('tcCampari','Campari')}" aria-label="${L('tcCampari','Campari')}">ğŸŸ¥</button>
      <div class="pill-cap">${L('tcCampari','Campari')}</div>
    </div>
    <div class="pill-wrap">
      <button class="pill" data-opt="cocktail:bloody_mary"   title="${L('tcBloody','Bloody Mary')}" aria-label="${L('tcBloody','Bloody Mary')}">ğŸ©¸</button>
      <div class="pill-cap">${L('tcBloody','Bloody Mary')}</div>
    </div>
    <div class="pill-wrap">
      <button class="pill" data-opt="cocktail:screwdriver"   title="${L('tcScrew','Screw Driver')}" aria-label="${L('tcScrew','Screw Driver')}">ğŸª›</button>
      <div class="pill-cap">${L('tcScrew','Screw Driver')}</div>
    </div>
    <div class="pill-wrap">
      <button class="pill" data-opt="cocktail:gin_tonic"     title="${L('tcGinTonic','Gin Tonic')}" aria-label="${L('tcGinTonic','Gin Tonic')}">ğŸ¸</button>
      <div class="pill-cap">${L('tcGinTonic','Gin Tonic')}</div>
    </div>
    <div class="pill-wrap">
      <button class="pill" data-opt="cocktail:cuba_libre"    title="${L('tcCuba','Cuba Libre')}"     aria-label="${L('tcCuba','Cuba Libre')}">ğŸ‡¨ğŸ‡º</button>
      <div class="pill-cap">${L('tcCuba','Cuba Libre')}</div>
    </div>
  </div>

  <div class="opt-title" id="campariTitle" style="display:none">${L('tcCampari','Campari')}</div>
  <div class="pill-row"  id="campariRow"   style="display:none">
    <div class="pill-wrap">
      <button class="pill" data-opt="campariMix:orange" title="${L('tcJuiceOrange','Orange')}" aria-label="${L('tcJuiceOrange','Orange')}">ğŸŠ</button>
      <div class="pill-cap">${L('tcJuiceOrange','Orange')}</div>
    </div>
    <div class="pill-wrap">
      <button class="pill" data-opt="campariMix:soda"   title="${L('tcSoda','Soda')}" aria-label="${L('tcSoda','Soda')}">ğŸ’¦</button>
      <div class="pill-cap">${L('tcSoda','Soda')}</div>
    </div>
  </div>

  <div class="opt-title" id="bmTitle" style="display:none">${L('tcBloody','Bloody Mary')}</div>
  <div class="pill-row"  id="bmRow"   style="display:none">
    <div class="pill-wrap">
      <button class="pill toggle" data-flag="virginMary" title="${L('tcVirgin','Virgin Mary')}" aria-label="${L('tcVirgin','Virgin Mary')}">ğŸ˜‡</button>
      <div class="pill-cap">${L('tcVirgin','Virgin Mary')}</div>
    </div>
  </div>

  <div class="opt-title">${L('tcExtras','Options')}</div>
  <div class="pill-row">
    <div class="pill-wrap">
      <button class="pill toggle" data-flag="cocktailIce"   title="${L('tcIce','Ice')}"     aria-label="${L('tcIce','Ice')}">ğŸ§Š</button>
      <div class="pill-cap">${L('tcIce','Ice')}</div>
    </div>
    <div class="pill-wrap">
      <button class="pill toggle" data-flag="cocktailLemon" title="${L('tcLemon','Lemon')}" aria-label="${L('tcLemon','Lemon')}">ğŸ‹</button>
      <div class="pill-cap">${L('tcLemon','Lemon')}</div>
    </div>
    <div class="pill-wrap" style="display:none">
      <button class="pill toggle" data-flag="cocktailSP"
        title="${L('tcSalt','Salt')} + ${L('tcPepper','Pepper')}"
        aria-label="${L('tcSalt','Salt')} + ${L('tcPepper','Pepper')}">ğŸ§‚</button>
      <div class="pill-cap">${L('tcSalt','Salt')} + ${L('tcPepper','Pepper')}</div>
    </div>
  </div>`;

}
  }
}

function getCocktailTip(code){
  const tips = (window.COCKTAIL_TIPS || {})[(store.config.lang||"EN")] || {};
  const arr = tips[code] || [];
  return `<div class="tip-list">${arr.map(l=>`<div>${l}</div>`).join("")}</div>`;
}

function showAllDrinkGroups(){
  ['grpHot','grpSoft','grpAlco'].forEach(id=>{
    const el = document.getElementById(id);
    if (el) el.style.display = '';
  });
}

function focusDrinkGroup(byCat){ // byCat: 'chaud' | 'soft' | 'alcool'
  const keep = (byCat==='chaud' ? 'grpHot' : byCat==='soft' ? 'grpSoft' : 'grpAlco');
  ['grpHot','grpSoft','grpAlco'].forEach(id=>{
    const el = document.getElementById(id);
    if (el) el.style.display = (id===keep ? '' : 'none');
  });
}

function resetDrinkUI(hard){
  // reset de l'Ã©tat logique
  if (typeof drinkSel === 'object'){
    Object.keys(drinkSel).forEach(k=>{
      drinkSel[k] = (typeof drinkSel[k] === 'boolean') ? false : "";
    });
  }
  // reset visuel
  document.querySelectorAll('#drinkGrid .pill').forEach(b=>{
    b.classList.remove('active');
    b.setAttribute('aria-pressed','false');
    b.disabled = false;
    b.style.pointerEvents = 'auto';
  });
  // vide les sous-menus
  ['hotOpts','softOpts','alcoOpts'].forEach(id=>{
    const el = document.getElementById(id); if (el) el.innerHTML = '';
  });

  // ğŸ‘‰ remise Ã  zÃ©ro sÃ»re des familles + focus: montrer Hot/Soft/Alcohol
  drinkSel.cat = "";
  drinkSel.sub = "";
  if (typeof showAllDrinkGroups === 'function') showAllDrinkGroups();  // â† affiche les 3 cartes

  if (typeof updateServeDrinkButtons === 'function') updateServeDrinkButtons();
}

// Listeners catÃ©gorie (ğŸ¥¤/ğŸ·/â˜•) â€” Ã  attacher quand la modale sâ€™ouvre
function initDrinkGrid(){
  // reset visuel
  document.querySelectorAll('#drinkGrid .pill.big').forEach(x=>{
    x.classList.remove('active'); x.setAttribute('aria-pressed','false');
  });
  ['hotOpts','softOpts','alcoOpts'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.innerHTML='';
  });
  // reset state
  Object.keys(drinkSel).forEach(k=>{
    drinkSel[k] = (typeof drinkSel[k]==='boolean') ? false : '';
  });
  // montre les 3 familles et MAJ des boutons "Serve"
  if (typeof showAllDrinkGroups==='function') showAllDrinkGroups();
  if (typeof updateServeDrinkButtons==='function') updateServeDrinkButtons();
}

function setActive(btn, scopeSel){
  document.querySelectorAll(scopeSel).forEach(x=>{ x.classList.remove('active'); x.setAttribute('aria-pressed','false'); });
  btn.classList.add('active'); btn.setAttribute('aria-pressed','true');
}

function updateServeDrinkButtons(){
  const btnAp   = document.getElementById('serveAperitif');
  const btnTC   = document.getElementById('serveTC');
  const btnMeal = document.getElementById('serveMealDrink');
  const phase   = store.phase;

  // 1er niveau OK sans dÃ©tail
  const L1_OK = new Set(['cafe','deca','chocolat','sprite','tonic','champagne']);

  let ok = false;

  if (drinkSel.cat && drinkSel.sub){
    if (L1_OK.has(drinkSel.sub)) {
      // cafÃ© / dÃ©ca / caotina / sprite / tonic / champagne
      ok = true;
    } else {
      // 2e niveau obligatoire
      const need = {
        the:        'theType',
        eau:        'waterType',
        coca:       'cocaType',
        jus:        'juiceType',
        biere:      'beer',
        vin_rouge:  'vinRouge',
        vin_blanc:  'vinBlanc',
        digestif:   'digestif',
        cocktail:   'cocktail',
      }[drinkSel.sub];

      ok = need ? !!drinkSel[need] : false;

    }
  }

  // DÃ©sactive tout, puis n'active que le bouton de la phase
  [btnAp, btnTC, btnMeal].forEach(b => { if (b) b.disabled = true; });
  if (phase === 'aperitif' && btnAp)     btnAp.disabled   = !ok;
  if (phase === 'tc'       && btnTC)     btnTC.disabled   = !ok;
  if (phase === 'repas'    && btnMeal)   btnMeal.disabled = !ok;
}

// --- Helper : rÃ©active toutes les pills du drink grid ---
function reactivateDrinkGrid() {
  const grid = document.getElementById('drinkGrid');
  if (!grid) return;
  grid.querySelectorAll('.pill').forEach(b => {
    // enlÃ¨ve toute dÃ©sactivation rÃ©siduelle
    b.disabled = false;
    b.style.pointerEvents = '';
    b.style.opacity = '';
  });
}

// --- Helper : assure que la drink grid est interactive si la modale est ouverte
function ensureDrinkGridActive(){
  const mb = document.getElementById("modalBack");
  const modalOpen = !!mb && (mb.style.display === "flex" || mb.style.display === "");
  if (!modalOpen) return;
  if (!document.getElementById("drinkGrid")) return;

  // Remet dâ€™aplomb la grille et ses listeners (idempotent)
  try {
    reactivateDrinkGrid?.();
    initDrinkGrid?.();
    renderDrinkSub?.();     // no-op dans v14+, garde compat
    renderDrinkOpts?.();    // no-op dans v14+, garde compat
    showAllDrinkGroups?.();
    updateServeDrinkButtons?.();
  } catch(e){
    console.warn("ensureDrinkGridActive:", e);
  }
}

// â€” Met Ã  jour le libellÃ© du bouton boisson selon la phase â€”
function updateServeDrinkLabel(){
  const btn = document.getElementById("serveTC");
  if (!btn) return;
  const L = I18N[store.config.lang||"EN"];
  btn.textContent = (store.phase === "repas")
    ? (L.serveMealDrink || "Serve drink")
    : (L.serveTC || "Serve tea & coffee");
}

// === [AJOUT] Pilotage des sous-menus boissons (2 Ã©tages) ===
(function initDrinkMenus(){
  const $ = (id)=>document.getElementById(id);
  const show = (id, on)=>{ const el=$(id); if(el) el.style.display = on? "" : "none"; };

function showGroup(g){
  show("tc_soft", g==="soft");
  show("tc_alcool", g==="alcool");
  show("tc_chaud", g==="chaud");
  ["tc_biere","tc_vin","tc_champagne","tc_digestif","tc_cocktail"].forEach(x=>show(x,false));
}

function showAlcoholSub(kind){
  ["tc_biere","tc_vin","tc_champagne","tc_digestif","tc_cocktail"].forEach(x=>show(x,false));

  // â†’ Toujours cacher le (i) et la bulle quand on change de sous-menu
  const btn = document.getElementById("tc_tipBtn");
  const tip = document.getElementById("tc_tip");
  if (btn) btn.style.display = "none";
  if (tip) tip.style.display = "none";

  if (kind) show("tc_"+kind, true);
}

  const g = $("tc_group");
  if (g) g.addEventListener("change", ()=>{
    showGroup(g.value);
    updateServeDrinkButtons();
  });

  const a = $("tc_alcool_type");
  if (a) a.addEventListener("change", ()=>{
  showAlcoholSub(a.value);
  updateServeDrinkButtons();
});

  // init si quelque chose Ã©tait dÃ©jÃ  sÃ©lectionnÃ©
  showGroup(g?.value||"");
  showAlcoholSub(a?.value||"");
})();


function nowStr(){ return new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"}); }
function keyFor(row,col){ return row+col; }
function ensureSeatShape(s){
  if(!s || typeof s!=="object") s={};
  if(typeof s.occupied!=="boolean") s.occupied=false;
  if(!s.type) s.type="normal";
  if(!s.status) s.status="none";
  if(s.lang===undefined) s.lang="";
  if(s.notes===undefined) s.notes="";
  if(s.sleep===undefined) s.sleep=false;
  if(s.spml===undefined) s.spml="";
  if(s.preLabel===undefined) s.preLabel="";
  if(s.normalMeal===undefined) s.normalMeal="";
  if(s.aperoNotes===undefined) s.aperoNotes="";
  if(s.tcNotes===undefined) s.tcNotes="";
  if(!s.alloc || typeof s.alloc!=="object") s.alloc={ normalKey:null, spmlCode:null, preLabel:null };
  if (!s.served) s.served = { aperitif:null, meal:null };
  if (typeof s.served.trayUsed !== "boolean") s.served.trayUsed = false;
  if(s.serveLaterAt===undefined) s.serveLaterAt=null;
  if (typeof s.served.tc === "undefined") s.served.tc = null;        // horodatage thÃ©/cafÃ©
  if (typeof s.served.trayCleared === "undefined") s.served.trayCleared = false; // plateau dÃ©barrassÃ©
  if (!s.apDrink) s.apDrink = {
    cat: "",        // cafe|deca|the|infusion|digestif|biere|champagne|vin
    milk: "",       // creme|avoine|lait|none|""
    sweet: "",      // sucre|succedane|none|""
    theType: "",    // english|vert|menthe
    digestif: "",   // whisky_jw|whisky_jb|cognac|baileys
    whiskyStyle: "",// pur|rocks|""
    baileysIce: false,
    beer: "",       // quoellfrisch|calvinus_blanche|leermond_0
    vinRouge: "",   // ""|suisse|etranger
    vinBlanc: "",   // ""|suisse
    vinNotes: "",
    cognacIce:false,
    champIce:false,
    vinIce:false,
    // Soft
    softType: "",        // eau|jus|coca|sprite|tonic
    waterType: "",       // plate|gazeuse
    juiceType: "",       // pomme|orange|tomate
    cocaType: "",        // normal|zero
    softIce: false, softLemon: false,
    juiceIce: false, juiceLemon: false, juiceSalt: false, juicePepper: false,
    spriteIce: false, spriteLemon: false,
// Cocktails
cocktail: "",          // campari|bloody_mary|gin_tonic|cuba_libre
cocktailIce: false,
cocktailLemon: false,
cocktailSalt:false, cocktailPepper:false,
campariMix:"",        // "orange" | "soda"
virginMary:false  ,    // â† AJOUT
    // Chocolat chaud
    choco: false,

  };
if (s.eatWith === undefined) s.eatWith = ""; // clÃ© siÃ¨ge partenaire (ex: "4C") ou ""
  return s;
}
function seatObj(row,col){ const k=keyFor(row,col); const shaped=ensureSeatShape(store.seats[k]); store.seats[k]=shaped; return shaped; }
function save(){
  try{
    localStorage.setItem(storageKey(), JSON.stringify(store));
    localStorage.setItem("serviceflow::lastKey", storageKey());
  }catch(e){
    // Certains viewers iOS brident localStorage (quota / file://)
    // On ne fait pas planter l'app ; on continue en mÃ©moire.
    console.warn("localStorage indisponible:", e);
  }
  refreshBadges();
}

// === Autosave Ã  la volÃ©e (quand lâ€™onglet se masque/quitte) ===
document.addEventListener("visibilitychange", () => {
  if (document.visibilityState === "hidden") { try { save(); } catch(e){} }
});

// iOS/Edge dÃ©clenchent 'pagehide' lors de mises en veille / back-forward cache
window.addEventListener("pagehide", () => { try { save(); } catch(e){} }, { capture: true });

// Optionnel : prÃ©venir lâ€™utilisateur sâ€™il quitte avec des donnÃ©es non exportÃ©es
window.addEventListener("beforeunload", (e) => {
  // tu peux commenter cette section si tu ne veux pas dâ€™alerte
  if ((store.history||[]).length > 0) {
    e.preventDefault();
    e.returnValue = "";
  }
});

function loadKeyData(k){ const d=localStorage.getItem(k); return d? JSON.parse(d): null; }
function storageKey(){
  const t = store.title || { flightNo:"", date:"" };
  return `serviceflow::${t.flightNo || "no-flight"}::${t.date || "no-date"}`;
}
function switchStorageIfTitleChanged(oldKey){ if(oldKey && oldKey!==storageKey()){ localStorage.setItem(storageKey(), JSON.stringify(store)); } }

function onSaveTitleSnapshot(){
  const oldKey = storageKey();

  // 1) lire les champs
  store.title.flightNo = $("#flightNo").value.trim();
  const iso = document.getElementById('flightDateISO')?.value || $("#flightDate").value;
  store.title.date = iso;

  // 2) basculer de clÃ© si vol/date changent, puis sauvegarder
  switchStorageIfTitleChanged(oldKey);
  save();

  // 3) historiser en Ã©vÃ©nement â†’ libellÃ© traduit Ã  lâ€™affichage
  addHistoryEvt({
    type: "titleSet",
    flightNo: store.title.flightNo || "",
    dateISO: store.title.date || ""
  });
}

// === Boutons header : attache sÃ»re (Ã©vite null.addEventListener) ===
(function attachHeaderButtons(){
  // Sauvegarde interne (ğŸ’¾)
  document.getElementById("saveSnapshot")?.addEventListener("click", onSaveTitleSnapshot);

  // Import JSON (ğŸ“¥)
document.getElementById("importJSON")?.addEventListener("click", () => {
  const f = document.getElementById("importFile");
  if (!f) return;
  f.value = "";              // important sur iOS si on rÃ©importe le mÃªme fichier
  f.click();
});

document.getElementById("importFile")?.addEventListener("change", (e) => {
  // ğŸ”’ AJOUTER CES 4 LIGNES TOUT DE SUITE APRÃˆS Lâ€™OUVERTURE DU HANDLER
  if (window.__importingJSON) return;
  window.__importingJSON = true;
  const releaseImportLock = () => setTimeout(() => { window.__importingJSON = false; }, 0);

  const file = e.target.files?.[0];
  if (!file) { releaseImportLock(); return; }
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const data = JSON.parse(String(reader.result || "{}"));
      const oldKey = storageKey();

      // remplace l'Ã©tat courant
      for (const k of Object.keys(store)) delete store[k];
      Object.assign(store, data);

      // ğŸ§© AJOUT : normaliser lâ€™objet importÃ© (valeurs par dÃ©faut)
      if (typeof normalizeImportedStore === "function") normalizeImportedStore(store);

      // MAJ UI vol/date (dÃ©jÃ  prÃ©sent)
      document.getElementById("flightNo").value = store?.title?.flightNo || "";
      const iso = store?.title?.date || "";
      document.getElementById("flightDateISO").value = iso;
      document.getElementById("flightDate").value   = iso;

      // ğŸ§© AJOUT : remettre Ã  jour les libellÃ©s viande/vÃ©gÃ© visibles
      const lv = document.getElementById("labelViande");
      const lg = document.getElementById("labelVege");
      if (lv) lv.value = store?.menu?.viandeLabel || "";
      if (lg) lg.value = store?.menu?.vegeLabel   || "";

      // persistance + re-render
      switchStorageIfTitleChanged(oldKey);
      save();
      applyI18n?.();
      renderSeatmap?.();
      renderServiceFlow?.();
      renderHistory?.();

      // ğŸ”¤ AJOUT : alerte traduisible
      const langKey = (store?.config?.lang || "EN").toUpperCase();
      const L = I18N[store.config.lang || "EN"] || I18N.EN;
      alert(L.jsonRestored || "Session restaurÃ©e depuis le JSON.");
    } catch (err) {
      console.error(err);
      const langKey = (store?.config?.lang || "EN").toUpperCase();
const L = I18N[langKey] || I18N.EN;
alert(L.invalidFile || "Invalid file.");

    } finally {
      // (dÃ©jÃ  prÃ©sent) permet de rÃ©importer le mÃªme fichier
      e.target.value = "";
      releaseImportLock();  // ğŸ”“ LIBÃˆRE LE VERROU ICI
    }
  };
  reader.readAsText(file);
});

  // Seatmap PNG (ğŸ—ºï¸) â€” on garde ton handler existant si tu en as un
  document.getElementById("exportPNG")?.addEventListener("click", () => {
    try { if (typeof exportSeatmapPNG === "function") exportSeatmapPNG();
          else console.warn("exportSeatmapPNG() non dÃ©finie"); } catch(e){}
  });
})();

function addHistory(text){
  // compatibilitÃ© avec l'ancien format string
  store.history.unshift({ ts: Date.now(), type: "text", text });
  renderHistory();
}

function addHistoryEvt(evt){
  // evt = { ts?:number, type:string, seat?:string, label?:string, notes?:string }
  const e = Object.assign({ ts: Date.now() }, evt);
  store.history.unshift(e);
  renderHistory();
}

function playBeep(){ try{ const ctx=new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(); const g=ctx.createGain(); o.type="sine"; o.frequency.value=880; o.connect(g); g.connect(ctx.destination); o.start(); g.gain.setValueAtTime(0.08, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime+0.15); o.stop(ctx.currentTime+0.16);}catch(e){} }

function sumSPML(){ return Object.values(store.inventory.spml||{}).reduce((a,b)=>a+(b||0),0); }
function sumPRE(){ return Object.values(store.inventory.pre||{}).reduce((a,b)=>a+(b||0),0); }

function rightCols(){
  // A220 : 2 siÃ¨ges cÃ´tÃ© droit ; A320 : 3 siÃ¨ges cÃ´tÃ© droit (C B A)
  return (store.config.layout==="A320") ? ["C","B","A"] : ["C","A"];
}
function updateSeatmapTitle(){
  const el = document.getElementById("seatmapTitle");
  if (!el) return;
  const L = I18N[store.config.lang || "EN"] || I18N.EN;

  const left = "F E D";
  const right = (store.config.layout === "A320") ? "C B A" : "C A";

  // gabarit localisÃ©, ex: "Plan cabine ({L} | {R})"
  const tpl = L.seatmapTitle || "Seatmap ({L} | {R})";
  el.textContent = tpl.replace("{L}", left).replace("{R}", right);
}

function fmtDateLocalized(iso){
  const lang = (store?.config?.lang || "EN").toUpperCase();
  if(!iso) return "";
  const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(iso);
  if(!m) return iso;
  const y = m[1], mo = m[2], d = m[3];

  if (lang === "FR") return `${d}/${mo}/${y}`;      // 21/08/2025
  if (lang === "DE") return `${d}.${mo}.${y}`;     // 21.08.2025

  // EN (lisible)
  const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  return `${months[parseInt(mo,10)-1]} ${parseInt(d,10)}, ${y}`; // Aug 21, 2025
}

function updateFlightDatePretty(){
  const span = document.getElementById("flightDatePretty");
  const input = document.getElementById("flightDate");
  if (span && input) span.textContent = fmtDateLocalized(input.value);
}

// --- I18N ---

const I18N = {

EN: {
  // =========================
  // HEADER (top bar)
  // =========================
  flight: "Flight",
  date: "Date",
  saveTitle: "Save",
  reset: "Reset",
  client: "Client mode",
  crew: "Crew mode",
  lblLang: "Language",
  exportJSON: "Export JSON",
  importJSON: "Import",
  exportPNG: "Export PNG",
  rights: "All rights reserved",

  // =========================
  // CHIPS & FILTERS (action row)
  // =========================
  chips_apero: "ğŸ· Aperitif",
  chips_meal: "ğŸ± Main",
  chips_tc: "â˜• Tea & Coffee",
  chips_fiche: "ğŸ§¾ Pax record",

  filter_all: "All seats",
  filter_toserve: "To serve",
  filter_clear: "To clear",
  filter_sleep: "Sleeping",
  filter_later: "Serve later",

  lgServed: "âœ… Served",
  lgclear: "ğŸ§¹ Cleared",

  // =========================
  // FLOW / SEATMAP / LABELS
  // =========================
  flowTitle: "Order flow",
  flowNowTitle: "Service path â¬‡ï¸",
  flowLaterTitle: "Orders to take â¬‡ï¸",
  flowClearTitle: "To clear â¬‡ï¸",
  flowAperoTakenTitle: "Orders taken â¬‡ï¸",
flowTaken: "Taken",
flowEmptyTaken: "No orders taken yet",
flowTCTakenTitle: "Tea & coffee taken â¬‡ï¸",

  flowTakeOrder: "Order",
  flowServeTag: "Serve",
  flowClearTag: "To clear",

  flowEmptyLater: "No orders left",
  flowEmptyClear: "Nothing to clear",

  seatmapTitle: "Seatmap ({L} | {R})",
  seat: "Seat",
  trayShort: "Tray",

  apLabel: "Aperitif",
  mealLabel: "Main",

  // =========================
  // ASIDE (config & inventory)
  // =========================
  hdrConfig: "Curtain & configuration",
  lblLayout: "Cabin layout",
  lblRows: "Rows",

  secMenuTitle: "Menu",
  lblViande: "Option 1",
  lblVege: "Option 2",

  hdrInventaire: "Inventory",
  invPlateaux: "Trays",
  invViande: "Option 1",
  invVege: "Option 2",
  invSpecial: "SPML",

  spml: "SPML",
  add: "Add",
  preHeader: "Pre-order",
  preAdd: "Pre-order",

  // =========================
  // MODAL (seat details)
  // =========================
  close: "âœ–ï¸",
  mdPass: "Passenger",
  mdOcc: "Seat occupied",
  mdSleepTxt: "ğŸ˜´ Sleeping",

  // Pax type
  mdType: "Pax type",
  mdAdult: "ğŸ™‚ Adult",
  mdChild: "ğŸ§’ Child",
  mdInfant: "ğŸ‘¶ Infant",
  mdStatus: "Status",
  mdLang: "Language",
  mdEatWith: "Eat together with",
mdEatWithPh: "e.g. 12B",

  // Service actions
  mdLater: "Serve later",
  mdLaterCustom: "Timeâ€¦",
  mdLaterSet:"ğŸ•°ï¸ Set time",
  mdLaterCancel:"Cancel",

  // Notes
  mdNotes: "Notes",
  mdAperoNotes: "Drink / aperitif notes",
  mdTCNotes: "Tea & coffee notes",

  // Meal
  serveAperitif: "Serve aperitif",
  mdMeal: "Meal",
  mdNormal: "Normal choice",
  optNormalMeat: "Option 1",
  optNormalVeg: "Option 2",
  optNormalTray: "Tray (no casserole)",
  mealDrinkTitle: "Meal drinks",
  mealDrinkNotes: "Meal drink notes",

  optStatusOther: "Other",           // (1)

  mdSpml: "SPML",
  mdPre: "Pre-order",
  serveMeal: "Serve main",
  cancelService: "Cancel service",

  clearTray: "Tray cleared",
  undoClearTray: "Undo tray clearing",
  ordered: "ordered",
  eatTogether: "ğŸ½ï¸ Eat together with",
eatTogetherPH: "e.g. 4C",
clear: "Clear",

moveSeat: "ğŸ” Move pax",
moved: "Moved",
swapped: "Swapped",
pickDestSeat: "Pick destination seat",
moved: "Moved",
swapped: "Swapped",

  // Tea & Coffee
  tcCH: "Swiss",
  tcForeign: "Foreign",
  serveTC: "Serve Tea & Coffee",
  serveMealDrink: "Order drink",
  histTcServed: "Tea & Coffee served at",
  histMealDrinkServed:"Meal drink ordered by",
  serveNone: "Nothing",

  // =========================
  // LEGEND
  // =========================
  lgSleep: "ğŸ˜´ Sleeping",
  lgLater: "â³ Serve later",
  lgChoice: "ğŸ½ï¸ Choice saved",
  lgInfant: "ğŸ‘¶ Infant",
  lgChild: "ğŸ§’ Child",
  lgTogether: "ğŸ¤ Eat together",

  // =========================
  // ALERTS / MESSAGES
  // =========================
  alertSeatEmpty: "Seat not occupied.",
  alertChoose: "Choose a meal first (normal, SPML or pre-order).",
  alertNoTrays: "No trays available.",
  alertStock: "Insufficient stock for",
  alertDepleted: "depleted.",
  alertPickTime: "Pick a time.",

  resetConfirm: "Confirm",
  preAddLabelRequired: "Enter a pre-order name",
  spmlCodeRequired: "Select a SPML code",

  // =========================
  // HISTORY / REMINDERS
  // =========================
  secHistoryTitle: "History (newest on top)",
  histTitleSet: "Title set:",
  histApServed: "Aperitif served at",
  histApCanceled: "Aperitif canceled for",
  histMealServed: "Main served at",
  histCanceled: "Service canceled for",
  resetDone: "Flight reset.",

  remindersTitle: "Upcoming reminders",
  remindServe: "ğŸ›ï¸ Reminder: serve",

  histViewLabel: "View",
  histScope_all: "All events",
  histScope_seat: "By seat",
  histScope_type: "By type",
  histLblSeat: "Seat",
  histLblType: "Type",
  histAscLbl: "Oldest first",
  histType_mealDrinkServed: "Meal drink served",

  histType_apServed: "Aperitif served",
  histType_tcServed: "Tea & Coffee served",
  histType_mealServed: "Main served",
  histType_apCanceled: "Aperitif canceled",
  histType_serviceCanceled: "Service canceled",
  histType_trayCleared: "Tray cleared",
  histType_trayUncleared: "Undo tray clearing",
  histType_reset: "Flight reset",
  histType_seatMoveStart: "Move pax",   
histType_seatMoved:     "Seat moved",         
histType_seatSwapped:   "Seats swapped",      
  histType_text: "Notes",
  histNewest: "(newest on top)",
histOldest: "(oldest on top)",
histNewestBtn: "Switch to oldest on top",  // affichÃ© quand l'Ã©tat courant est 'newest on top'
histOldestBtn: "Switch to newest on top",  // affichÃ© quand l'Ã©tat courant est 'oldest on top'

  // =========================
  // MISC (duplicates kept)
  // =========================
  optStatusOther: "Other",    // (2) duplicate kept

  // =========================
  // TC PANEL (drinks / service)
  // =========================
  tcTitle: "Aperitif",
  tcDrink: "Drink",
  tcService: "Service",
  tcNotes: "Notes",
  tcGroupSoft: "Softs",
  tcGroupAlcohol: "Alcohol",
  tcGroupHot: "Hot",
  tcLblAlcohol: "Alcohol",
  tcLblHot: "Hot",

  // Soft
  tcCatSoft: "Soft",
  tcLblSoft: "Soft",
  tcLblWater: "Water",
  tcLblJuice: "Juice",
  tcLblCoca: "Coca-Cola",
  tcSoftWater: "Water",
  tcSoftJuice: "Juice",
  tcSoftCoca: "Coca-Cola",
  tcSoftSprite: "Sprite",
  tcSoftTonic: "Tonic",

  tcWaterStill: "Still",
  tcWaterSpark: "Sparkling",
  tcJuiceApple: "Apple",
  tcJuiceOrange: "Orange",
  tcJuiceTomato: "Tomato",
  tcCocaClassic: "Classic",
  tcCocaZero: "Zero",

  tcLemon: "Lemon",
  tcSalt: "Salt",
  tcPepper: "Pepper",
  tcExtras: "Options",

  // Coffee / Tea / Infusions / Chocolate
  tcCatCafe: "Coffee",
  tcCatDeca: "Decaf",
  tcCatThe: "Tea",
  tcCatInf: "Infusion",
  tcCatChoco: "Caotina",

  tcLblChoco: "Caotina",
  tcChocoBrand: "Caotina",

  tcMilk: "Milk/Cream",
  tcMilkCreme: "Cream",
  tcMilkAvoine: "Oat milk",
  tcMilkLait: "Milk",
  tcMilkNone: "None",

  tcSweet: "Sweetener",
  tcSweetSugar: "Sugar",
  tcSweetSub: "Substitute",
  tcSweetNone: "None",

  tcTeaType: "Tea type",
  tcTeaEnglish: "English breakfast",

  tcInfusion: "Infusion",
  tcInfCam: "Chamomile",

  tcPur: "Neat",
  tcRocks: "On the rocks",
  tcBaileys: "Baileys",
  tcIce: "Ice",

  tcCatDig: "Digestif",
  tcDigestif: "Digestif",

  tcDigJW: "Johnnie Walker",
  tcDigJB: "Jim Beam (Bourbon)",
  tcDigCognac: "Cognac",
  tcDigBaileys: "Baileys",

  // Alcohol (Beer, Wine, Champagne)
  tcCatBeer: "Beer",
  tcBeer: "Beer",
  tcBeerQ: "QuÃ¶llfrisch Lager Blonde",
  tcBeerC: "Calvinus White",
  tcBeerL: "Leermond (alcohol-free)",

  tcCatChamp: "Champagne",
  tcChampagne: "Champagne",
  tcChampPH: "Notes (e.g., brand, rosÃ©â€¦)",

  tcCatVin: "Wines",
  tcWines: "Wines",
  tcRed: "Red",
  tcWhite: "White",
  tcVinPH: "Notes (e.g., grape, commentâ€¦)",

  tcCatHot: "Hot drinks",
tcMilkTitle: "Milk / Cream",
tcSugarTitle: "Sugar",
tcTeaTitle: "Tea",
tcAlcoholTitle: "Alcoholic drinks",
tcSoftTitle: "Soft drinks",

tcTeaEnglish: "English Breakfast",
tcTeaVert: "Green tea",
tcTeaMenthe: "Mint tea",
tcHotWater: "Hot water",

tcWater: "Water",
tcCola: "Cola",
tcJuice: "Juice",
tcSprite: "Sprite",
tcTonic: "Tonic",

tcStill: "Still",
tcSpark: "Sparkling",
tcClassic: "Classic",
tcZero: "Zero",

tcOrange: "Orange",
tcApple: "Apple",
tcTomato: "Tomato",

tcCaotina: "Caotina",   // titre/Ã©tiquette si besoin en plus de tcChocoBrand

jsonRestored: "Session restored from JSON",
invalidFile: "Invalid file.",

},

FR: {
  // =========================
  // HEADER (barre du haut)
  // =========================
  flight: "Vol",
  date: "Date",
  saveTitle: "Enregistrer",
  reset: "RÃ©initialiser",
  client: "Mode client",
  crew: "Mode Ã©quipage",
  lblLang: "Langue",
  exportJSON: "Export JSON",
  importJSON: "Importer",
  exportPNG: "Exporter PNG",
  rights: "Tous droits rÃ©servÃ©s",

  tcGroupSoft: "Softs",
  tcGroupAlcohol: "Alcool",
  tcGroupHot: "Chaud",
  tcLblAlcohol: "Alcool",
  tcLblHot: "Chaud",

  // =========================
  // CHIPS & FILTRES (rangÃ©e actions)
  // =========================
  chips_apero: "ğŸ· ApÃ©ritif",
  chips_meal: "ğŸ± Plat",
  chips_tc: "â˜• ThÃ© & CafÃ©",
  chips_fiche: "ğŸ§¾ Fiche pax",
  
  filter_all: "Tous les siÃ¨ges",
  filter_toserve: "Ã€ servir",
  filter_clear: "Ã€ dÃ©barrasser",
  filter_sleep: "En train de dormir",
  filter_later: "Servir plus tard",

  lgServed: "âœ… Servi",
  lgclear: "ğŸ§¹ DÃ©barrassÃ©",

  // =========================
  // FLOW / SEATMAP / LABELS
  // =========================
  flowTitle: "Ordre de service",
  flowNowTitle: "Chemin de service â¬‡ï¸",
  flowLaterTitle: "Commandes Ã  prendre â¬‡ï¸",
  flowClearTitle: "Ã€ dÃ©barrasser â¬‡ï¸",
  flowAperoTakenTitle: "Commandes prises â¬‡ï¸",
flowTaken: "Pris",
flowEmptyTaken: "Aucune commande prise",
flowTCTakenTitle: "ThÃ© & cafÃ© pris â¬‡ï¸",

  flowTakeOrder: "Commande",
  flowServeTag: "Servir",
  flowClearTag: "Ã€ dÃ©barrasser",

  flowEmptyLater: "Aucune commande",
  flowEmptyClear: "Rien Ã  dÃ©barrasser",

  seatmapTitle: "Plan cabine ({L} | {R})",
  seat: "SiÃ¨ge",
  trayShort: "Plateau",

  apLabel: "ApÃ©ritif",
  mealLabel: "Plat",

  // =========================
  // ASIDE (config & inventaire)
  // =========================
  hdrConfig: "Rideau & configuration",
  lblLayout: "Configuration cabine",
  lblRows: "RangÃ©es",

  secMenuTitle: "Menu",
  lblViande: "Option 1",
  lblVege: "Option 2",

  hdrInventaire: "Inventaire",
  invPlateaux: "Plateaux",
  invViande: "Option 1",
  invVege: "Option 2",
  invSpecial: "SPML",

  spml: "SPML",
  add: "Ajouter",
  preHeader: "PrÃ©commande",
  preAdd: "PrÃ©commande",

  // =========================
  // MODALE (fiche siÃ¨ge)
  // =========================
  close: "âœ–ï¸",
  mdPass: "Passager",
  mdOcc: "SiÃ¨ge occupÃ©",
  mdSleepTxt: "ğŸ˜´ Dort",

  // Statut passager
  mdType: "Type de pax",
  mdAdult: "ğŸ™‚ Adulte",
  mdChild: "ğŸ§’ Enfant",
  mdInfant: "ğŸ‘¶ BÃ©bÃ©",
  mdStatus: "Statut",
  mdLang: "Langue",
mdEatWith: "Manger avec",
mdEatWithPh: "ex : 12B",

  // Actions service
  mdLater: "Servir plus tard",
  mdLaterCustom: "Heureâ€¦",
  mdLaterSet:"ğŸ•°ï¸ Fixer lâ€™heure",
  mdLaterCancel:"Annuler",

  // Notes
  mdNotes: "Notes",
  mdAperoNotes: "Boisson / notes apÃ©ritif",
  mdTCNotes: "Notes thÃ© & cafÃ©",

  // Repas
  serveAperitif: "ApÃ©ritif servi",
  mdMeal: "Repas",
  mdNormal: "Choix normal",
  optNormalMeat: "Option 1",
  optNormalVeg: "Option 2",
  optNormalTray: "Plateau (sans cocotte)",
  mealDrinkTitle: "Boissons repas",
  mealDrinkNotes: "Notes boissons repas",

  optStatusOther: "Autre",          // (1)

  mdSpml: "SPML",
  mdPre: "PrÃ©commande",
  serveMeal: "Plat servi",
  cancelService: "Annuler service",

  clearTray: "Plateau dÃ©barrassÃ©",
  undoClearTray: "Annuler dÃ©barrassage",
  ordered: "commandÃ©",
moveSeat: "ğŸ” DÃ©placer pax",
moved: "DÃ©placÃ©",
swapped: "Ã‰changÃ©",
  eatTogether: "ğŸ½ï¸ Manger avec",
eatTogetherPH: "ex : 4C",
clear: "Effacer",
pickDestSeat: "Choisis le siÃ¨ge de destination",
moved: "DÃ©placÃ©",
swapped: "Ã‰changÃ©",

  // ThÃ© & cafÃ©
  tcCH: "Suisse",
  tcForeign: "Ã‰tranger",
  serveTC: "ThÃ© & CafÃ© servi",
  serveMealDrink:"Commander boisson",
  histTcServed: "ThÃ© & CafÃ© servi Ã ",
  histMealDrinkServed:"Boisson repas commandÃ©e par",
  serveNone: "Rien",

  // =========================
  // LÃ‰GENDE
  // =========================
  lgSleep: "ğŸ˜´ Dort",
  lgLater: "â³ Plus tard",
  lgChoice: "ğŸ½ï¸ Choix enregistrÃ©",
  lgInfant: "ğŸ‘¶ BÃ©bÃ©",
  lgChild: "ğŸ§’ Enfant",
  lgTogether: "ğŸ¤ Manger ensemble",

  // =========================
  // ALERTES / MESSAGES
  // =========================
  alertSeatEmpty: "SiÃ¨ge non occupÃ©.",
  alertChoose: "Choisissez d'abord un plat (normal, SPML ou prÃ©commande).",
  alertNoTrays: "Plus de plateaux disponibles.",
  alertStock: "Stock insuffisant pour",
  alertDepleted: "Ã©puisÃ©.",
  alertPickTime: "Choisir une heure.",

  resetConfirm: "Confirmer",
  preAddLabelRequired: "Entrez un nom de prÃ©commande",
  spmlCodeRequired: "SÃ©lectionnez un code SPML",

  // =========================
  // HISTORIQUE / RAPPELS
  // =========================
  secHistoryTitle: "Historique (dernier en haut)",
  histTitleSet: "Titre dÃ©fini:",
  histApServed: "ApÃ©ritif servi Ã ",
  histApCanceled: "ApÃ©ritif annulÃ© pour",
  histMealServed: "Plat servi Ã ",
  histCanceled: "Service annulÃ© pour",
  resetDone: "Vol rÃ©initialisÃ©.",

  remindersTitle: "Rappels Ã  venir",
  remindServe: "ğŸ›ï¸ Rappel: servir",

  histViewLabel: "Affichage",
  histScope_all: "Tous les Ã©vÃ©nements",
  histScope_seat: "Par siÃ¨ge",
  histScope_type: "Par type",
  histLblSeat: "SiÃ¨ge",
  histLblType: "Type",
  histAscLbl: "Du plus ancien au plus rÃ©cent",
  histType_mealDrinkServed: "Boisson repas servie",

  histType_apServed: "ApÃ©ritif servi",
  histType_tcServed: "ThÃ© & CafÃ© servi",
  histType_mealServed: "Plat servi",
  histType_apCanceled: "ApÃ©ritif annulÃ©",
  histType_serviceCanceled: "Service annulÃ©",
  histType_trayCleared: "Plateau dÃ©barrassÃ©",
  histType_trayUncleared: "Annuler dÃ©barrassage",
  histType_reset: "RÃ©initialisation vol",
  histType_seatMoveStart: "DÃ©placement pax",
histType_seatMoved: "SiÃ¨ge dÃ©placÃ©",
histType_seatSwapped: "SiÃ¨ges Ã©changÃ©s",
  histType_text: "Notes",
histNewest: "(rÃ©cent en haut)",
histOldest: "(ancien en haut)",
histNewestBtn: "Basculer vers ancien en haut",   // quand l'Ã©tat courant est 'rÃ©cent en haut'
histOldestBtn: "Basculer vers rÃ©cent en haut",   // quand l'Ã©tat courant est 'ancien en haut'


  // =========================
  // DIVERS (doublons conservÃ©s)
  // =========================
  optStatusOther: "Autre",   // (2) doublon conservÃ©

  // =========================
  // TC PANEL (boissons / service)
  // =========================
  tcTitle: "ApÃ©ritif",
  tcDrink: "Boisson",
  tcService: "Service",
  tcNotes: "Notes",

  // Soft
  tcCatSoft: "Soft",
  tcLblSoft: "Soft",
  tcLblWater: "Eau",
  tcLblJuice: "Jus",
  tcLblCoca: "Coca-Cola",
  tcSoftWater: "Eau",
  tcSoftJuice: "Jus",
  tcSoftCoca: "Coca-Cola",
  tcSoftSprite: "Sprite",
  tcSoftTonic: "Tonic",

  tcWaterStill: "Plate",
  tcWaterSpark: "Gazeuse",
  tcJuiceApple: "Pomme",
  tcJuiceOrange: "Orange",
  tcJuiceTomato: "Tomate",
  tcCocaClassic: "Normal",
  tcCocaZero: "Zero",

  tcLemon: "Citron",
  tcSalt: "Sel",
  tcPepper: "Poivre",
  tcExtras: "Options",

  // CafÃ© / ThÃ© / Infusion / Chocolat
  tcCatCafe: "CafÃ©",
  tcCatDeca: "DÃ©cafÃ©inÃ©",
  tcCatThe: "ThÃ©",
  tcCatInf: "Infusion",
  tcCatChoco: "Caotina",

  tcLblChoco: "Caotina",
  tcChocoBrand: "Caotina",

  tcTeaType: "Type de thÃ©",
  tcTeaEnglish: "English Breakfast",
  tcTeaVert: "Vert",
  tcTeaMenthe: "Menthe",
  tcHotWater: "Eau chaude",

  tcInfusion: "Infusion",
  tcInfCam: "Camomille",

  tcMilk: "Lait/CrÃ¨me",
  tcMilkCreme: "CrÃ¨me",
  tcMilkAvoine: "Lait d'avoine",
  tcMilkLait: "Lait",
  tcMilkNone: "Sans",

  tcSweet: "Sucre",
  tcSweetSugar: "Sucre",
  tcSweetSub: "SuccÃ©danÃ©",
  tcSweetNone: "Sans",

  tcPur: "Pur",
  tcRocks: "On the rocks",
  tcBaileys: "Baileys",
  tcIce: "GlaÃ§ons",

  tcCatDig: "Digestif",
  tcDigestif: "Digestif",

  tcDigJW: "Johnnie Walker",
  tcDigJB: "Jim Beam (Bourbon)",
  tcDigCognac: "Cognac",
  tcDigBaileys: "Baileys",

  // Alcools (biÃ¨re, vin, champagne)
  tcCatBeer: "BiÃ¨re",
  tcBeer: "BiÃ¨re",
  tcBeerQ: "QuÃ¶llfrisch Lager Blonde",
  tcBeerC: "Calvinus Blanche",
  tcBeerL: "Leermond (sans alcool)",

  tcCatChamp: "Champagne",
  tcChampagne: "Champagne",
  tcChampPH: "Notes (ex : marque, rosÃ©â€¦)",

  tcCatVin: "Vins",
  tcWines: "Vins",
  tcRed: "Rouge",
  tcWhite: "Blanc",
  tcVinPH: "Notes (ex : cÃ©page, commentaireâ€¦)",

  tcCatHot: "Boissons chaudes",
tcMilkTitle: "Lait / CrÃ¨me",
tcSugarTitle: "Sucre",
tcTeaTitle: "ThÃ©",
tcAlcoholTitle: "Boissons alcoolisÃ©es",
tcSoftTitle: "Boissons soft",

tcTeaEnglish: "English Breakfast",
tcTeaVert: "ThÃ© vert",
tcTeaMenthe: "ThÃ© menthe",

tcWater: "Eau",
tcCola: "Cola",
tcJuice: "Jus",
tcSprite: "Sprite",
tcTonic: "Tonic",

tcStill: "Plate",
tcSpark: "Gazeuse",
tcClassic: "Classic",
tcZero: "Zero",

tcOrange: "Orange",
tcApple: "Pomme",
tcTomato: "Tomate",

tcCaotina: "Caotina",
jsonRestored: "Session restaurÃ©e depuis le JSON",
invalidFile: "Fichier invalide.",

},

DE: {
  // =========================
  // HEADER (barre du haut)
  // =========================
  flight: "Flug",
  date: "Datum",
  saveTitle: "Speichern",
  reset: "ZurÃ¼cksetzen",
  client: "Kundensicht",
  crew: "Crew-Modus",
  lblLang: "Sprache",
  exportJSON: "JSON exportieren",
  importJSON: "Importieren",
  exportPNG: "PNG exportieren",
  rights: "Alle Rechte vorbehalten",

  // =========================
  // CHIPS & FILTER (Aktionsleiste)
  // =========================
  chips_apero: "ğŸ· Aperitif",
  chips_meal: "ğŸ± Hauptgang",
  chips_tc: "â˜• Tee & Kaffee",
  chips_fiche: "ğŸ§¾ Kundendatei",

  filter_all: "Alle Sitze",
  filter_toserve: "Zu bedienen",
  filter_clear: "Zum AbrÃ¤umen",
  filter_sleep: "SchlÃ¤ft",
  filter_later: "SpÃ¤ter bedienen",

  lgServed: "âœ… Serviert",
  lgclear: "ğŸ§¹ AbgerÃ¤umt",

  // =========================
  // FLOW / SEATMAP / LABELS
  // =========================
  flowTitle: "Serviceablauf",
  flowNowTitle: "Reihenfolge â¬‡ï¸",
  flowLaterTitle: "Bestellungen aufnehmen â¬‡ï¸",
  flowClearTitle: "Zum AbrÃ¤umen â¬‡ï¸",
  flowAperoTakenTitle: "Aufgenommene Bestellungen â¬‡ï¸",
flowTaken: "Aufgenommen",
flowEmptyTaken: "Noch keine Bestellungen",
flowTCTakenTitle: "Tee & Kaffee aufgenommen â¬‡ï¸",

  flowTakeOrder: "Bestellung",
  flowServeTag: "Servieren",
  flowClearTag: "Zum AbrÃ¤umen",

  flowEmptyLater: "Keine Bestellungen",
  flowEmptyClear: "Nichts abzurÃ¤umen",

  seatmapTitle: "Sitzplan ({L} | {R})",
  seat: "Sitz",
  trayShort: "Tray",

  apLabel: "Aperitif",
  mealLabel: "Hauptgang",

  // =========================
  // ASIDE (Konfiguration & Inventar)
  // =========================
  hdrConfig: "Vorhang & Konfiguration",
  lblLayout: "Kabinenlayout",
  lblRows: "Reihen",

  secMenuTitle: "MenÃ¼",
  lblViande: "Option 1",
  lblVege: "Option 2",

  hdrInventaire: "Inventar",
  invPlateaux: "Trays",
  invViande: "Option 1",
  invVege: "Option 2",
  invSpecial: "SPML",

  spml: "SPML",
  add: "HinzufÃ¼gen",
  preHeader: "Vorbestellung",
  preAdd: "Vorbestellung",

  // =========================
  // MODALE (Sitzdetails)
  // =========================
  close: "âœ–ï¸",
  mdPass: "Passagier",
  mdOcc: "Sitz belegt",
  mdSleepTxt: "ğŸ˜´ SchlÃ¤ft",

  // Pax-Typ
  mdType: "Paxtyp",
  mdAdult: "ğŸ™‚ Erwachsener",
  mdChild: "ğŸ§’ Kind",
  mdInfant: "ğŸ‘¶ SÃ¤ugling",
  mdStatus: "Status",
  mdLang: "Sprache",
mdEatWith: "Zusammen essen mit",
mdEatWithPh: "z. B. 12B",

  // Aktionen Service
  mdLater: "SpÃ¤ter bedienen",
  mdLaterCustom: "Uhrzeitâ€¦",
  mdLaterSet:"ğŸ•°ï¸ Uhrzeit setzen",
  mdLaterCancel:"Abbrechen",

  // Notizen
  mdNotes: "Notizen",
  mdAperoNotes: "GetrÃ¤nk / Aperitif-Notizen",
  mdTCNotes: "Tee & Kaffee â€“ Notizen",

  // Mahlzeit
  serveAperitif: "Aperitif serviert",
  mdMeal: "Mahlzeit",
  mdNormal: "Normale Auswahl",
  optNormalMeat: "Option 1",
  optNormalVeg: "Option 2",
  optNormalTray: "Tray (ohne Kasserolle)",
  mealDrinkTitle: "GetrÃ¤nke zum Essen",
  mealDrinkNotes: "GetrÃ¤nke-Notizen",

  optStatusOther: "Andere",         // (1)

  mdSpml: "SPML",
  mdPre: "Vorbestellung",
  serveMeal: "Hauptgang serviert",
  cancelService: "Service zurÃ¼cknehmen",

  clearTray: "Tray abgerÃ¤umt",
  undoClearTray: "AbrÃ¤umen rÃ¼ckgÃ¤ngig",
  ordered: "bestellt",
  eatTogether: "ğŸ½ï¸ Zusammen essen mit",
eatTogetherPH: "z.â€¯B. 4C",
clear: "LÃ¶schen",
moveSeat: "ğŸ” Pax verschieben",
moved: "Verschoben",
swapped: "Getauscht",
pickDestSeat: "Zielsitz wÃ¤hlen",
moved: "Verschoben",
swapped: "Getauscht",

  // Tee & Kaffee
  tcCH: "Schweiz",
  tcForeign: "Ausland",
  serveTC: "Tee & Kaffee serviert",
  serveMealDrink: "GetrÃ¤nk bestellen",
  histTcServed: "Tee & Kaffee serviert um",
  histMealDrinkServed:"GetrÃ¤nk bestellt bei",
  serveNone: "Nichts",

  // =========================
  // LEGENDE
  // =========================
  lgSleep: "ğŸ˜´ SchlÃ¤ft",
  lgLater: "â³ SpÃ¤ter bedienen",
  lgChoice: "ğŸ½ï¸ Auswahl gespeichert",
  lgInfant: "ğŸ‘¶ SÃ¤ugling",
  lgChild: "ğŸ§’ Kind",
  lgTogether: "ğŸ¤ Zusammen essen",

  // =========================
  // ALARME / MELDUNGEN
  // =========================
  alertSeatEmpty: "Sitz nicht belegt.",
  alertChoose: "Bitte zuerst eine Auswahl treffen (normal, SPML oder Vorbestellung).",
  alertNoTrays: "Keine Trays verfÃ¼gbar.",
  alertStock: "Zu wenig Bestand fÃ¼r",
  alertDepleted: "ausverkauft.",
  alertPickTime: "Uhrzeit wÃ¤hlen.",

  resetConfirm: "BestÃ¤tigen",
  preAddLabelRequired: "Geben Sie einen Namen fÃ¼r die Vorbestellung ein",
  spmlCodeRequired: "WÃ¤hlen Sie einen SPML-Code",

  histViewLabel: "Ansicht",
  histScope_all: "Alle Ereignisse",
  histScope_seat: "Nach Sitz",
  histScope_type: "Nach Typ",
  histLblSeat: "Sitz",
  histLblType: "Typ",
  histAscLbl: "Ã„lteste zuerst",
  histType_mealDrinkServed: "GetrÃ¤nk zum Essen serviert",

  histType_apServed: "Aperitif serviert",
  histType_tcServed: "Tee & Kaffee serviert",
  histType_mealServed: "Hauptgang serviert",
  histType_apCanceled: "Aperitif storniert",
  histType_serviceCanceled: "Service storniert",
  histType_trayCleared: "Tray abgerÃ¤umt",
  histType_trayUncleared: "AbrÃ¤umen rÃ¼ckgÃ¤ngig",
  histType_reset: "Flug zurÃ¼ckgesetzt",
  histType_seatMoveStart: "Pax-Verschiebung",
histType_seatMoved: "Sitz verschoben",
histType_seatSwapped: "Sitze getauscht",
  histType_text: "Notizen",
  histNewest: "(neueste oben)",
histOldest: "(Ã¤lteste oben)",
histNewestBtn: "Auf Ã„lteste oben umschalten",    // wenn aktueller Zustand 'Neueste oben' ist
histOldestBtn: "Auf Neueste oben umschalten",    // wenn aktueller Zustand 'Ã„lteste oben' ist

  // =========================
  // VERLAUF / ERINNERUNGEN
  // =========================
  secHistoryTitle: "Verlauf (neueste oben)",
  histTitleSet: "Titel gesetzt:",
  histApServed: "Aperitif serviert bei",
  histApCanceled: "Aperitif storniert fÃ¼r",
  histMealServed: "Hauptgang serviert bei",
  histCanceled: "Service storniert fÃ¼r",
  resetDone: "Flug zurÃ¼ckgesetzt.",

  remindersTitle: "Anstehende Erinnerungen",
  remindServe: "ğŸ›ï¸ Erinnerung: bedienen",

  // =========================
  // DIVERS (Duplikate beibehalten)
  // =========================
  optStatusOther: "Andere",   // (2) Duplikat beibehalten

  // =========================
  // TC PANEL (GetrÃ¤nke / Service)
  // =========================
  tcTitle: "Aperitif",
  tcDrink: "GetrÃ¤nk",
  tcService: "Servierart",
  tcNotes: "Notizen",
  tcGroupSoft: "Softdrinks",
  tcGroupAlcohol: "Alkohol",
  tcGroupHot: "HeiÃŸgetrÃ¤nke",
  tcLblAlcohol: "Alkohol",
  tcLblHot: "HeiÃŸgetrÃ¤nke",

  // Softdrinks
  tcCatSoft: "Softdrinks",
  tcLblSoft: "Softdrinks",
  tcLblWater: "Wasser",
  tcLblJuice: "Saft",
  tcLblCoca: "Coca-Cola",
  tcSoftWater: "Wasser",
  tcSoftJuice: "Saft",
  tcSoftCoca: "Coca-Cola",
  tcSoftSprite: "Sprite",
  tcSoftTonic: "Tonic",

  tcWaterStill: "Still",
  tcWaterSpark: "Sprudelnd",
  tcJuiceApple: "Apfel",
  tcJuiceOrange: "Orange",
  tcJuiceTomato: "Tomate",
  tcCocaClassic: "Classic",
  tcCocaZero: "Zero",

  tcLemon: "Zitrone",
  tcSalt: "Salz",
  tcPepper: "Pfeffer",
  tcExtras: "Extras",

  // Kaffee / Tee / AufgÃ¼sse / Schokolade
  tcCatCafe: "Kaffee",
  tcCatDeca: "Koffeinfrei",
  tcCatThe: "Tee",
  tcCatInf: "Aufguss",
  tcCatChoco: "Caotina",

  tcLblChoco: "Caotina",
  tcChocoBrand: "Caotina",

  tcMilk: "Milch/Sahne",
  tcMilkCreme: "Sahne",
  tcMilkAvoine: "Hafermilch",
  tcMilkLait: "Milch",
  tcMilkNone: "Ohne",

  tcSweet: "SÃ¼ÃŸe",
  tcSweetSugar: "Zucker",
  tcSweetSub: "Ersatz",
  tcSweetNone: "Ohne",

  tcTeaType: "Teeart",
  tcTeaEnglish: "English Breakfast",
  tcTeaVert: "GrÃ¼n",
  tcTeaMenthe: "Minze",
  tcHotWater: "HeiÃŸes Wasser",

  tcInfusion: "Aufguss",
  tcInfCam: "Kamille",

  tcPur: "Pur",
  tcRocks: "On the rocks",
  tcBaileys: "Baileys",
  tcIce: "Eis",

  tcCatDig: "Digestif",
  tcDigestif: "Digestif",

  tcDigJW: "Johnnie Walker",
  tcDigJB: "Jim Beam (Bourbon)",
  tcDigCognac: "Cognac",
  tcDigBaileys: "Baileys",

  // Alkohol (Bier, Wein, Champagner)
  tcCatBeer: "Bier",
  tcBeer: "Bier",
  tcBeerQ: "QuÃ¶llfrisch Lager Blonde",
  tcBeerC: "Calvinus WeiÃŸ",
  tcBeerL: "Leermond (alkoholfrei)",

  tcCatChamp: "Champagner",
  tcChampagne: "Champagner",
  tcChampPH: "Notizen (z. B. Marke, RosÃ©â€¦)",

  tcCatVin: "Weine",
  tcWines: "Weine",
  tcRed: "Rot",
  tcWhite: "WeiÃŸ",
  tcVinPH: "Notizen (z. B. Rebsorte, Kommentarâ€¦)",

  tcCatHot: "HeiÃŸgetrÃ¤nke",
tcMilkTitle: "Milch / Rahm",
tcSugarTitle: "Zucker",
tcTeaTitle: "Tee",
tcAlcoholTitle: "Alkoholische GetrÃ¤nke",
tcSoftTitle: "Softdrinks",

tcTeaEnglish: "English Breakfast",
tcTeaVert: "GrÃ¼ner Tee",
tcTeaMenthe: "Minztee",

tcWater: "Wasser",
tcCola: "Cola",
tcJuice: "Saft",
tcSprite: "Sprite",
tcTonic: "Tonic",

tcStill: "Still",
tcSpark: "Sprudel",
tcClassic: "Classic",
tcZero: "Zero",

tcOrange: "Orange",
tcApple: "Apfel",
tcTomato: "Tomate",

tcCaotina: "Caotina",

jsonRestored: "Sitzung aus JSON wiederhergestellt",
invalidFile: "UngÃ¼ltige Datei.",

}

};


// I18N â€” DOM bindings (sÃ©lecteur â†’ clÃ©)
const I18N_BINDINGS = [
  // =========================
  // HEADER (barre du haut)
  // =========================
  ["lblFlight","flight"],
  ["lblDate","date"],
  ["saveTitle","saveTitle"],
  ["resetFlight","reset"],
  ["lblLang","lblLang"],

  // =========================
  // CHIPS & FILTRES (rangÃ©e actions)
  // =========================
  ['#phaseChips .chip[data-phase="aperitif"]',"chips_apero"],
  ['#phaseChips .chip[data-phase="repas"]',"chips_meal"],
  ['#phaseChips .chip[data-phase="tc"]',"chips_tc"],

  // =========================
  // FILTRES (options du select)
  // =========================
  ["#filterSelect option[value='all']","filter_all"],
  ["#filterSelect option[value='toServe']","filter_toserve"],
  ["#filterSelect option[value='sleeping']","filter_sleep"],
  ["#filterSelect option[value='later']","filter_later"],
  ["#filterSelect option[value='clear']","filter_clear"],

  // =========================
  // FLOW / SEATMAP / LABELS
  // =========================
  ["flowTitle","flowTitle"],
  ["flowNowTitle","flowNowTitle"],
  ["flowLaterTitle","flowLaterTitle"],
  ["flowClearTitle","flowClearTitle"],

  // =========================
  // ASIDE (config & inventaire)
  // =========================
  ["hdrConfig","hdrConfig"],
  ["lblLayout","lblLayout"],
  ["lblRows","lblRows"],
  ["secMenuTitle","secMenuTitle"],
  ["lblViande","lblViande"],
  ["lblVege","lblVege"],
  ["hdrInventaire","hdrInventaire"],
  ["lblInvPlateaux","invPlateaux"],
  ["lblInvViande","invViande"],
  ["lblInvVege","invVege"],
  ["lblInvSpecial","invSpecial"],
  ["lblSpml","spml"],
  ["spmlAddBtn","add"],
  ["lblPreAdd","preAdd"],
  ["preAddBtn","add"],
  ["preHeader","preHeader"],

  // =========================
  // TC PANEL â€” CatÃ©gorie & en-tÃªtes
  // =========================
  ["tcTitle","tcTitle"],
  ["tcLblCat","tcDrink"],
  ["tcCatCafe","tcCatCafe"],
  ["tcCatDeca","tcCatDeca"],
  ["tcCatThe","tcCatThe"],
  ["tcCatInf","tcCatInf"],
  ["tcCatDig","tcCatDig"],
  ["tcCatBeer","tcCatBeer"],
  ["tcCatChamp","tcCatChamp"],
  ["tcCatVin","tcCatVin"],
  ["tcCatSoft","tcCatSoft"],
  ["tcCatChoco","tcCatChoco"],
  ["tcGroupSoft","tcGroupSoft"],
  ["tcGroupAlcohol","tcGroupAlcohol"],
  ["tcGroupHot","tcGroupHot"],
  ["tcLblAlcohol","tcLblAlcohol"],
  ["tcLblHot","tcLblHot"],

  // =========================
  // TC PANEL â€” Sous-libellÃ©s / lignes
  // =========================
  ["tcLblSoft","tcLblSoft"],
  ["tcLblWater","tcLblWater"],
  ["tcLblJuice","tcLblJuice"],
  ["tcLblCoca","tcLblCoca"],
  ["tcLblMilk","tcMilk"],
  ["tcLblSweet","tcSweet"],
  ["tcLblTeaType","tcTeaType"],
  ["tcLblInfusion","tcInfusion"],
  ["tcLblDigestif","tcDigestif"],
  ["tcLblService","tcService"],
  ["tcLblBaileys","tcBaileys"],
  ["tcLblBeer","tcBeer"],
  ["tcLblChamp","tcChampagne"],
  ["tcLblVin","tcWines"],
  ["tcLblRed","tcRed"],
  ["tcLblWhite","tcWhite"],
  ["tcLblChoco","tcLblChoco"],

  // =========================
  // TC PANEL â€” Drapeaux / provenance vins
  // =========================
  ["tcRedCH","tcCH"],
  ["tcRedForeign","tcForeign"],
  ["tcWhiteCH","tcCH"],

  // =========================
  // TC PANEL â€” DÃ©tails softs / eaux / jus / coca
  // =========================
  ["tcSoftWater","tcSoftWater"],
  ["tcSoftJuice","tcSoftJuice"],
  ["tcSoftCoca","tcSoftCoca"],
  ["tcSoftSprite","tcSoftSprite"],
  ["tcSoftTonic","tcSoftTonic"],
  ["tcWaterStill","tcWaterStill"],
  ["tcWaterSpark","tcWaterSpark"],
  ["tcJuiceApple","tcJuiceApple"],
  ["tcJuiceOrange","tcJuiceOrange"],
  ["tcJuiceTomato","tcJuiceTomato"],
  ["tcCocaClassic","tcCocaClassic"],
  ["tcCocaZero","tcCocaZero"],
  ["hdrHot","tcGroupHot"],
  ["hdrSoft","tcGroupSoft"],
  ["hdrAlco","tcGroupAlcohol"],

  // =========================
  // TC PANEL â€” Chocolat chaud & marque
  // =========================
  ["tcChocoBrand","tcChocoBrand"],

  // =========================
  // TC PANEL â€” Glace / citron / sel / poivre (tous emplacements)
  // =========================
  ["tcIceSoft","tcIce"],
  ["tcIceSoft2","tcIce"],
  ["tcIceSoft3","tcIce"],
  ["tcIceSoft4","tcIce"],
  ["tcLemonSoft","tcLemon"],
  ["tcLemonSoft2","tcLemon"],
  ["tcLemonSoft3","tcLemon"],
  ["tcLemonSoft4","tcLemon"],
  ["tcSalt","tcSalt"],
  ["tcPepper","tcPepper"],

  // =========================
  // TC PANEL â€” Lait / sucre
  // =========================
  ["tcMilkCreme","tcMilkCreme"],
  ["tcMilkAvoine","tcMilkAvoine"],
  ["tcMilkLait","tcMilkLait"],
  ["tcMilkNone","tcMilkNone"],
  ["tcSweetSugar","tcSweetSugar"],
  ["tcSweetSub","tcSweetSub"],
  ["tcSweetNone","tcSweetNone"],

  // =========================
  // TC PANEL â€” ThÃ©s & infusions
  // =========================
  ["tcTeaEnglish","tcTeaEnglish"],
  ["tcTeaVert","tcTeaVert"],
  ["tcTeaMenthe","tcTeaMenthe"],
  ["tcInfCam","tcInfCam"],

  // =========================
  // TC PANEL â€” Digestifs / service / glaÃ§ons gÃ©nÃ©riques
  // =========================
  ["tcDigJW","tcDigJW"],
  ["tcDigJB","tcDigJB"],
  ["tcDigCognac","tcDigCognac"],
  ["tcDigBaileys","tcDigBaileys"],
  ["tcPur","tcPur"],
  ["tcRocks","tcRocks"],
  ["tcIce","tcIce"],

  // =========================
  // TC PANEL â€” BiÃ¨res / Champagne / Vins
  // =========================
  ["tcBeerQ","tcBeerQ"],
  ["tcBeerC","tcBeerC"],
  ["tcBeerL","tcBeerL"],
  ["tcChampagne","tcChampagne"],
  ["tcWines","tcWines"],
  ["tcRed","tcRed"],
  ["tcWhite","tcWhite"],

  // =========================
  // TC PANEL â€” Notes & icÃ´nes glaÃ§ons par rubrique
  // =========================
  ["tcNotes","tcNotes"],
  ["tcLblIceGen","tcIce"],
  ["tcIceGen","tcIce"],
  ["tcIceChamp","tcIce"],
  ["tcIceVin","tcIce"],

  // =========================
  // TC PANEL â€” Notes TC et bouton service
  // =========================
  ["mdTCNotes","mdTCNotes"],
  ["mdMealDrinkNotes","mealDrinkNotes"],
  ["serveTC","serveTC"],
  ["serveMealDrink","serveMealDrink"],

  // =========================
  // LÃ‰GENDE
  // =========================
  ["lgSleep","lgSleep"],
  ["lgLater","lgLater"],
  ["lgServed","lgServed"],
  ["lgInfant","lgInfant"],
  ["lgChild","lgChild"],
  ["lgTogether","lgTogether"],
  ["lgclear","lgclear"],

  // =========================
  // HISTORIQUE / RAPPELS
  // =========================
  ["secHistoryTitle","secHistoryTitle"],
  ["remindersTitle","remindersTitle"],
  ["histLbl","histViewLabel"],
  ["histLblSeat","histLblSeat"],
  ["histLblType","histLblType"],
  ["histAscLbl","histAscLbl"],
["#histType option[value='mealDrinkServed']","histType_mealDrinkServed"],
  ["#histMode option[value='all']","histScope_all"],
  ["#histMode option[value='seat']","histScope_seat"],
  ["#histMode option[value='type']","histScope_type"],

  ["#histType option[value='apServed']","histType_apServed"],
  ["#histType option[value='tcServed']","histType_tcServed"],
  ["#histType option[value='mealServed']","histType_mealServed"],
  ["#histType option[value='apCanceled']","histType_apCanceled"],
  ["#histType option[value='serviceCanceled']","histType_serviceCanceled"],
  ["#histType option[value='trayCleared']","histType_trayCleared"],
  ["#histType option[value='trayUncleared']","histType_trayUncleared"],
  ["#histType option[value='reset']","histType_reset"],
  ["#histType option[value='text']","histType_text"],
  ["#histType option[value='seatMoveStart']","histType_seatMoveStart"],
["#histType option[value='seatMoved']","histType_seatMoved"],
["#histType option[value='seatSwapped']","histType_seatSwapped"],

  // =========================
  // MODALE (fiche siÃ¨ge)
  // =========================
  ["closeModal","close"],
  ["mdPass","mdPass"],
  ["mdOcc","mdOcc"],
  ["mdSleepTxt","mdSleepTxt"],
  ["mdType","mdType"],
  ["mdAdult","mdAdult"],
  ["mdChild","mdChild"],
  ["mdInfant","mdInfant"],
  ["mdStatus","mdStatus"],
  ["mdLang","mdLang"],
  ["mdLater","mdLater"],
  ["mdLaterSet","mdLaterSet"],
  ["mdLaterCancel","mdLaterCancel"],  
  ["mdLaterCustom","mdLaterCustom"],
  ["mdNotes","mdNotes"],
  ["mdAperoNotes","mdAperoNotes"],
  ["serveAperitif","serveAperitif"],
  ["mdMeal","mdMeal"],
  ["mdNormal","mdNormal"],
  ["optNormalMeat","optNormalMeat"],
  ["optNormalVeg","optNormalVeg"],
  ["optNormalTray","optNormalTray"],
  ["mdSpml","mdSpml"],
  ["mdPre","mdPre"],
  ["serveMeal","serveMeal"],
  ["optStatusOther","optStatusOther"],
  ['#phaseChips .chip[data-phase="fiche"]', 'chips_fiche'],
  ["movePaxBtn","moveSeat"],
  ["mdEatTogether", "eatTogether"],
  ["mdEatWith","mdEatWith"],
  ["btnClearEat", "clear"],

];

// â€”â€”â€” Bandeau lÃ©gal (crÃ©ation si absent) â€”â€”â€”
function ensureLegalBanner() {
  if (!document.getElementById("appLegal")) {
    const div = document.createElement("div");
    div.id = "appLegal";
    div.style.position = "fixed";
    div.style.bottom = "6px";
    div.style.right = "10px";
    div.style.fontSize = "12px";
    div.style.color = "var(--muted)";
    div.style.background = "var(--panel)";
    div.style.padding = "4px 8px";
    div.style.border = "1px solid var(--grid)";
    div.style.borderRadius = "8px";
    div.style.zIndex = "9999";
    div.style.pointerEvents = "none";

    // Texte statique + span traduisible
    div.innerHTML = 'Â© 2025 Nicolas Debesse | DEBN | 47762 â€” <span id="legalRights"></span>';

    document.body.appendChild(div);
  }
}

function applyI18n(){
  const lang = store.config.lang || "EN";
  ensureLegalBanner();                               // crÃ©e le bandeau si besoin
const legal = document.getElementById("legalRights");
if (legal) legal.textContent = (I18N[lang] || I18N.EN).rights || "All rights reserved";

  const L = I18N[lang] || I18N.EN;

  // Bouton client/crew
  const cv = document.getElementById("clientView");
  if (cv){
    cv.textContent = store.clientView ? ("ğŸ§‘â€âœˆï¸ " + L.crew) : ("ğŸ‘€ " + L.client);
  }

  // Bindings sÃ»rs (Ã©vite â€œundefined is not iterableâ€)
  if (Array.isArray(typeof I18N_BINDINGS !== "undefined" ? I18N_BINDINGS : [])) {
    for (let i = 0; i < I18N_BINDINGS.length; i++) {
      const pair = I18N_BINDINGS[i];
      if (!pair || pair.length < 2) continue;
      const sel = pair[0], key = pair[1];
const _ew = document.getElementById("m_eatWith");
if (_ew && !_ew.title) _ew.title = L.mdEatWithPh || "e.g. 12B";
      const el = (sel && (sel.startsWith("#") || sel.startsWith(".")))
        ? document.querySelector(sel)
        : document.getElementById(sel);
      if (el && L[key] !== undefined) el.textContent = L[key];
    }
    updateModalPhaseNav?.(); // met Ã  jour titres/visibilitÃ© des 4 emojis
  }

  // --- Titles traduits pour les boutons du header ---
(function setTooltips(){
  const L = I18N[store.config.lang || "EN"] || I18N.EN;
  ["sleepMealBtn","sleepAperoBtn","sleepTCBtn","sleepModalBtn"].forEach(id => {
    const b = document.getElementById(id);
    if (b) b.title = L.mdSleepTxt || "Sleep";});
  const map = [
    ["saveSnapshot", "saveTitle"],
    ["exportJSON",  "exportJSON"],
    ["importJSON",  "importJSON"],   // si tu as le bouton
    ["exportPNG",   "exportPNG"],
    ["resetFlight", "reset"]
  ];
  for (const [id, key] of map) {
    const el = document.getElementById(id);
    if (el && L[key]) el.title = L[key];
  }
})();


  // +++ Traduction gÃ©nÃ©rique des Ã©lÃ©ments [data-i18n] +++
document.querySelectorAll("[data-i18n]").forEach(el => {
  const k = el.getAttribute("data-i18n");
  if (k && L[k] !== undefined) el.textContent = L[k];
});

// --- LÃ©gendes des GROS boutons (grille boissons) ---
(function setBigDrinkCaps(){
  const L = I18N[store.config.lang || "EN"] || I18N.EN;

  const capMap = {
    drink_coffee:   () => L.tcCatCafe     || "Coffee",
    drink_decaf:    () => L.tcCatDeca     || "Decaf",
    drink_tea:      () => L.tcCatThe      || "Tea",
    drink_caotina:  () => L.tcChocoBrand  || L.tcCatChoco || "Caotina",

    drink_water:    () => L.tcSoftWater   || L.tcWater || "Water",
    drink_cola:     () => L.tcSoftCoca    || L.tcCola  || "Cola",
    drink_juice:    () => L.tcSoftJuice   || L.tcJuice || "Juice",
    drink_sprite:   () => L.tcSoftSprite  || "Sprite",
    drink_tonic:    () => L.tcSoftTonic   || "Tonic",

    drink_champagne:() => L.tcChampagne   || "Champagne",
    drink_red:      () => (L.tcWines && L.tcRed)   ? `${L.tcWines} â€” ${L.tcRed}`   : "Red wine",
    drink_white:    () => (L.tcWines && L.tcWhite) ? `${L.tcWines} â€” ${L.tcWhite}` : "White wine",
    drink_beer:     () => L.tcBeer        || "Beer",
    drink_cocktail: () => L.tcCocktail    || "Cocktail",
    drink_digestif: () => L.tcDigestif    || "Digestif",
  };

  document.querySelectorAll('#drinkGrid .pill-cap[data-i18n-cap]').forEach(cap => {
    const key = cap.getAttribute('data-i18n-cap');
    const txt = (capMap[key] ? capMap[key]() : cap.textContent || "").trim();
    if (txt) cap.textContent = txt;
  });
})();


// -- Localise les tooltips des grosses catÃ©gories (grille boissons)
{
  const L = I18N[store.config.lang || "EN"] || I18N.EN;
  const setT = (sel, txt)=>{ const b=document.querySelector(sel); if(b){ b.title = txt; b.setAttribute('aria-label', txt); } };

  // Chaud
  setT('#hotRow .pill.big[data-sub="cafe"]',     L.tcCatCafe || "Coffee");
  setT('#hotRow .pill.big[data-sub="deca"]',     L.tcCatDeca || "Decaf");
  setT('#hotRow .pill.big[data-sub="the"]',      L.tcCatThe  || "Tea");
  setT('#hotRow .pill.big[data-sub="chocolat"]', L.tcCatChoco|| "Caotina");

  // Soft
  setT('#softRow .pill.big[data-sub="eau"]',     L.tcSoftWater  || L.tcWater || "Water");
  setT('#softRow .pill.big[data-sub="coca"]',    L.tcCola       || "Cola");
  setT('#softRow .pill.big[data-sub="jus"]',     L.tcSoftJuice  || L.tcJuice || "Juice");
  setT('#softRow .pill.big[data-sub="sprite"]',  L.tcSoftSprite || "Sprite");
  setT('#softRow .pill.big[data-sub="tonic"]',   L.tcSoftTonic  || "Tonic");

  // Alcool
  setT('#alcoRow .pill.big[data-sub="champagne"]', L.tcChampagne || "Champagne");
  setT('#alcoRow .pill.big[data-sub="biere"]',     L.tcBeer      || "Beer");
  setT('#alcoRow .pill.big[data-sub="vin_rouge"]', (L.tcWines && L.tcRed) ? `${L.tcWines} â€” ${L.tcRed}` : "Red wine");
  setT('#alcoRow .pill.big[data-sub="vin_blanc"]', (L.tcWines && L.tcWhite)? `${L.tcWines} â€” ${L.tcWhite}` : "White wine");
  setT('#alcoRow .pill.big[data-sub="digestif"]',  L.tcDigestif || "Digestif");
}

const tnotes = document.getElementById("m_tcNotes");
if (tnotes) tnotes.placeholder =
  (lang==="FR") ? "ex : CafÃ© allongÃ©, sucre"
: (lang==="DE") ? "z. B.: VerlÃ¤ngerter, Zucker"
                : "e.g. Long coffee, sugar";

                // Placeholder "Notes" (colonne gauche gÃ©nÃ©rique)
const mnotes = document.getElementById("m_notes");
if (mnotes) {
  mnotes.placeholder = (lang==="FR") ? "ex : DE uniquement, sans cacahuÃ¨tes"
                    : (lang==="DE") ? "z. B.: nur DE, keine NÃ¼sse"
                                    : "e.g. DE only, no nuts";
}

// Placeholder "Meal drink notes" (repas)
const mdn = document.getElementById("m_mealDrinkNotes");
if (mdn) {
  mdn.placeholder = (lang==="FR") ? "ex : eau gazeuse, vin blanc, cacahuÃ¨tes"
                 : (lang==="DE") ? "z. B.: Sprudelwasser, WeiÃŸwein, ErdnÃ¼sse"
                                 : "e.g. sparkling water, white wine, peanuts";
}

  // Placeholder "Eat together with"
  const eatw = document.getElementById("m_eatWith");
  if (eatw) eatw.placeholder = L.mdEatWithPh || "e.g. 12B";

  // Placeholders dynamiques
  const lv = document.getElementById("labelViande");
  const lg = document.getElementById("labelVege");
  if (lv) lv.placeholder = (lang==="FR") ? "ex: BÅ“uf sauce vin rouge"
                   : (lang==="DE") ? "z. B.: Rind in Rotweinsauce"
                                   : "e.g., Beef in red-wine sauce";
  if (lg) lg.placeholder = (lang==="FR") ? "ex: Lasagnes vÃ©gÃ©tariennes"
                   : (lang==="DE") ? "z. B.: Vegetarische Lasagne"
                                   : "e.g., Vegetarian lasagna";

  const f = document.getElementById("filterSelect");
  if (f) f.title = (lang==="FR") ? "Filtrer" : (lang==="DE" ? "Filtern" : "Filter");

  const ls = document.getElementById("layoutSelect");
  if (ls) ls.title = (lang==="FR") ? "Type d'appareil" : (lang==="DE" ? "Flugzeugtyp" : "Aircraft type");

  const sp = document.getElementById("spmlAddCode");
  if (sp) sp.title = (lang==="FR") ? "Ajouter code SPML" : (lang==="DE" ? "SPML-Code hinzufÃ¼gen" : "Add SPML code");

  const pre = document.getElementById("preAddLabel");
  if (pre) pre.placeholder = (lang==="FR") ? "ex : PÃ¢tes sans gluten"
                         : (lang==="DE") ? "z. B.: Glutenfreie Pasta"
                                         : "e.g., Gluten-free pasta";

  document.documentElement.lang = lang.toLowerCase();
const legalEl = document.getElementById("legalRights");
if (legalEl) legalEl.textContent = L.rights || "All rights reserved";

  const notes = document.getElementById("m_notes");
  if (notes) notes.placeholder =
    (lang==="FR") ? "ex : DE uniquement, sans noix"
  : (lang==="DE") ? "z. B.: nur DE, keine NÃ¼sse"
                  : "e.g., DE only, no nuts";

  const anotes = document.getElementById("m_aperoNotes");
  if (anotes) anotes.placeholder =
    (lang==="FR") ? "ex : Eau gazeuse, vin blanc, cacahuÃ¨tes"
  : (lang==="DE") ? "z. B.: Sprudelwasser, WeiÃŸwein, ErdnÃ¼sse"
                  : "e.g. Sparkling water, white wine, peanuts";

const hSeat = document.getElementById("histSeat");
if (hSeat){
  hSeat.placeholder =
    (lang==="FR") ? "ex : 3A"
  : (lang==="DE") ? "z. B.: 3A"
                  : "e.g., 3A";
}

  // Met Ã  jour le titre du plan
  if (typeof updateSeatmapTitle === "function") updateSeatmapTitle();
  if (typeof window._rerenderDatepickerLang === "function") window._rerenderDatepickerLang();

const fd = document.getElementById("flightDate");
if (fd){
  if (store.config.lang === "FR") fd.placeholder = "JJ/MM/AAAA";
  else if (store.config.lang === "DE") fd.placeholder = "TT.MM.JJJJ";
  else fd.placeholder = "MM, DD, YYYY";
}
updateFlightDatePretty();
updateHistoryTitle();
// ... aprÃ¨s lâ€™application standard des traductions
updateServeDrinkLabel();   // â† force le bon libellÃ© si on est en mode repas

// --- Refresh drinks UI after language switch ---
try {
  document.getElementById("tc_soft_type")?.dispatchEvent(new Event("change"));
  document.getElementById("tc_cocktail_type")?.dispatchEvent(new Event("change"));
  document.getElementById("tc_beer")?.dispatchEvent(new Event("change"));
  document.getElementById("tc_vin_rouge")?.dispatchEvent(new Event("change"));
  document.getElementById("tc_vin_blanc")?.dispatchEvent(new Event("change"));

  
  // RÃ©applique les Ã©tats dÃ©pendants
  tc_updateSoftUI?.();
  updateServeDrinkButtons?.();
  // Si une modale siÃ¨ge est ouverte au moment du changement de langue,
// on la rouvre proprement pour rÃ©initialiser entiÃ¨rement la grille boissons.
try {
  const modalOpen = document.getElementById("modalBack")?.style.display === "flex";
  if (modalOpen && typeof reopenSameSeat === "function") {
    reopenSameSeat(); 
  }
} catch(_) { /* no-op */ }

} catch (e) {
  console.warn("Post-i18n drinks refresh:", e);
}
  // --- (NOUVEAU) RÃ©activer la DRINK GRID si la modale est ouverte aprÃ¨s changement de langue ---
  try {
    const mb = document.getElementById("modalBack");
    const modalOpen = !!mb && (mb.style.display === "flex" || mb.style.display === "");
    if (modalOpen && document.getElementById("drinkGrid")) {
      // Remet dâ€™aplomb la grille et ses listeners (nouvelle UI unifiÃ©e)
      reactivateDrinkGrid?.();
      initDrinkGrid?.();
      // Repeuple les sous-lignes/options si ces helpers existent
      renderDrinkSub?.();
      renderDrinkOpts?.();
      // Montre tous les groupes (Ã©vite un Ã©tat â€œfiltrÃ©â€ persistant)
      showAllDrinkGroups?.();

      // SÃ©curitÃ© : rÃ©-active lâ€™interaction sur toutes les pills
      document.querySelectorAll('#drinkGrid .pill').forEach(b => {
        b.disabled = false;
        b.style.pointerEvents = 'auto';
      });

      // Met Ã  jour lâ€™Ã©tat des boutons "Servir"
      updateServeDrinkButtons?.();

      // RafraÃ®chit lâ€™horodateur inline si on a une seat courante
      if (typeof modalSeat !== "undefined" && modalSeat) {
        if (store.phase === "tc")       updateTCInline?.(modalSeat.key);
        else if (store.phase === "repas") updateMealDrinkInline?.(modalSeat.key);
      }
    }
  } catch(e){
    console.warn("Drink grid rebind after i18n failed:", e);
  }
// -- aprÃ¨s toutes les mises Ã  jour de textes dans applyI18n(), ajoute :
(() => {
  const btn = document.getElementById("langActive");
  if (btn) {
    const flags = { EN:"ğŸ‡¬ğŸ‡§", DE:"ğŸ‡©ğŸ‡ª", FR:"ğŸ‡«ğŸ‡·" };
    const code  = (store.config.lang || "EN");
    btn.textContent = (flags[code] || "ğŸ‡¬ğŸ‡§") + " â–¾";
  }
})();

}


function renderSeatmap(){
  const g=$("#seatgrid"); g.innerHTML="";
const total=store.config.rowsBiz||0; // **Seulement CCL**
const rCols = rightCols(); // ["C","A"] ou ["C","B","A"]
// 40px pour labels, 3 colonnes gauche, 28px pour couloir, puis 2 ou 3 colonnes droite
g.style.gridTemplateColumns = "40px "
  + "minmax(60px,1fr) minmax(60px,1fr) minmax(60px,1fr) "
  + "28px "
  + rCols.map(()=> "minmax(60px,1fr)").join(" ");

// En-tÃªte
const headers = ["","F","E","D",""].concat(rCols);
headers.forEach(c=>{ const el=document.createElement("div"); el.style.textAlign="center"; el.style.color="var(--muted)"; el.style.fontSize="12px"; el.textContent=c; g.appendChild(el); });

  for(let r=total; r>=1; r--){ // rangÃ©e 1 en bas visuellement
    const lab=document.createElement("div"); lab.className="row-label"; lab.textContent=r; g.appendChild(lab);
["F","E","D"].forEach(col=> g.appendChild(renderSeatCell(r,col)));
const aisle=document.createElement("div"); aisle.className="aisle"; g.appendChild(aisle);
rCols.forEach(col=> g.appendChild(renderSeatCell(r,col)));
  }

updateSeatmapTitle();

}
function renderSeatCell(r,col){
  const seat=seatObj(r,col);
  const d=document.createElement("div"); d.className="seat bus";
  if(seat.occupied) d.classList.add("occupied");
  if(seat.sleep) d.classList.add("sleeping");
  const mini=document.createElement("div"); mini.className="mini"; const dot=document.createElement("div"); dot.className="dot";
if(seat.status==="FTL") dot.classList.add("ftl");
else if(seat.status==="SEN") dot.classList.add("sen");
else if(seat.status==="HON") dot.classList.add("hon");
else if(seat.status==="VIP") dot.classList.add("vip");
else if(seat.status==="FCL") dot.classList.add("fcl");
else if(seat.status==="PAD") dot.classList.add("pad");
mini.appendChild(dot); d.appendChild(mini);
  const label=document.createElement("div"); label.className="seat-label"; label.textContent=r+col; d.appendChild(label);
 
 // Tag du choix (emoji ou texte)
// Ne pas afficher le tag si le plateau est dÃ©jÃ  dÃ©barrassÃ©
if (!(seat?.served?.trayCleared)) {
  const tag = document.createElement("div");
  tag.className = "meal-tag";

  const mealEmoji = seat.spml ? null
    : (seat.preLabel ? null
       : (seat.normalMeal === "viande" ? "1ï¸âƒ£"
          : (seat.normalMeal === "vege" ? "2ï¸âƒ£"
             : (seat.normalMeal === "plateau" ? "ğŸ±" : null))));

  if (seat.spml) {
    tag.textContent = seat.spml; d.appendChild(tag);
  } else if (seat.preLabel) {
    tag.textContent = seat.preLabel; d.appendChild(tag);
  } else if (mealEmoji) {
    tag.textContent = mealEmoji; d.appendChild(tag);
  }
}

  
const ib=document.createElement("div"); ib.className="iconbar";
if(seat.type==="infant"){ const e=document.createElement("div"); e.className="icon"; e.textContent="ğŸ‘¶"; ib.appendChild(e); }
if(seat.type==="child"){ const e=document.createElement("div"); e.className="icon"; e.textContent="ğŸ§’"; ib.appendChild(e); }
if (seat?.served && seat.served.meal && seat.served.trayUsed && !seat.served.trayCleared){
  const e=document.createElement("div");
  e.className="icon";
  e.textContent="âœ…";
  ib.appendChild(e);
}

if (seat?.served && seat.served.trayCleared){
  const e=document.createElement("div");
  e.className="icon";
  e.textContent="ğŸ§¹";
  ib.appendChild(e);
}

if(seat.sleep){ const e=document.createElement("div"); e.className="icon"; e.textContent="ğŸ˜´"; ib.appendChild(e); }
if(seat.serveLaterAt){ const e=document.createElement("div"); e.className="icon"; e.textContent="â³"; ib.appendChild(e); }
d.appendChild(ib);

addClickAndTouchListener(d, (e)=>{
  if (store.clientView) return;
  e.preventDefault();         // Ã©vite â€œghost clickâ€ iOS
  e.stopPropagation();
  // >>> AJOUT iPad : si un input de prÃ©commande a le focus, on le â€œblurâ€
  if (document.activeElement && document.activeElement.blur) {
    document.activeElement.blur();
  }
  onSeatClick(keyFor(r, col));
});

d.addEventListener("pointerup", (e)=>{
  if (store.clientView) return;
  // Ã©vite double-exÃ©cution si dÃ©jÃ  passÃ© par touchstart
  if (e.pointerType === "mouse") return;
  onSeatClick(keyFor(r, col));
}, { passive: true });

const flt=$("#filterSelect").value;
if (flt === "toServe") {
  // bonne phase : aperitif | repasâ†’meal | tc
  const phaseKey = (store.phase === "aperitif") ? "aperitif"
                   : (store.phase === "tc")     ? "tc"
                   : "meal"; // "repas" â†’ "meal"
  const served = !!(seat?.served?.[phaseKey]);
  d.style.opacity = (!seat.occupied || served) ? .25 : 1;
}

else if(flt==="sleeping"){ d.style.opacity= seat.sleep?1:.2; }
else if(flt==="later"){ d.style.opacity= seat.serveLaterAt?1:.2; }
else if(flt==="clear"){
  const needsClear = !!(seat?.served?.meal) && !seat?.served?.trayCleared;
  d.style.opacity = needsClear ? 1 : .2;
}
else d.style.opacity=1;
  return d;
}

function renderHistory(){
  const h = $("#history");
  if(!h) return;
  h.innerHTML = "";
  const L = I18N[store.config.lang || "EN"];

  // === lecture des contrÃ´les ===
  const mode = document.getElementById("histMode")?.value || "all";
  const seatQ = (document.getElementById("histSeat")?.value || "").trim().toUpperCase().replace(/\s+/g,"");
  const typeQ = document.getElementById("histType")?.value || "";
const asc   = !!store.config.histAsc;

  // store.history est â€œnewest firstâ€ (unshift). On copie puis filtre.
  let list = Array.isArray(store.history) ? store.history.slice() : [];

  if (mode === "seat" && seatQ){
    list = list.filter(it => it && typeof it === "object" && (it.seat||"").toUpperCase() === seatQ);
} else if (mode === "type" && typeQ){
  list = list.filter(it =>
    it && typeof it === "object"
    && (
      // filtre normal
      (it.type === typeQ)
      // cas spÃ©cial : mealDrinkServed â†’ en fait tcServed + ctx === "repas"
      || (typeQ === "mealDrinkServed" && it.type === "tcServed" && it.ctx === "repas")
    )
    // cas spÃ©cial : tcServed ne doit PAS inclure les repas
    && !(typeQ === "tcServed" && it.ctx === "repas")
  );
}

  // tri ascendant si demandÃ© (oldest first)
  if (asc) list = list.slice().reverse();

  for (const it of list){
    const div = document.createElement("div");

    // compat anciens logs (strings)
    if (typeof it === "string"){
      div.textContent = it;
      h.appendChild(div);
      continue;
    }

    const time = new Date(it.ts || Date.now()).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
    let msg = "";

    switch(it.type){
      case "trayCleared":
        msg = (I18N[store.config.lang||"EN"].clearTray) + " " + it.seat; 
        break;

      case "trayUncleared":
        msg = (I18N[store.config.lang||"EN"].undoClearTray) + " " + it.seat; 
        break;

      case "apServed": {
        const seat  = it.seat;
        const label = summarizeApDrink(it.ap, L, store.config.lang) || "";
        const notes = it.notes ? ` â€” ${it.notes}` : "";
        msg = `${L.histApServed} ${seat}${label ? " â€” " + label : ""}${notes}`;
        break;
      }

    case "tcServed": {
  const seat  = it.seat;
  const label = summarizeApDrink(it.ap, L, store.config.lang) || "";
  const notes = it.notes ? ` â€” ${it.notes}` : "";
  const head  = (it.ctx === "repas") ? (L.histMealDrinkServed || "Meal drinks served at")
                                     : (L.histTcServed || "Tea & coffee served at");
  msg = `${head} ${seat}${label ? " â€” " + label : ""}${notes}`;
  break;
}


      case "apCanceled":
        msg = `${L.histApCanceled} ${it.seat}`; 
        break;

      case "mealServed": {
        const labelTxt = (it.label === "__TRAY__") ? (L.trayShort || "Tray") : (it.label || "");
        msg = `${L.histMealServed} ${it.seat}${labelTxt ? " â€” " + labelTxt : ""}`;
        break;
      }

      case "serviceCanceled":
        msg = `${L.histCanceled} ${it.seat}`; 
        break;

      case "reset":
        msg = L.resetDone; 
        break;

              case "titleSet": {
        // libellÃ© localisÃ© + date formatÃ©e selon la langue courante
        const flight = it.flightNo || "";
        const dateTxt = fmtDateLocalized(it.dateISO || "") || (it.dateISO || "");
        msg = `${L.histTitleSet} ${flight}${dateTxt ? " â€” " + dateTxt : ""}`;
        break;
      }
case "seatMoveStart":
  // Ex: "[12:03] ğŸ” Move pax 3C"
  msg = `${L.moveSeat} ${it.from}`;
  break;

case "seatMoved":
  // Ex: "[12:04] 3C â†’ 4E : DÃ©placÃ©"
  msg = `${it.from} â†’ ${it.to} : ${L.moved}`;
  break;

case "seatSwapped":
  // Ex: "[12:05] 3C â‡„ 4E : Ã‰changÃ©"
  msg = `${it.a} â‡„ ${it.b} : ${L.swapped}`;
  break;

      case "text":
      default:
        msg = it.text || "";
    }

    div.textContent = `[${time}] ${msg}`;
    h.appendChild(div);
  }
}

function updateHistoryTitle(){
  const L = I18N[store.config.lang || "EN"] || I18N.EN;

  // 1) Titre "History ..." avec suffixe dynamique
  const titleEl = document.getElementById("secHistoryTitle");
  if (titleEl){
    // On nettoie un Ã©ventuel "(...)" dans le texte dÃ©jÃ  injectÃ©
    const base = (L.secHistoryTitle || "History").replace(/\s*\(.*\)\s*$/, "").trim();
    const suffix = store.config.histAsc ? (L.histOldest || " (oldest on top)")
                                        : (L.histNewest || " (newest on top)");
    titleEl.textContent = base + " " + suffix;
  }

  // 2) LibellÃ© du bouton (dans la langue)
  const btn = document.getElementById("histOrderBtn");
  if (btn){
    btn.textContent = store.config.histAsc ? (L.histOldestBtn) : (L.histNewestBtn);
  }
}

function rebuildHistSeatSelect(){
  const sel = document.getElementById("histSeat");
  if (!sel) return;
  const prev = (sel.value || "").trim().toUpperCase();

  // options : â€œâ€”â€ + siÃ¨ges occupÃ©s (triÃ©s)
  sel.innerHTML = '<option value="">â€”</option>';
  const keys = Object.keys(store.seats || {}).sort();
  for (const k of keys){
    const s = store.seats[k];
    if (s && s.occupied){
      const o = document.createElement("option");
      o.value = k; o.textContent = k;
      sel.appendChild(o);
    }
  }

  // si lâ€™ancienne sÃ©lection existe encore, on la restaure
  if ([...sel.options].some(o => o.value === prev)) sel.value = prev;
}

function updateHistoryControls(){
  const mode = document.getElementById("histMode")?.value || "all";
  const seatWrap = document.getElementById("histSeatWrap");
  const typeWrap = document.getElementById("histTypeWrap");
  if (seatWrap) seatWrap.style.display = (mode === "seat") ? "inline-flex" : "none";
  if (typeWrap) typeWrap.style.display = (mode === "type") ? "inline-flex" : "none";
  if (mode === "seat") rebuildHistSeatSelect();
  renderHistory();
}

// Ã©couteurs
document.getElementById("histMode")?.addEventListener("change", updateHistoryControls);
document.getElementById("histSeat")?.addEventListener("change", renderHistory);
document.getElementById("histType")?.addEventListener("change", renderHistory);
document.getElementById("histOrderBtn")?.addEventListener("click", ()=>{
  store.config.histAsc = !store.config.histAsc; // inverse lâ€™ordre
  save();
  renderHistory();
  updateHistoryTitle();
});

// init affichage au chargement
updateHistoryControls();

function refreshBadges(){
const lang = store.config.lang || "EN";
  store.inventory.hot_special = sumSPML();
  const setBadge=(key,val)=>{ const el=document.querySelector(`[data-badge="${key}"]`); if(el){ el.textContent=val; el.className="badge"; el.classList.add(val<=0?"zero":(val<=2?"low":"ok")); }};
  setBadge("plateaux", store.inventory.plateaux);
  setBadge("hot_viande", store.inventory.hot_viande);
  setBadge("hot_vege", store.inventory.hot_vege);
  setBadge("hot_special", store.inventory.hot_special);
  setBadge("hot_pre", sumPRE());
const bPre = document.querySelector('[data-badge="hot_pre"]');
if (bPre){
  bPre.title = (lang==="FR") ? "Total prÃ©commandes"
          : (lang==="DE") ? "Summe Vorbestellungen"
                          : "Pre-order sum";
}

// SPML add select
const addSel = $("#spmlAddCode");
if (!addSel) return;
const prevVal = addSel?.value || "";
const addTxt = (lang==="FR") ? "Choisirâ€¦" : (lang==="DE" ? "WÃ¤hlenâ€¦" : "Chooseâ€¦");
addSel.innerHTML = `<option value="">${addTxt}</option>`;
// (pas de refocus ici)

for(const c of SPML_CODES){ const o=document.createElement("option"); o.value=c; o.textContent=c; addSel.appendChild(o);}
// restaure la sÃ©lection si encore prÃ©sente
if ([...addSel.options].some(o => o.value === prevVal)) {
  addSel.value = prevVal;
}

  // SPML inventory table
  const spmlInv=$("#spmlInv"); spmlInv.innerHTML=""; const codes=Object.keys(store.inventory.spml).filter(c=>(store.inventory.spml[c]||0)>0);
  for(const code of codes){ const name=document.createElement("div"); name.textContent=code; spmlInv.appendChild(name);
    const badge=document.createElement("div"); badge.className="badge"; badge.dataset.badge="spml_"+code; badge.textContent=store.inventory.spml[code]; spmlInv.appendChild(badge);
    const ctrls=document.createElement("div"); ctrls.className="row";
    const minus=document.createElement("button"); minus.className="btn"; minus.textContent="â€“"; minus.addEventListener("click", ()=>adjInv("spml", code, -1));
    const plus=document.createElement("button"); plus.className="btn"; plus.textContent="+"; plus.addEventListener("click", ()=>adjInv("spml", code, +1));
    ctrls.appendChild(minus); ctrls.appendChild(plus); spmlInv.appendChild(ctrls); }
  // PrÃ©co inventory table
  renderPreInventory();
}
function renderPreInventory(){
  const preInv=$("#preInv"); preInv.innerHTML=""; const entries=Object.entries(store.inventory.pre).filter(([k,v])=>(v||0)>0).sort((a,b)=>a[0].localeCompare(b[0]));
  for(const [label,qty] of entries){ const name=document.createElement("div"); name.textContent=label; preInv.appendChild(name);
    const badge=document.createElement("div"); badge.className="badge"; badge.dataset.badge='pre_'+label; badge.textContent=qty; preInv.appendChild(badge);
    const ctrls=document.createElement("div"); ctrls.className="row";
    const minus=document.createElement("button"); minus.className="btn"; minus.textContent='â€“'; minus.addEventListener('click', ()=>adjInv('pre', label, -1));
    const plus=document.createElement("button"); plus.className="btn"; plus.textContent='+'; plus.addEventListener('click', ()=>adjInv('pre', label, +1));
    ctrls.appendChild(minus); ctrls.appendChild(plus); preInv.appendChild(ctrls);
  }
}

function adjInv(group,key,delta){ if(group==="spml"){ store.inventory.spml[key]=Math.max(0,(store.inventory.spml[key]||0)+delta);} else if(group==="pre"){ store.inventory.pre[key]=Math.max(0,(store.inventory.pre[key]||0)+delta);} else { store.inventory[key]=Math.max(0,(store.inventory[key]||0)+delta);} save(); }

// DÃ©crÃ©mentation sur CHOIX (commande)
const NORMAL_MAP={ viande:"hot_viande", vege:"hot_vege" }; // 'plateau' ne rÃ©serve rien au choix

function setNormalChoice(seat, uiVal){
  const L = I18N[store.config.lang || "EN"];

  // SÃ»retÃ©
  if (!seat.alloc || typeof seat.alloc !== "object") {
seat.alloc = { normalKey:null, spmlCode:null, preLabel:null, trayReserved:false };
  }

  const prev = seat.normalMeal || "";                         // <-- on capture l'ancien choix
  const newKey = (uiVal && uiVal !== "plateau") ? NORMAL_MAP[uiVal] : null;

  // 0) TOGGLE : si on reclique EXACTEMENT le mÃªme choix -> on annule
  if (uiVal === prev) {
    // si c'Ã©tait viande/vÃ©gÃ©, on rembourse l'inventaire
    if (prev !== "plateau" && seat.alloc.normalKey) {
      refundNormal(seat, seat.alloc.normalKey);
      seat.alloc.normalKey = null;
    }
   
    // si c'Ã©tait un plateau et qu'on avait rÃ©servÃ© un tray, on le rend
if (prev === "plateau" && seat.alloc.trayReserved) {
  store.inventory.plateaux = (store.inventory.plateaux || 0) + 1;
  seat.alloc.trayReserved = false;
}

    seat.normalMeal = "";
    save(); refreshBadges();
    return true;
  }

  // 1) On change de choix -> on rembourse ce qui Ã©tait allouÃ© (dans n'importe quel groupe)
  if (seat.alloc.spmlCode) { refundSpml(seat, seat.alloc.spmlCode); seat.spml=""; seat.alloc.spmlCode=null; }
  if (seat.alloc.preLabel) { refundPre(seat, seat.alloc.preLabel); seat.preLabel=""; seat.alloc.preLabel=null; }
  if (seat.alloc.normalKey){ refundNormal(seat, seat.alloc.normalKey); seat.alloc.normalKey=null; }

  // si on quittait un plateau rÃ©servÃ©, on rend le tray
if (prev === "plateau" && seat.alloc.trayReserved) {
  store.inventory.plateaux = (store.inventory.plateaux || 0) + 1;
  seat.alloc.trayReserved = false;
}

// 2) Plateau : on rÃ©serve 1 tray Ã  la commande
if (uiVal === "plateau") {
  if ((store.inventory.plateaux || 0) <= 0) {
    alert(L.alertNoTrays || "No more trays.");
    return false;
  }
  store.inventory.plateaux--;           // rÃ©serve dÃ¨s le choix
  seat.alloc.trayReserved = true;       // marquer la rÃ©servation
  seat.normalMeal = "plateau";
  save(); refreshBadges();
  return true;
}


  // 3) Viande / VÃ©gÃ© : on dÃ©crÃ©mente le stock correspondant
  if (newKey) {
if ((store.inventory[newKey] || 0) <= 0) {
  const human =
    uiVal==="viande" ? L.lblViande :
    uiVal==="vege"   ? L.lblVege   :
    uiVal==="plateau"? (L.trayShort || "Tray") : uiVal;
  alert(L.alertStock + " " + human + ".");
  return false;
}

    store.inventory[newKey]--;
    seat.alloc.normalKey = newKey;
    seat.normalMeal = uiVal;
    save(); refreshBadges();
    return true;
  }

  // 4) Aucun choix
  seat.normalMeal = "";
  save(); refreshBadges();
  return true;
}

function setSpmlChoice(seat, code){
const L = I18N[store.config.lang || "EN"];
  if(!seat.alloc || typeof seat.alloc!=="object") seat.alloc={ normalKey:null, spmlCode:null, preLabel:null };
  if(code){ code=code.trim(); }
  if(seat.alloc.normalKey){ refundNormal(seat, seat.alloc.normalKey); seat.normalMeal=""; seat.alloc.normalKey=null; }
  if(seat.alloc.preLabel){ refundPre(seat, seat.alloc.preLabel); seat.preLabel=""; seat.alloc.preLabel=null; }
  if(seat.alloc.spmlCode){ refundSpml(seat, seat.alloc.spmlCode); seat.spml=""; seat.alloc.spmlCode=null; }
if(code){ if((store.inventory.spml[code]||0)<=0){ alert(code + " " + L.alertDepleted); return false; }
    store.inventory.spml[code]--; seat.alloc.spmlCode=code; seat.spml=code; save(); refreshBadges(); }
  return true;
}
function setPreChoice(seat, label){
const L = I18N[store.config.lang || "EN"];
  if(!seat.alloc || typeof seat.alloc!=="object") seat.alloc={ normalKey:null, spmlCode:null, preLabel:null };
  if(label){ label=label.trim(); }
  if(seat.alloc.normalKey){ refundNormal(seat, seat.alloc.normalKey); seat.normalMeal=""; seat.alloc.normalKey=null; }
  if(seat.alloc.spmlCode){ refundSpml(seat, seat.alloc.spmlCode); seat.spml=""; seat.alloc.spmlCode=null; }
  if(seat.alloc.preLabel){ refundPre(seat, seat.alloc.preLabel); seat.preLabel=""; seat.alloc.preLabel=null; }
if(label){ if((store.inventory.pre[label]||0)<=0){ alert(label + " " + L.alertDepleted); return false; }
    store.inventory.pre[label]--; seat.alloc.preLabel=label; seat.preLabel=label; save(); refreshBadges(); }
  return true;
}
function refundNormal(seat, key){ store.inventory[key]=(store.inventory[key]||0)+1; save(); }
function refundSpml(seat, code){ store.inventory.spml[code]=(store.inventory.spml[code]||0)+1; save(); }
function refundPre(seat, label){ store.inventory.pre[label]=(store.inventory.pre[label]||0)+1; save(); }
function updateServeMealButtonState(){
  if (!modalSeat) return;
  const d = modalSeat.data;
  const isNone = !!(d.served && d.served.mealNone);
  const wasServed = !!(d.served && d.served.meal);

  const chosen = ($("#m_normalMeal")?.value || d.normalMeal || "").trim();
const hasChoice = !!d.spml || !!d.preLabel || ["viande","vege","plateau"].includes(chosen);

  const btn = $("#serveMeal");
  if (btn){
    // actif si dÃ©jÃ  servi (pour pouvoir annuler) OU sâ€™il y a un choix
    btn.disabled = !(wasServed || hasChoice);
    btn.title = btn.disabled ? "Choisissez un plat (normal, SPML ou prÃ©commande) pour servir" : "";
  }
const L = I18N[store.config.lang || "EN"];
if (btn){
  // actif si dÃ©jÃ  servi (pour pouvoir annuler) OU sâ€™il y a un choix
  btn.disabled = !(wasServed || hasChoice);
  btn.title = btn.disabled ? "Choisissez un plat (normal, SPML ou prÃ©commande) pour servir" : "";
  // ğŸ” libellÃ© dynamique
btn.textContent = (wasServed && !isNone)
  ? (L.cancelService || "Cancel service")
  : (L.serveMeal || "Serve main");

}

}

// Modal
let modalSeat=null;

function populateModalOptions(){
  const d = (modalSeat && modalSeat.data) ? modalSeat.data : {};

  // --- SPML ---
  const spmlSel = $("#m_spml");
  spmlSel.innerHTML = '<option value="">â€”</option>';
  for (const c of SPML_CODES){
    const inStock = (store.inventory.spml[c] || 0) > 0;
    const isChosen = d.spml === c;
    if (inStock || isChosen){
      const o = document.createElement('option');
      o.value = c;
      // Si dÃ©jÃ  allouÃ© mais stock 0, on lâ€™affiche quand mÃªme
      o.textContent = c;
      spmlSel.appendChild(o);
    }
  }

  // --- PrÃ©commandes ---
  const preSel = $("#m_pre");
  preSel.innerHTML = '<option value="">â€”</option>';
  for (const [label, qty] of Object.entries(store.inventory.pre)){
    const inStock = (qty || 0) > 0;
    const isChosen = d.preLabel === label;
    if (inStock || isChosen){
      const o = document.createElement('option');
      o.value = label;
o.textContent = label;
      preSel.appendChild(o);
    }
  }
}

function openSeatModal(row,col){
  const k=keyFor(row,col); modalSeat={row,col,key:k, data: seatObj(row,col)};
  // === MOVE BUTTON HANDLER ===
const moveBtn = document.getElementById("movePaxBtn");
if (moveBtn) {
  moveBtn.onclick = () => {
    startSeatMove(modalSeat.key);   // active mode move Ã  partir de ce siÃ¨ge
    closeSeatModal?.();             // ferme la fenÃªtre pour choisir la destination
  };
}

  // dÃ©sactive le bouton Move si le siÃ¨ge est vide
  if (moveBtn) {
    moveBtn.disabled = !modalSeat.data.occupied;
  }
updateSleepButtons();

$("#modalTitle").textContent = (I18N[store.config.lang||"EN"].seat) + " " + k;
  populateModalOptions();
  $("#m_status").value = modalSeat.data.status;
  $("#m_lang").value = modalSeat.data.lang || "";
  $("#m_spml").value = modalSeat.data.spml || "";
  $("#m_pre").value = modalSeat.data.preLabel || "";
  $("#m_normalMeal").value = modalSeat.data.normalMeal || "";
  $("#m_notes").value = modalSeat.data.notes || "";

// â€”â€”â€” Eat together with (select des siÃ¨ges occupÃ©s) â€”â€”â€”
const _eatWith = document.getElementById("m_eatWith");
if (_eatWith) {
  // (1) reconstruire les options : vide + siÃ¨ges occupÃ©s â‰  soi
  _eatWith.innerHTML = '<option value="">â€”</option>';
  const cur = (modalSeat && modalSeat.key) || "";
  const keys = Object.keys(store.seats || {}).sort();
  for (const k2 of keys){
    if (k2 === cur) continue;
    const s2 = store.seats[k2];
    if (s2 && s2.occupied) {
      const opt = document.createElement("option");
      opt.value = k2;
      opt.textContent = k2;
      _eatWith.appendChild(opt);
    }
  }
  // (2) valeur actuelle si existante
  _eatWith.value = modalSeat.data.eatWith || "";
  // (3) accessibilitÃ©/astuce i18n en title (le placeholder nâ€™existe pas sur select)
  const L = I18N[store.config.lang || "EN"] || I18N.EN;
  _eatWith.title = L.mdEatWithPh || "e.g. 12B";
}

  const L = I18N[store.config.lang || "EN"];
const _lblNotes = document.getElementById("mdNotes");
if (_lblNotes) _lblNotes.textContent = L.mdNotes || "Notes";
const _inNotes = document.getElementById("m_notes");
if (_inNotes && !_inNotes.placeholder) _inNotes.placeholder = "ex: DE only, no nuts";

  $("#m_aperoNotes").value = modalSeat.data.aperoNotes || "";
  $("#m_later").value = ""; $("#m_later_time").style.display="none";
const btnClear = document.getElementById("clearTrayBtn");
if (btnClear) {
  btnClear.disabled = !modalSeat.data?.served?.meal;

  const L = I18N[store.config.lang||"EN"];
  btnClear.textContent = modalSeat.data?.served?.trayCleared
    ? L.undoClearTray
    : L.clearTray;
}

const occ = $("#m_occ_chk"); if (occ) occ.checked = !!modalSeat.data.occupied;

updateServeMealButtonState();

const t = modalSeat.data.type || "normal";
const rAdult  = document.getElementById("m_type_adult");
const rChild  = document.getElementById("m_type_child");
const rInfant = document.getElementById("m_type_infant");
if (rAdult && rChild && rInfant) {
  rAdult.checked  = (t === "normal");
  rChild.checked  = (t === "child");
  rInfant.checked = (t === "infant");
}

const sl = $("#m_sleep_chk"); if (sl) sl.checked = !!modalSeat.data.sleep;
updateSleepButtons();

let ap = modalSeat.data.served.aperitif
  ? (L.apLabel + ": " + new Date(modalSeat.data.served.aperitif).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"}))
  : (L.apLabel + ": â€”");

let ml = modalSeat.data.served.meal
  ? (L.mealLabel + ": " + new Date(modalSeat.data.served.meal).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"}))
  : (L.mealLabel + ": â€”");

let tcServ = modalSeat.data.served.tc
  ? ((L.chips_tc || "Tea & Coffee") + ": " + new Date(modalSeat.data.served.tc).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"}))
  : ((L.chips_tc || "Tea & Coffee") + ": â€”");

// â• Ajout du libellÃ© boisson Ã  droite de lâ€™heure (si disponible)
if (modalSeat.data.served.aperitif) {
  const labAp = summarizeApDrink(modalSeat.data.apDrink, L, store.config.lang || "EN");
  if (labAp) ap += " â€” " + labAp + (L.ordered ? (" " + L.ordered) : "");
}
if (modalSeat.data.served.tc) {
  const labTc = summarizeApDrink(modalSeat.data.apDrink, L, store.config.lang || "EN");
  if (labTc) tcServ += " â€” " + labTc + (L.ordered ? (" " + L.ordered) : "");
}

// Ã‰crit dans la zone visible selon la phase
const mhMeal  = $("#m_history");        // #mealBlock
const mhApero = $("#m_history_apero");  // #aperoBlock
const mhTC    = $("#m_history_tc");     // #tcServeBlock

if (store.phase === "aperitif") {
  if (mhMeal)  mhMeal.textContent  = "";
  if (mhTC)    mhTC.textContent    = "";
  if (mhApero) mhApero.textContent = ap;
} else if (store.phase === "tc") {
  if (mhMeal)  mhMeal.textContent  = "";
  if (mhApero) mhApero.textContent = "";
  updateTCInline(modalSeat.key); // â† NOUVEAU

} else { // phase "repas"
  if (mhApero) mhApero.textContent = "";
  if (mhTC)    mhTC.textContent    = "";
  if (mhMeal)  mhMeal.textContent  = ml; // on garde lâ€™heure du plat servi
  updateMealDrinkInline(modalSeat.key);  // â† NOUVEAU : libellÃ© + heure via historique
}

const phase = store.phase;

// Panneaux principaux
document.getElementById("mealBlock")?.style && (document.getElementById("mealBlock").style.display = (phase === "repas") ? "block" : "none");
document.getElementById("aperoBlock")?.style && (document.getElementById("aperoBlock").style.display = (phase === "aperitif") ? "block" : "none");
document.getElementById("tcServeBlock")?.style && (document.getElementById("tcServeBlock").style.display = (phase === "tc") ? "block" : "none");

// Ligne â€œboisson de repasâ€
document.getElementById("mealDrinkServeRow")?.style && (document.getElementById("mealDrinkServeRow").style.display = (phase === "repas") ? "flex" : "none");

// Blocs de notes dynamiques
document.getElementById("aperoNotesBlock")?.style && (document.getElementById("aperoNotesBlock").style.display = (phase === "aperitif") ? "block" : "none");
document.getElementById("tcNotesBlock")?.style && (document.getElementById("tcNotesBlock").style.display = (phase === "tc") ? "block" : "none");

// Panneau boissons (listes) visible en apÃ©ritif ET en thÃ©-cafÃ©
document.getElementById("tcBlock")?.style && (document.getElementById("tcBlock").style.display = ((phase === "aperitif") || (phase === "tc")) ? "block" : "none");

// Horodateurs inline (basÃ©s sur l'historique)
if (store.phase === "tc" && modalSeat) updateTCInline(modalSeat.key);
else { const s = document.getElementById("mhTCInline"); if (s) s.textContent = "â€”"; }

if (store.phase === "repas" && modalSeat) updateMealDrinkInline(modalSeat.key);
else {
  const s = document.getElementById("mhMealDrinkInline");
  if (s) {
    const L = I18N[store.config.lang || "EN"] || I18N.EN;
    s.textContent = (L.mealDrinkTitle || "Meal drinks") + ": â€”";
  }
}

function arrangeModalByPhase(phase, L){
    updateModalPhaseNav(); // â† met Ã  jour les 4 emojis selon le mode actif
  const modal = document.querySelector(".modal");
    const leftCol  = document.querySelector(".two > div:first-child");
  const rightCol = document.getElementById("rightCol");
  const meal     = document.getElementById("mealBlock");
  const tc       = document.getElementById("tcBlock");
  let rightNotes = document.getElementById("rightNotes");
  if (!rightNotes) {
    rightNotes = document.createElement("div");
    rightNotes.id = "rightNotes";
    rightCol?.insertAdjacentElement("afterbegin", rightNotes);
  }

  // Remet tout Ã  l'Ã©tat "par dÃ©faut"
  // (tout revient dans rightCol, notes reviennent dans tcBlock)
  if (tc){
    // Rapatrier les blocs de notes dans tcBlock (si on les avait sortis)
    const apNotes = document.getElementById("aperoNotesBlock");
    const tcNotes = document.getElementById("tcNotesBlock");
    if (apNotes && apNotes.parentElement !== tc) tc.appendChild(apNotes);
    if (tcNotes && tcNotes.parentElement !== tc) tc.appendChild(tcNotes);
  }
  if (meal && meal.parentElement !== rightCol) rightCol?.appendChild(meal);
  if (tc   && tc.parentElement   !== rightCol) rightCol?.appendChild(tc);
  if (rightNotes) rightNotes.innerHTML = "";

  // Helper : Ã  gauche, ne garder visible quâ€™un bloc prÃ©cis (par id)
const showOnlyLeft = (keepId) => {
  const leftCol = document.querySelector(".two > div:first-child");
  if (!leftCol) return;
  Array.from(leftCol.children).forEach(ch => {
    ch.style.display = (ch.id === keepId || keepId === "__ALL__") ? "" : "none";
  });
};

  // Montrer/cacher colonnes selon phase
  const laterRow = document.getElementById("m_later")?.closest(".row");
  // Par dÃ©faut : tout visible
  if (rightCol) rightCol.style.display = "";
  if (laterRow) laterRow.style.display = "";

  if (phase === "fiche"){
    // FICHE CLIENT : uniquement la colonne gauche (passager)
    if (modal) modal.classList.add("mono");
    if (rightCol) rightCol.style.display = "none";
    if (laterRow) laterRow.style.display = "none"; // on cache "Serve later"
    showOnlyLeft("__ALL__"); // on montre tout (la fiche passager)
    ensureDrinkGridActive();
    return;
  }

  if (phase === "aperitif"){
    // APERITIF :
    // - Ã  gauche : listes de boissons (tcBlock)
    // - Ã  droite : uniquement les notes apÃ©ritif
    if (modal) modal.classList.remove("mono");
    if (tc && leftCol) leftCol.appendChild(tc);
    if (meal) meal.style.display = "none"; // pas de meal ici
    if (tc){
      const apNotes = document.getElementById("aperoNotesBlock");
      const tcNotes = document.getElementById("tcNotesBlock");
      if (tcNotes) tcNotes.style.display = "none";
      if (apNotes){
        apNotes.style.display = "block";
        rightNotes?.appendChild(apNotes);   // notes Ã  droite
        const lblAp = document.getElementById("mdAperoNotes");
if (lblAp) lblAp.textContent = (L.mdAperoNotes || "Drink / aperitif notes");
      }
      // titre = ApÃ©ritif
      const title = document.getElementById("tcTitle");
      if (title) title.textContent = L.tcTitle || "Aperitif";
    }
    showOnlyLeft("tcBlock"); // ne garder que le panneau boissons Ã  gauche
    ensureDrinkGridActive();
    reactivateDrinkGrid();
updateServeDrinkButtons();

    return;
  }

  if (phase === "tc"){
    // THE & CAFE :
    // - Ã  gauche : listes de boissons (tcBlock)
    // - Ã  droite : uniquement les notes TC
    if (modal) modal.classList.remove("mono");
    if (tc && leftCol) leftCol.appendChild(tc);
    if (meal) meal.style.display = "none";
    if (tc){
      const apNotes = document.getElementById("aperoNotesBlock");
      const tcNotes = document.getElementById("tcNotesBlock");
      if (apNotes) apNotes.style.display = "none";
      if (tcNotes){
        tcNotes.style.display = "block";
        rightNotes?.appendChild(tcNotes);   // notes Ã  droite
      }
      // titre = ThÃ© & CafÃ©
      const title = document.getElementById("tcTitle");
      if (title) title.textContent = L.chips_tc || "Tea & Coffee";
    }
    showOnlyLeft("tcBlock");
    ensureDrinkGridActive();
    reactivateDrinkGrid();
updateServeDrinkButtons();
    return;
  }

if (phase === "repas"){
  // REPAS :
  // - gauche : MEAL uniquement
  // - droite : tcBlock + boutons "Serve drink"
  if (modal) modal.classList.remove("mono");

  // Gauche = MEAL uniquement
  if (meal && leftCol){
    meal.style.display = "block";
    leftCol.appendChild(meal);
  }

  // Droite = Liste boissons + boutons de service
  if (tc && rightCol){
    rightCol.appendChild(tc);
    tc.style.display = "block";

// Masquer notes apÃ©ro/TC, mais AFFICHER les notes "meal drink"
const apNotes = document.getElementById("aperoNotesBlock");
const tcNotes = document.getElementById("tcNotesBlock");
if (apNotes) apNotes.style.display = "none";
if (tcNotes) tcNotes.style.display = "none";

// >>> AFFICHER + DÃ‰PLACER le bloc notes Meal Drink sous la liste boisson
const mdn = document.getElementById("mealDrinkNotesBlock");
if (mdn && rightCol) {
  mdn.style.display = "block";
  rightCol.appendChild(mdn);   // le place juste sous tcBlock
  const lbl = document.getElementById("mdMealDrinkNotes");
  if (lbl) lbl.textContent = (L.mealDrinkNotes || "Meal drink notes");
}

// Boutons Serve drink / Rien / horodateur (aprÃ¨s les notes)
const serveRow = document.getElementById("mealDrinkServeRow");
if (serveRow && rightCol) {
  serveRow.style.display = "flex";
  rightCol.appendChild(serveRow);
}

    // Titre cÃ´tÃ© droit
    const title = document.getElementById("tcTitle");
    if (title) title.textContent = (L.mealDrinkTitle || "Meal drinks");
  }
// (NOUVEAU) En mode repas, on rÃ©active aussi la grille boissons
if (document.getElementById("drinkGrid")) {
  resetDrinkUI();          // vide l'Ã©tat de sÃ©lection + re-affiche Hot/Soft/Alcohol
  initDrinkGrid();         // rattache les listeners sur les grosses pills
  document.querySelectorAll('#drinkGrid .pill').forEach(b => {
    b.disabled = false;
    b.style.pointerEvents = 'auto';
  });
}

  // Ã€ gauche on ne montre QUE le bloc Meal (pas Passenger)
reactivateDrinkGrid();
updateServeDrinkButtons();
  initDrinkGrid?.();          // â† AJOUT
  ensureDrinkGridActive();
  showOnlyLeft("mealBlock");
  return;
}

// (re)initialise la grille dâ€™emojis pour ApÃ©ritif / ThÃ© & CafÃ©
if (tc) tc.style.display = 'block';
resetDrinkUI();        // (ajoutÃ© Ã  lâ€™Ã©tape 2 ci-dessous)
initDrinkGrid();       // (existe dÃ©jÃ , on sâ€™assure quâ€™il est bien rappelÃ©)
document.querySelectorAll('#drinkGrid .pill').forEach(b=>{
  b.disabled = false;
  b.style.pointerEvents = 'auto';
});

  // Par dÃ©faut (autre phase)
  if (meal) meal.style.display = "block";
}

// Titre du panneau : â€œApÃ©ritifâ€ ou â€œThÃ© & CafÃ©â€
const tcTitle = document.getElementById("tcTitle");
if (tcTitle) tcTitle.textContent = (phase==="tc")
  ? (L.chips_tc || "Tea & Coffee")
  : (L.tcTitle   || "Aperitif");
const mdn = document.getElementById("mealDrinkNotesBlock");
if (mdn) mdn.style.display = "none";
  // --- NOUVEAU : rÃ©organiser les colonnes selon le mode ---
arrangeModalByPhase(phase, L);
// (nouveau) MAJ horodateur inline selon la phase courante
if (store.phase === "tc" && modalSeat) {
  updateTCInline(modalSeat.key);
} else if (store.phase === "repas" && modalSeat) {
  updateMealDrinkInline(modalSeat.key);
}

// RÃ©initialiser tous les menus boisson Ã  vide Ã  chaque ouverture
clearTcUI();

// Notes toujours vides Ã  l'ouverture
$("#m_aperoNotes").value = "";
$("#m_tcNotes").value    = "";

// Horodateurs inline (basÃ©s sur l'historique)
if (store.phase === "tc" && modalSeat) updateTCInline(modalSeat.key);
else { const s = document.getElementById("mhTCInline"); if (s) s.textContent = "â€”"; }

if (store.phase === "repas" && modalSeat) updateMealDrinkInline(modalSeat.key);
else {
  const s = document.getElementById("mhMealDrinkInline");
  if (s) {
    const L = I18N[store.config.lang || "EN"] || I18N.EN;
    s.textContent = (L.mealDrinkTitle || "Meal drinks") + ": â€”";
  }
}

updateServeMealButtonState();
updateServeDrinkButtons();   // â† AJOUT
$("#modalBack").style.display="flex";

}

function tc_showSub(cat){
  const ids = ["tc_cafe","tc_deca","tc_the","tc_digestif","tc_cocktail","tc_biere","tc_champagne","tc_vin","tc_soft","tc_chocolat"];
  ids.forEach(id => { const el = document.getElementById(id); if (el) el.style.display = "none"; });

  const milkSweet = document.getElementById("tc_milk_sweet");
  if (milkSweet) milkSweet.style.display = (["cafe","deca","the"].includes(cat) ? "block" : "none");

  const map = {
    cafe:"tc_cafe", deca:"tc_deca", the:"tc_the",
    digestif:"tc_digestif", cocktail:"tc_cocktail",
    biere:"tc_biere", champagne:"tc_champagne", vin:"tc_vin",
    soft:"tc_soft", chocolat:"tc_chocolat"
  };
  const id = map[cat];
  if (id){ const el = document.getElementById(id); if (el) el.style.display = "block"; }
}

function tc_updateSoftUI(){
  const t = document.getElementById("tc_soft_type")?.value || "";
  const rows = {
    eau: "tc_soft_eau_row",
    jus: "tc_soft_jus_row",
    coca:"tc_soft_coca_row",
    sprite:"tc_soft_sprite_row",
    tonic:"tc_soft_tonic_row"
  };
  // masque tout
  ["tc_soft_eau_row","tc_soft_jus_row","tc_soft_coca_row","tc_soft_sprite_row","tc_soft_tonic_row"].forEach(id=>{
    const el=document.getElementById(id); if (el) el.style.display="none";
  });
  // montre le bon
  const id = rows[t]; if (id){ const el=document.getElementById(id); if (el) el.style.display="flex"; }

  // jus tomate : montrer sel/poivre
  const jt = document.getElementById("tc_soft_jus")?.value || "";
  const saltRow = document.getElementById("tc_soft_salt_row");
  const pepRow  = document.getElementById("tc_soft_pepper_row");
  if (saltRow) saltRow.style.display = (t==="jus" && jt==="tomate") ? "inline-flex" : "none";
  if (pepRow)  pepRow.style.display  = (t==="jus" && jt==="tomate") ? "inline-flex" : "none";
}

function tc_updateGroupUI(){
  const g = document.getElementById("tc_group")?.value || "";
  // cache tout le monde
  document.getElementById("tc_alcool")?.style && (document.getElementById("tc_alcool").style.display = "none");
  document.getElementById("tc_chaud")?.style && (document.getElementById("tc_chaud").style.display = "none");
  // cache tous les sous-blocs existants
  tc_showSub(""); // cache #tc_soft/#tc_biere/#tc_vin/... via ta fonction existante
  // reset le sÃ©lecteur cachÃ©
  const catSel = document.getElementById("tc_cat");
  if (catSel) catSel.value = "";

  if (g === "soft"){
    // montre directement le bloc Soft existant + sÃ©lectionne la "catÃ©gorie" = soft
    tc_showSub("soft");
    document.getElementById("tc_soft_type") && (document.getElementById("tc_soft_type").value = "");
    if (catSel) catSel.value = "soft";
    tc_updateSoftUI();
  }
  else if (g === "alcool"){
    document.getElementById("tc_alcool")?.style && (document.getElementById("tc_alcool").style.display = "block");
  }
  else if (g === "chaud"){
    document.getElementById("tc_chaud")?.style && (document.getElementById("tc_chaud").style.display = "block");
  }

  updateServeDrinkButtons();
}

function tc_updateAlcoolUI(){
  const v = document.getElementById("tc_alcool_type")?.value || "";
  const catSel = document.getElementById("tc_cat");
  // cache tout
  tc_showSub("");
  // montre le bon sous-bloc (#tc_biere/#tc_vin/#tc_champagne/#tc_digestif)
  if (v){
    if (catSel) catSel.value = v;   // biere | vin | champagne | digestif
    tc_showSub(v);
  }else{
    if (catSel) catSel.value = "";
  }
  updateServeDrinkButtons();
}

function tc_updateChaudUI(){
  const v = document.getElementById("tc_chaud_type")?.value || "";
  const catSel = document.getElementById("tc_cat");
  // cache tout
  tc_showSub("");
  // rÃ¨gles : cafÃ©/dÃ©ca/thÃ© => lait/sucre ; thÃ© => affiche #tc_the ; chocolat => #tc_chocolat
  if (v){
    if (catSel) catSel.value = v;   // cafe | deca | the | chocolat
    tc_showSub(v);                  // gÃ¨re #tc_the / #tc_chocolat / etc.
    // lait/sucre seulement pour cafÃ©/dÃ©ca/thÃ© (ta fonction tc_showSub() le fait dÃ©jÃ  pour "the")
    const milkSweet = document.getElementById("tc_milk_sweet");
    if (milkSweet){
      milkSweet.style.display = (v==="cafe" || v==="deca" || v==="the") ? "block" : "none";
    }
  }else{
    if (catSel) catSel.value = "";
  }
  updateServeDrinkButtons();
}

function writeTcToUI(d){
  const ap = d.apDrink || {};
  const catSel = document.getElementById("tc_cat");
  if (catSel) catSel.value = ap.cat || "";

  tc_showSub(ap.cat || "");

  // gÃ©nÃ©riques
  const milk = document.getElementById("tc_milk"); if (milk) milk.value = ap.milk || "";
  const sw   = document.getElementById("tc_sweet"); if (sw) sw.value = ap.sweet || "";

  // thÃ©
  const theT = document.getElementById("tc_the_type"); if (theT) theT.value = ap.theType || "";

  // digestif
  const dsel = document.getElementById("tc_digestif_type");
  if (dsel) dsel.value = ap.digestif || "";
  const wOpt = document.getElementById("tc_whisky_opts");
  const bOpt = document.getElementById("tc_baileys_opts");
  if (wOpt) wOpt.style.display = (ap.digestif && ap.digestif.startsWith("whisky")) ? "flex" : "none";
  if (bOpt) bOpt.style.display = (ap.digestif === "baileys") ? "flex" : "none";
  const wPur = document.querySelector('input[name="tc_whisky_style"][value="pur"]');
  const wRck = document.querySelector('input[name="tc_whisky_style"][value="rocks"]');
  if (wPur && wRck){
    wPur.checked = (ap.whiskyStyle === "pur");
    wRck.checked = (ap.whiskyStyle === "rocks");
  }
const digIce = document.getElementById("tc_digestif_ice");
if (digIce) digIce.checked = !!ap.digIce;

const chIce = document.getElementById("tc_champ_ice"); if (chIce) chIce.checked = !!ap.champIce;
const vIce = document.getElementById("tc_vin_ice");    if (vIce) vIce.checked = !!ap.vinIce;

// Affiche/masque les options cognac selon le choix
const cOpt = document.getElementById("tc_cognac_opts");
if (cOpt) cOpt.style.display = (ap.digestif === "cognac") ? "flex" : "none";


  // biÃ¨re
  const beer = document.getElementById("tc_beer"); if (beer) beer.value = ap.beer || "";

  // vins
  const vr = document.getElementById("tc_vin_rouge"); if (vr) vr.value = ap.vinRouge || "";
  const vb = document.getElementById("tc_vin_blanc"); if (vb) vb.value = ap.vinBlanc || "";
  const vn = document.getElementById("tc_vin_notes"); if (vn) vn.value = ap.vinNotes || "";
enforceWineExclusivity(true);  // active la rÃ¨gle Ã  lâ€™ouverture de la modale

// cocktails
const csel = document.getElementById("tc_cocktail_type"); if (csel) csel.value = ap.cocktail || "";
const cIce = document.getElementById("tc_cocktail_ice");  if (cIce) cIce.checked = !!ap.cocktailIce;
const cLem = document.getElementById("tc_cocktail_lemon");if (cLem) cLem.checked = !!ap.cocktailLemon;
const cSalt = document.getElementById("tc_cocktail_salt");  if (cSalt) cSalt.checked = !!ap.cocktailSalt;
const cPep  = document.getElementById("tc_cocktail_pepper");if (cPep)  cPep.checked  = !!ap.cocktailPepper;

  // ==== SOFT ====
  if (ap.cat === "soft") {
    const t = document.getElementById("tc_soft_type"); if (t) t.value = ap.softType || "";
    // Affiche le bon sous-row
    tc_updateSoftUI();
    const eau = document.getElementById("tc_soft_eau"); if (eau) eau.value = ap.waterType || "";
    const jus = document.getElementById("tc_soft_jus"); if (jus) jus.value = ap.juiceType || "";
    const coca= document.getElementById("tc_soft_coca"); if (coca) coca.value = ap.cocaType || "";

["tc_soft_ice","tc_soft_lemon","tc_soft_ice2","tc_soft_lemon2","tc_soft_salt","tc_soft_pepper","tc_soft_ice4","tc_soft_lemon4","tc_soft_ice5","tc_soft_lemon5"].forEach(id=>{
  const el=document.getElementById(id); if (el){
    const map = {
      "tc_soft_ice":ap.softIce, "tc_soft_lemon":ap.softLemon,
      "tc_soft_ice2":ap.juiceIce, "tc_soft_lemon2":ap.juiceLemon,
      "tc_soft_salt":ap.juiceSalt, "tc_soft_pepper":ap.juicePepper,
      "tc_soft_ice4":ap.spriteIce, "tc_soft_lemon4":ap.spriteLemon,
      "tc_soft_ice5":ap.tonicIce,  "tc_soft_lemon5":ap.tonicLemon
    };
    el.checked = !!map[id];
  }
});

  }

  // ==== CHOCOLAT ====
  // rien Ã  remplir (juste l'affichage)

}

function readTcFromUI(d){
  if (!d.apDrink) d.apDrink = {};
  const ap = d.apDrink;

  // Cat
  if (drinkSel.cat==='soft') ap.cat='soft';
  else if (drinkSel.cat==='chaud') ap.cat=drinkSel.sub;          // cafe|deca|the|chocolat
  else if (drinkSel.cat==='alcool') ap.cat=drinkSel.sub;          // champagne|vin_rouge|vin_blanc|biere|cocktail|digestif
  else ap.cat='';

  // SOFT
  ap.softType   = (drinkSel.cat==='soft') ? (drinkSel.sub||'') : '';
  ap.waterType  = drinkSel.waterType||'';
  ap.cocaType   = drinkSel.cocaType||'';
  ap.juiceType  = drinkSel.juiceType||'';
  ap.softIce    = !!drinkSel.softIce;   ap.softLemon = !!drinkSel.softLemon;
  ap.spriteIce  = !!drinkSel.spriteIce; ap.spriteLemon = !!drinkSel.spriteLemon;
  ap.tonicIce   = !!drinkSel.tonicIce;  ap.tonicLemon = !!drinkSel.tonicLemon;
  ap.juiceIce   = !!drinkSel.juiceIce;  ap.juiceLemon = !!drinkSel.juiceLemon;
  ap.juiceSalt  = !!drinkSel.juiceSalt; ap.juicePepper = !!drinkSel.juicePepper;
  ap.juiceApfelschorle = !!drinkSel.juiceApfelschorle;

  // CHAUD
  if (ap.cat==='cafe' || ap.cat==='deca' || ap.cat==='the' || ap.cat==='chocolat'){
    ap.milk  = drinkSel.milk||'';
    ap.sweet = drinkSel.sweet||'';
    ap.theType = (ap.cat==='the') ? (drinkSel.theType||'') : '';
    ap.theLemon = !!drinkSel.theLemon;
    ap.choco = (ap.cat==='chocolat');
  } else { ap.milk=''; ap.sweet=''; ap.theType=''; ap.theLemon=false; ap.choco=false; }

  // ALCOOL
  ap.champIce = (ap.cat==='champagne') ? !!drinkSel.champIce : false;
  ap.champMimosa = (ap.cat==='champagne') ? !!drinkSel.champMimosa : false;
  ap.beer = (ap.cat==='biere') ? (drinkSel.beer||'') : '';
  ap.vinRouge = (ap.cat==='vin_rouge') ? (drinkSel.vinRouge||'') : '';
  ap.vinBlanc = (ap.cat==='vin_blanc') ? (drinkSel.vinBlanc||'') : '';
  ap.vinIce   = (ap.cat==='vin_rouge' || ap.cat==='vin_blanc') ? !!drinkSel.vinIce : false;
  ap.digestif = (ap.cat==='digestif') ? (drinkSel.digestif||'') : '';
  ap.digIce   = (ap.cat==='digestif') ? !!drinkSel.digIce : false;
ap.cocktail      = (ap.cat==='cocktail') ? (drinkSel.cocktail||'') : '';
ap.campariMix    = (ap.cat==='cocktail' && drinkSel.cocktail==='campari') ? (drinkSel.campariMix||'') : '';
ap.cocktailSP    = (ap.cat==='cocktail' && drinkSel.cocktail==='bloody_mary') ? !!drinkSel.cocktailSP : false;
ap.virginMary    = (ap.cat==='cocktail' && drinkSel.cocktail==='bloody_mary') ? !!drinkSel.virginMary : false;
ap.cocktailIce   = (ap.cat==='cocktail') ? !!drinkSel.cocktailIce   : false;
ap.cocktailLemon = (ap.cat==='cocktail') ? !!drinkSel.cocktailLemon : false;
  ap.cocktailSalt  = (ap.cat==='cocktail') ? !!drinkSel.cocktailSalt : false;
  ap.cocktailPepper= (ap.cat==='cocktail') ? !!drinkSel.cocktailPepper : false;
}

function closeSeatModal(){ 
    clearTcUI();
    const _an = document.getElementById("m_aperoNotes"); if (_an) _an.value = "";
const _tn = document.getElementById("m_tcNotes");    if (_tn) _tn.value = "";
const _md = document.getElementById("m_mealDrinkNotes"); if (_md) _md.value = "";    
$("#modalBack").style.display="none"; modalSeat=null; }

function persistModal(){
  if(!modalSeat) return;
  const d = modalSeat.data;

  // nouveaux contrÃ´les
  d.occupied = !!document.getElementById("m_occ_chk")?.checked;
  const typeRadio = document.querySelector('input[name="m_type"]:checked');
  if (typeRadio) d.type = typeRadio.value; // "normal" | "child" | "infant"
const sl = document.getElementById("m_sleep_chk");
if (sl) d.sleep = !!sl.checked;     // sinon: on ne touche pas d.sleep

  // les autres restent identiques
  d.status = $("#m_status").value;
  d.lang   = $("#m_lang").value;
  d.notes  = $("#m_notes").value.trim();
// Notes boissons = usage unique â†’ ne pas persister sur le siÃ¨ge
d.aperoNotes = "";
d.tcNotes    = "";d

const ew = document.getElementById("m_eatWith");
if (ew) {
  // normalise en MAJ, sans espaces
  modalSeat.data.eatWith = (ew.value || "").trim().toUpperCase();
  const partnerKey = modalSeat.data.eatWith;
if (partnerKey && store.seats[partnerKey]){
  ensureSeatShape(store.seats[partnerKey]);
  store.seats[partnerKey].eatWith = modalSeat.key;
}
// si on supprime la valeur â†’ on efface aussi cÃ´tÃ© partenaire
if (!partnerKey && d.eatWith && store.seats[d.eatWith]){
  store.seats[d.eatWith].eatWith = "";
}
}

save(); renderSeatmap();

// Si l'historique est en mode â€œPar siÃ¨geâ€, on met Ã  jour la liste
try {
  const mode = document.getElementById("histMode")?.value;
  if (mode === "seat" && typeof rebuildHistSeatSelect === "function") rebuildHistSeatSelect();
} catch(_) {}

renderServiceFlow();
// AprÃ¨s avoir sauvegardÃ© / rerendu, s'assurer que la grille est bien active si on est dans la modale
ensureDrinkGridActive();

}


$("#m_normalMeal").addEventListener("change", ()=>{ if(!modalSeat) return; const val=$("#m_normalMeal").value; setNormalChoice(modalSeat.data, val); save(); renderSeatmap(); renderServiceFlow(); updateServeMealButtonState();}); 
$("#m_spml").addEventListener("change", ()=>{ if(!modalSeat) return; const val=$("#m_spml").value; setSpmlChoice(modalSeat.data, val); save(); renderSeatmap(); renderServiceFlow(); updateServeMealButtonState(); });
$("#m_pre").addEventListener("change", ()=>{ if(!modalSeat) return; const val=$("#m_pre").value; setPreChoice(modalSeat.data, val); save(); renderSeatmap(); renderServiceFlow(); updateServeMealButtonState();});

// === Seat MOVE logic ===
let movingFrom = null;

function parseSeatKey(key){
  const m = /^(\d+)([A-Z])$/i.exec((key||"").trim());
  if(!m) return [null,null];
  return [parseInt(m[1],10), m[2].toUpperCase()];
}

function quickToggleSleep(){
  if (!modalSeat) return;
  // 1) on toggle directement la donnÃ©e
  modalSeat.data.sleep = !modalSeat.data.sleep;

  // 2) si une checkbox existe encore un jour, on la garde en sync, sinon tant pis
  const chk = document.getElementById("m_sleep_chk");
  if (chk) chk.checked = modalSeat.data.sleep;

  // 3) on persiste + rafraÃ®chit lâ€™UI
  save();
  renderSeatmap();
  renderServiceFlow();
  updateSleepButtons();
}

function updateSleepButtons(){
  const chk = document.getElementById("m_sleep_chk");
  const active = (chk ? chk.checked : !!(modalSeat && modalSeat.data && modalSeat.data.sleep));
  ["sleepModalBtn"].forEach(id=>{
    const btn = document.getElementById(id);
    if (btn){
      if (active) btn.classList.add("active");
      else btn.classList.remove("active");
    }
    // Maintient le tooltip dans la bonne langue
{
  const L = I18N[store.config.lang || "EN"] || I18N.EN;
  ["sleepMealBtn","sleepAperoBtn","sleepTCBtn","sleepModalBtn"].forEach(id=>{
    const btn = document.getElementById(id);
    if (btn) btn.title = L.mdSleepTxt || "Sleep";
  });
}
  });
}

function setMoveUI(on){
  const grid = document.getElementById("seatgrid");
  if (grid) grid.classList.toggle("moving", !!on);
  const L = I18N[store.config.lang || "EN"];
  const title = document.getElementById("seatmapTitle");
  if (title){
    if (on){
      title.textContent = (L.pickDestSeat || "Select destination seat") + (movingFrom ? " â€” " + movingFrom : "");
    } else {
      // remet le titre normal de la seatmap
      if (typeof updateSeatmapTitle === "function") updateSeatmapTitle();
    }
  }
}

// appelÃ© par le bouton "Move" dans la modale siÃ¨ge
function startSeatMove(fromKey){
  movingFrom = fromKey;
  setMoveUI(true);
  const L = I18N[store.config.lang || "EN"];
if (typeof addHistoryEvt === "function"){
  addHistoryEvt({ type: "seatMoveStart", from: fromKey });
}
}

// ESC pour annuler le mode dÃ©placement
document.addEventListener("keydown", (e)=>{
  if (e.key === "Escape" && movingFrom){
    movingFrom = null;
    setMoveUI(false);
    if (typeof updateSeatmapTitle === "function") updateSeatmapTitle();
  }
});

function isSeatEmpty(seat){
  return !seat || !seat.occupied;
}

function performMoveOrSwap(fromKey, toKey){
  if (!fromKey || !toKey || fromKey === toKey) return;
  const from = ensureSeatShape(store.seats[fromKey] || {});
  const to   = ensureSeatShape(store.seats[toKey]   || {});
  const L = I18N[store.config.lang || "EN"];

  const retargetEatWith = (oldKey, newKey) => {
    Object.keys(store.seats || {}).forEach(k => {
      const s = store.seats[k];
      if (!s) return;
      ensureSeatShape(s);
      if (s.eatWith === oldKey) s.eatWith = newKey;
    });
  };

  if (isSeatEmpty(to)){
    // MOVE
    store.seats[toKey]   = JSON.parse(JSON.stringify(from));
    store.seats[fromKey] = ensureSeatShape({});
if (typeof addHistoryEvt === "function"){
  addHistoryEvt({ type: "seatMoved", from: fromKey, to: toKey });
}
  } else {
    // SWAP
    const tmp = JSON.parse(JSON.stringify(to));
    store.seats[toKey]   = JSON.parse(JSON.stringify(from));
    store.seats[fromKey] = tmp;
if (typeof addHistoryEvt === "function"){
  addHistoryEvt({ type: "seatSwapped", a: fromKey, b: toKey });
}
  }

  // ğŸ” recÃ¢ble les couples "eat together"
  if (isSeatEmpty(to)) {
    retargetEatWith(fromKey, toKey);
  } else {
    const TMP = "__SWAP_TMP__";
    retargetEatWith(fromKey, TMP);
    retargetEatWith(toKey, fromKey);
    retargetEatWith(TMP, toKey);
  }

  if (typeof save === "function") save();
  if (typeof renderSeatmap === "function") renderSeatmap();
  if (typeof renderServiceFlow === "function") renderServiceFlow();
}


function onSeatClick(key){
  // clÃ© normalisÃ©e (ex: "12A")
  key = (key || "").toUpperCase();

  // â€”â€”â€” Mode dÃ©placement actif ? â€”â€”â€”
  if (movingFrom){
    const from = movingFrom;
    movingFrom = null;
    setMoveUI(false);

    if (key && key !== from){
      // MOVE ou SWAP
      performMoveOrSwap(from, key);
      return;
    }

    // MÃªme siÃ¨ge re-cliquÃ© â†’ rouvrir la modale d'origine
    const [r0, c0] = parseSeatKey(from);
    if (r0 && c0){
      openSeatModal(r0, c0);
      document.getElementById("modalBack").style.display = "flex";
    }
    return;
  }

  // â€”â€”â€” Sinon : simple ouverture de modale â€”â€”â€”
  const [r, c] = parseSeatKey(key);
  if (r && c){
    openSeatModal(r, c);
    document.getElementById("modalBack").style.display = "flex";
  }
}

function summarizeApDrink(ap, L, lang) {
    // --- Normalisation des clÃ©s boissons ---
if (ap) {
  // BiÃ¨re
  if (ap.beer === "calvinus_blanche") ap.beer = "calvinus";
  if (ap.beer && ap.beer.startsWith("leermond")) ap.beer = "leermond";

  // Vin
  if (ap.vin === "rouge" && !ap.vinRouge) {
    ap.vinRouge = ap.vinOrigine || "suisse";
  }
  if (ap.vin === "blanc" && !ap.vinBlanc) {
    ap.vinBlanc = ap.vinOrigine || "suisse";
  }
}
    const push = (txt)=>{ if (typeof P!=='undefined') P.push(txt); else if (typeof out!=='undefined') out.push(txt); };
  if (!ap || !ap.cat) return "";
  const P = [];
  const addIce   = f => { if (f) P.push(L.tcIce   || "Ice");   };
  const addLemon = f => { if (f) P.push(L.tcLemon || "Lemon"); };

  // Helpers lait/sucre (pour chaud)
  const milkLabel = (v) => {
    if (v === "creme")   return L.tcMilkCreme;
    if (v === "avoine")  return L.tcMilkAvoine;
    if (v === "lait")    return L.tcMilkLait;
    if (v === "none")    return L.tcMilkNone;
    return "";
  };
  const sweetLabel = (v) => {
    if (v === "sucre")      return L.tcSweetSugar;
    if (v === "succedane")  return L.tcSweetSub;
    if (v === "none")       return L.tcSweetNone;
    return "";
  };

  switch (ap.cat) {
    // ===== CHAUD =====
    case "cafe":
      P.push(L.tcCatCafe); 
      if (ap.milk)  { const m = milkLabel(ap.milk);   if (m) P.push(m); }
      if (ap.sweet) { const s = sweetLabel(ap.sweet); if (s) P.push(s); }
      break;

    case "deca":
      P.push(L.tcCatDeca);
      if (ap.milk)  { const m = milkLabel(ap.milk);   if (m) P.push(m); }
      if (ap.sweet) { const s = sweetLabel(ap.sweet); if (s) P.push(s); }
      break;

    case "the":
        // --- Eau chaude ---
if (ap.theType === "hotwater") {
  P.push(L.tcHotWater || "Eau chaude");
  if (ap.theLemon) P.push(L.tcLemon || "Citron");
  break; // on sort ici pour ne pas afficher "thÃ©"
}
      P.push(L.tcCatThe);
      if (ap.theType === "english") P.push(L.tcTeaEnglish);
      else if (ap.theType === "vert") P.push(L.tcTeaVert);
      else if (ap.theType === "menthe") P.push(L.tcTeaMenthe);
      else if (ap.theType === "camomille") P.push(L.tcInfCam);
      if (ap.milk)  { const m = milkLabel(ap.milk);   if (m) P.push(m); }
      if (ap.sweet) { const s = sweetLabel(ap.sweet); if (s) P.push(s); }
      if (ap.theLemon) P.push(L.tcLemon || "Lemon");
      break;

    case "infusion":
      P.push(L.tcCatInf);
      // fixe (camomille)
      P.push(L.tcInfCam);
      if (ap.milk)  { const m = milkLabel(ap.milk);   if (m) P.push(m); }
      if (ap.sweet) { const s = sweetLabel(ap.sweet); if (s) P.push(s); }
      break;

    case "chocolat":
      // Demande: afficher "Caotina" directement
      P.push(L.tcChocoBrand || "Caotina");
      break;

    // ===== ALCOOL =====
    case "digestif":
  P.push(L.tcCatDig);

  if (ap.digestif === "whisky_jw")      P.push(L.tcDigJW);
  else if (ap.digestif === "whisky_jb") P.push(L.tcDigJB);
  else if (ap.digestif === "cognac")    P.push(L.tcDigCognac);
  else if (ap.digestif === "baileys")   P.push(L.tcDigBaileys);

  // Compat historique si jamais whiskyStyle existe encore,
  // sinon on utilise la case Ã  cocher gÃ©nÃ©rique "Ice"
  if (ap.whiskyStyle === "pur")       P.push(L.tcPur);
  else if (ap.whiskyStyle === "rocks") P.push(L.tcRocks);
  else                                 addIce(!!ap.digIce);

  break;

case "biere": {
  P.push(L.tcCatBeer || "Beer");
  const mapBeer = {
    quoellfrisch: L.tcBeerQ || "QuÃ¶llfrisch Lager",
    calvinus:     L.tcBeerC || "Calvinus Blanche",
    leermond:     L.tcBeerL || "Leermond (alcohol-free)"
  };
  if (ap.beer && mapBeer[ap.beer]) P.push(mapBeer[ap.beer]);
  else if (ap.beer) P.push(ap.beer);
  break;
}

    case "champagne":
      P.push(L.tcCatChamp);
      addIce(!!ap.champIce);
      if (ap.champMimosa) P.push("ğŸŠ Mimosa");
      break;

case "vin_rouge": {
  // CatÃ©gorie + couleur
  P.push(L.tcCatVin || "Wines");
  let label = (L.tcRed || "Red");

  // Origine (ğŸ‡¨ğŸ‡­/ğŸŒ)
  const origin = (ap.vinRouge === "suisse")
    ? (L.tcCH || "Swiss")
    : (ap.vinRouge === "etranger")
      ? (L.tcForeign || "Foreign")
      : "";
  if (origin) label += " â€” " + origin;

  // Notes facultatives
  if (ap.vinNotes) label += ` (${ap.vinNotes})`;

  P.push(label);
  // Optionnel: glaÃ§ons si tu l'as prÃ©vu
  if (ap.vinIce) P.push(L.tcIce || "Ice");
  break;
}

case "vin_blanc": {
  P.push(L.tcCatVin || "Wines");
  let label = (L.tcWhite || "White");

  const origin = (ap.vinBlanc === "suisse")
    ? (L.tcCH || "Swiss")
    : (ap.vinBlanc === "etranger")
      ? (L.tcForeign || "Foreign")
      : "";
  if (origin) label += " â€” " + origin;

  if (ap.vinNotes) label += ` (${ap.vinNotes})`;

  if (ap.vinIce) P.push(L.tcIce || "Ice");
  P.push(label);
  break;
}

case "cocktail": {
  P.push(L.tcCocktail || "Cocktail");
  const c = ap.cocktail || "";

  if (c === "gin_tonic")       P.push(L.tcGinTonic   || "Gin Tonic");
  else if (c === "cuba_libre") P.push(L.tcCubaLibre  || "Cuba Libre");
  else if (c === "screwdriver")P.push(L.tcScrewDriver|| "Screw Driver");
else if (c === "bloody_mary"){
  P.push(L.tcBloodyMary || "Bloody Mary");
  if (ap.virginMary) P.push(L.tcVirginMary || "Virgin Mary");
  if (ap.cocktailSP)  P.push([L.tcSalt||"Salt", L.tcPepper||"Pepper"].join(" + "));
  }
  else if (c === "campari"){
    P.push("Campari");
    if      (ap.campariMix === "orange") P.push(L.tcJuiceOrange || "Orange");
    else if (ap.campariMix === "soda")   P.push(L.tcSoda        || "Soda");
  }

  if (ap.cocktailIce)   P.push(L.tcIce   || "Ice");
  if (ap.cocktailLemon) P.push(L.tcLemon || "Lemon");
  break;
}

    // ===== SOFT =====
    case "soft":
      if (ap.softType === "eau") {
        P.push(L.tcLblWater);
        if (ap.waterType === "plate")   P.push(L.tcWaterStill);
        else if (ap.waterType === "gazeuse") P.push(L.tcWaterSpark);
        addIce(!!ap.softIce);
        addLemon(!!ap.softLemon);
      } else if (ap.softType === "jus") {
        P.push(L.tcLblJuice);
if (ap.juiceType === "pomme") {
  if (ap.juiceApfelschorle) P.push("Apfelschorle");
  else P.push(L.tcJuiceApple || "Apple");
}
        else if (ap.juiceType === "orange") P.push(L.tcJuiceOrange);
        else if (ap.juiceType === "tomate") P.push(L.tcJuiceTomato);
        addIce(!!ap.juiceIce);
        addLemon(!!ap.juiceLemon);
if (ap.juiceType === "tomate") {
  if (ap.juiceSalt || ap.juicePepper) {
    P.push([L.tcSalt||"Salt", L.tcPepper||"Pepper"].join(" + "));
  }
}
} else if (ap.softType === "coca") {
  P.push("Coca-Cola", ap.cocaType==="zero" ? "Zero" : (ap.cocaType==="normal" ? "Classic" : ""));
  addIce(!!ap.softIce);
  addLemon(!!ap.softLemon);

      } else if (ap.softType === "sprite") {
        P.push("Sprite");
        addIce(!!ap.spriteIce);
        addLemon(!!ap.spriteLemon);
      } else if (ap.softType === "tonic") {
        if (ap.tonicIce)   P.push(L.tcIce);
        if (ap.tonicLemon) P.push(L.tcLemon || "Citron");
        P.unshift("Tonic");

      }
      break;
  }

  return P.join(", ");
}


document.getElementById("serveAperitif")?.addEventListener("click", () => {
  if (!modalSeat) return;
  const L = I18N[store.config.lang || "EN"];
  const d = modalSeat.data;
  if (!d.occupied) { alert(L.alertSeatEmpty); return; }

  // 1) Relire lâ€™UI pour Ãªtre sÃ»r dâ€™avoir la derniÃ¨re sÃ©lection
  readTcFromUI(d);

  // 2) Horodatage figÃ© au premier service seulement
  if (!d.served.aperitif) d.served.aperitif = Date.now();

  // 3) Garder lâ€™OBJET complet dans lâ€™historique pour (re)traduire plus tard
  const apCopy = JSON.parse(JSON.stringify(d.apDrink || {}));

  // 4) Pousser un event Ã  CHAQUE clic (pas dâ€™annulation)
  console.log("DEBUG SERVE AP:", d.apDrink, summarizeApDrink(d.apDrink, I18N[store.config.lang||"EN"], store.config.lang));

addHistoryEvt({
  type: "apServed",
  seat: modalSeat.key,
  ap: apCopy,                         // <- lâ€™objet boisson complet
  notes: ($("#m_aperoNotes").value || d.aperoNotes || "")
});

  // â† vider tout de suite les champs de notes (UI + data)
  const _an1 = document.getElementById("m_aperoNotes"); if (_an1) _an1.value = "";
  const _tn1 = document.getElementById("m_tcNotes");    if (_tn1) _tn1.value = "";
  d.aperoNotes = "";
  d.tcNotes    = "";

  playBeep();
  save();
resetDrinkUI(true);
reactivateDrinkGrid();
initDrinkGrid?.();
 updateServeDrinkButtons();
openSeatModal(modalSeat.row, modalSeat.col);
  renderSeatmap();
  renderServiceFlow();
});

document.getElementById("serveTC")?.addEventListener("click", () => {
  if (!modalSeat) return;
  const L = I18N[store.config.lang || "EN"];
  const d = modalSeat.data;
  if (!d.occupied) { alert(L.alertSeatEmpty); return; }

  // 1) Relire lâ€™UI (mÃªmes contrÃ´les)
  readTcFromUI(d);

  // 2) Horodatage figÃ© au premier service TC
if (store.phase === "tc" && !d.served.tc) d.served.tc = Date.now();

  // 3) Stocker l'objet apDrink pour traduction dynamique
  const apCopy = JSON.parse(JSON.stringify(d.apDrink || {}));

  // 4) Pousser un event Ã  CHAQUE clic (pas dâ€™annulation)
  console.log("DEBUG SERVE AP:", d.apDrink, summarizeApDrink(d.apDrink, I18N[store.config.lang||"EN"], store.config.lang));

    const notesVal = (store.phase === "repas")
    ? (document.getElementById("m_mealDrinkNotes")?.value || "")
    : (document.getElementById("m_tcNotes")?.value || d.tcNotes || "");

 addHistoryEvt({
  type: "tcServed",
  seat: modalSeat.key,
    ts: Date.now(),  
  ap: apCopy,
  notes: notesVal,
  ctx: store.phase            // â† AJOUT : pour diffÃ©rencier â€œrepasâ€
});

  // â† vider tout de suite les champs de notes (UI + data)
  const _an2 = document.getElementById("m_aperoNotes"); if (_an2) _an2.value = "";
  const _tn2 = document.getElementById("m_tcNotes");    if (_tn2) _tn2.value = "";
  const _mdn2 = document.getElementById("m_mealDrinkNotes"); if (_mdn2) _mdn2.value = "";
  d.aperoNotes = "";
  d.tcNotes    = "";

  playBeep();
  save();
    // -- MAJ horodateur inline selon phase
  if (store.phase === "tc") {
    updateTCInline(modalSeat.key);
  } else if (store.phase === "repas") {
    updateMealDrinkInline(modalSeat.key);
  }
resetDrinkUI(true);
reactivateDrinkGrid();
initDrinkGrid?.();
 updateServeDrinkButtons();
openSeatModal(modalSeat.row, modalSeat.col);
  renderSeatmap();
  renderServiceFlow();
});

// --- RIEN en APERITIF (ne pousse rien dans l'historique) ---
document.getElementById("serveAperitifNone")?.addEventListener("click", ()=>{
  if (!modalSeat) return;
  const L = I18N[store.config.lang || "EN"];
  const d = modalSeat.data;
  if (!d.occupied){ alert(L.alertSeatEmpty); return; }

  // Marquer le siÃ¨ge "servi" pour l'apÃ©ritif, sans ajouter d'Ã©vÃ¨nement d'historique
  if (!d.served.aperitif) d.served.aperitif = Date.now();

  playBeep();
  save();
resetDrinkUI(true);
reactivateDrinkGrid();
initDrinkGrid?.();
openSeatModal(modalSeat.row, modalSeat.col);
  renderSeatmap();
  renderServiceFlow();
});

// --- RIEN en THÃ‰ & CAFÃ‰ (ne pousse rien dans l'historique) ---
document.getElementById("serveTCNone")?.addEventListener("click", ()=>{
  if (!modalSeat) return;
  const L = I18N[store.config.lang || "EN"];
  const d = modalSeat.data;
  if (!d.occupied){ alert(L.alertSeatEmpty); return; }

  // Marquer le siÃ¨ge "servi" pour TC, sans ajouter d'Ã©vÃ¨nement d'historique
  if (!d.served.tc) d.served.tc = Date.now();

  playBeep();
  save();
resetDrinkUI(true);
reactivateDrinkGrid();
initDrinkGrid?.();
 updateServeDrinkButtons();
openSeatModal(modalSeat.row, modalSeat.col);
  renderSeatmap();
  renderServiceFlow();
});

// --- REPAS : boutons "boisson de repas" rÃ©utilisent la logique TC ---
document.getElementById("serveMealDrink")?.addEventListener("click", () => {
  if (!modalSeat) return;
  const seatKey = modalSeat.key;
  const d = modalSeat.data;
  const L = I18N[store.config.lang || "EN"];
if (!d.occupied) { alert(L.alertSeatEmpty); return; }

  // 1) Lire l'UI boisson (remplit d.apDrink depuis l'Ã©tat courant)
  if (typeof readTcFromUI === "function") readTcFromUI(d);

  // 2) Ajouter l'event d'historique (contexte "repas")
  const notes = (document.getElementById("m_mealDrinkNotes")?.value || "").trim();
  addHistoryEvt?.({
    type: "tcServed",
    seat: seatKey,
    ts: Date.now(),
    ctx: "repas",
    ap: d.apDrink ? JSON.parse(JSON.stringify(d.apDrink)) : null,
    notes
  });
playBeep();
  save?.();

  // 3) RafraÃ®chir l'affichage inline & reset UI pour enchaÃ®ner
  // -- MAJ horodateur inline selon phase
  if (store.phase === "tc") {
    updateTCInline(seatKey);
  } else if (store.phase === "repas") {
    updateMealDrinkInline(seatKey);
  }
  if (typeof resetDrinkUI === "function") resetDrinkUI(true);
  if (typeof updateServeDrinkButtons === "function") updateServeDrinkButtons(); // â† AJOUT
  if (typeof reopenSameSeat === "function") reopenSameSeat();
});

document.getElementById("serveMealDrinkNone")?.addEventListener("click", ()=>{
  document.getElementById("serveTCNone")?.click();
});

document.getElementById("sleepModalBtn")?.addEventListener("click", quickToggleSleep);
// === Liaison UI "ThÃ© & CafÃ©" ===
function tc_save(){ /* on ne persiste plus rien tant que pas â€œServiâ€ */ }

// === NAVIGATION ENTRE MODES DANS LA MODALE ===
function reopenSameSeat(){
  if (!modalSeat) return;
  // RÃ©aligne les chips du header avec la phase choisie
  document.querySelectorAll('#phaseChips .chip').forEach(c=>c.classList.remove('active'));
  document.querySelector(`#phaseChips .chip[data-phase="${store.phase}"]`)?.classList.add('active');
  // Rouvre la mÃªme modale dans le nouveau mode
resetDrinkUI(true);
 updateServeDrinkButtons();
 reactivateDrinkGrid();
initDrinkGrid?.();
openSeatModal(modalSeat.row, modalSeat.col);
  renderSeatmap();
  renderServiceFlow();
}

// [AJOUT] Clic sur les 4 emojis = changer de mode puis rouvrir la mÃªme modale
[
  ["navFicheBtn","fiche"],
  ["navAperoBtn","aperitif"],
  ["navMealBtn","repas"],
  ["navTCBtn","tc"],
].forEach(([id, phase]) => {
  const el = document.getElementById(id);
  if (!el) return;
  el.addEventListener("click", (e) => {
    e.preventDefault();
    if (store.phase === phase) return;  // dÃ©jÃ  sur ce mode
    store.phase = phase;
    save();
    updateModalPhaseNav();         // met Ã  jour le surlignage des emojis
    updateServeDrinkLabel?.();     // garde les libellÃ©s Ã  jour si besoin (repas/boisson)
resetDrinkUI(true);
reopenSameSeat();              // rouvre la mÃªme fiche dans le nouveau mode
+ ensureDrinkGridActive();
reactivateDrinkGrid();         // â† AJOUTÃ‰ aprÃ¨s
initDrinkGrid?.();             // â† AJOUTÃ‰ aprÃ¨s
// (nouveau) MAJ horodateur inline aprÃ¨s changement de phase
if (modalSeat) {
  if (store.phase === "tc")       updateTCInline(modalSeat.key);
  else if (store.phase === "repas") updateMealDrinkInline(modalSeat.key);
}
  });
  reactivateDrinkGrid();
initDrinkGrid?.();
document.querySelectorAll('#drinkGrid .pill').forEach(b => {
  b.disabled = false;
  b.style.pointerEvents = 'auto';
});

});

function updateModalPhaseNav(){
  const L = I18N[store.config.lang || "EN"] || I18N.EN;
  const bF = document.getElementById("navFicheBtn");
  const bA = document.getElementById("navAperoBtn");
  const bM = document.getElementById("navMealBtn");
  const bT = document.getElementById("navTCBtn");

  // Tooltips localisÃ©s (on rÃ©utilise les clÃ©s des chips)
  if (bF){ bF.title = L.chips_fiche || "Pax record"; }
  if (bA){ bA.title = L.chips_apero || "Aperitif"; }
  if (bM){ bM.title = L.chips_meal  || "Main"; }      // ğŸ±
  if (bT){ bT.title = L.chips_tc    || "Tea & Coffee"; }

  // 1) on montre TOUS les boutons (plus de display:none)
  [bF,bA,bM,bT].forEach(btn=>{
    if (!btn) return;
    btn.style.display = "";              // <- enlÃ¨ve tout masquage Ã©ventuel
    btn.classList.remove("active");      // <- reset du surlignage
    btn.setAttribute("aria-pressed","false");
  });

  // 2) on surligne le mode actif (mÃªme logique que le bouton ğŸ˜´ -> classe .active)
  const ph = store.phase;
  if (ph === "fiche"    && bF){ bF.classList.add("active"); bF.setAttribute("aria-pressed","true"); }
  if (ph === "aperitif" && bA){ bA.classList.add("active"); bA.setAttribute("aria-pressed","true"); }
  if (ph === "repas"    && bM){ bM.classList.add("active"); bM.setAttribute("aria-pressed","true"); }
  if (ph === "tc"       && bT){ bT.classList.add("active"); bT.setAttribute("aria-pressed","true"); }
}


document.getElementById("tc_milk")?.addEventListener("change", tc_save);
document.getElementById("tc_sweet")?.addEventListener("change", tc_save);
document.getElementById("tc_the_type")?.addEventListener("change", tc_save);
document.getElementById("tc_beer")?.addEventListener("change", tc_save);
document.getElementById("tc_soft_type")?.addEventListener("change", ()=>{ tc_updateSoftUI(); tc_save(); updateServeDrinkButtons(); });
document.getElementById("tc_soft_jus")?.addEventListener("change", ()=>{ 
  tc_updateSoftUI(); 
  tc_save(); 
  updateServeDrinkButtons();          // â† important : rÃ©Ã©value l'Ã©tat du bouton "Servir"
});

["tc_soft_eau","tc_soft_coca","tc_soft_ice","tc_soft_lemon","tc_soft_ice2","tc_soft_lemon2","tc_soft_salt","tc_soft_pepper","tc_soft_ice4","tc_soft_lemon4",
 "tc_cocktail_type","tc_cocktail_ice","tc_cocktail_lemon"]
.forEach(id=> document.getElementById(id)?.addEventListener("change", tc_save));

const _vr = document.getElementById("tc_vin_rouge");
const _vb = document.getElementById("tc_vin_blanc");

_vr?.addEventListener("change", () => {
  if (_vr.value) {
    // On vide et on dÃ©sactive Blanc
    if (_vb) { _vb.value = ""; _vb.disabled = true; }
  } else {
    if (_vb) _vb.disabled = false;
  }
  tc_save();
  enforceWineExclusivity();
});

_vb?.addEventListener("change", () => {
  if (_vb.value) {
    // On vide et on dÃ©sactive Rouge
    if (_vr) { _vr.value = ""; _vr.disabled = true; }
  } else {
    if (_vr) _vr.disabled = false;
  }
  tc_save();
  enforceWineExclusivity();
});

document.getElementById("tc_vin_notes")?.addEventListener("input", tc_save);
document.getElementById("tc_champ_ice")?.addEventListener("change", tc_save);
document.getElementById("tc_vin_ice")?.addEventListener("change", tc_save);
document.getElementById("tc_digestif_type")?.addEventListener("change", tc_save);
document.getElementById("tc_digestif_ice")?.addEventListener("change", tc_save);



// === Plateau dÃ©barrassÃ© / Annuler dÃ©barrassage ===
document.getElementById("clearTrayBtn")?.addEventListener("click", () => {
  if (!modalSeat) return;
  const d = modalSeat.data;
  const L = I18N[store.config.lang||"EN"];

  if (!d.occupied || !d.served?.meal) { alert(L.alertSeatEmpty); return; }

  // ğŸ‘‰ On ne touche NI Ã  lâ€™inventaire NI Ã  trayUsed
  if (!d.served.trayCleared) {
    d.served.trayCleared = true;
    addHistoryEvt({ type:"trayCleared", seat: modalSeat.key });
  } else {
    d.served.trayCleared = false;
    addHistoryEvt({ type:"trayUncleared", seat: modalSeat.key });
  }

  playBeep();
  save();
  refreshBadges();
resetDrinkUI(true);
reactivateDrinkGrid();
initDrinkGrid?.();
openSeatModal(modalSeat.row, modalSeat.col);
  renderSeatmap();
  renderServiceFlow();
});

// --- RIEN en PLAT PRINCIPAL (ne pousse rien dans l'historique) ---
document.getElementById("serveMealNone")?.addEventListener("click", () => {
  if (!modalSeat) return;
  const L = I18N[store.config.lang||"EN"];
  const d = modalSeat.data;
  if (!d.occupied){ alert(L.alertSeatEmpty); return; }

  // Marquer "plat servi" sans plateau ni historique
  if (!d.served) d.served = {};
  d.served.meal = Date.now();
  d.served.mealNone = true;          // <- flag â€œRienâ€
  d.served.trayUsed = false;         // <- aucun plateau consommÃ©
  d.served.trayFromReservation = false;

  playBeep();
  save();
resetDrinkUI(true);
reactivateDrinkGrid();
initDrinkGrid?.();
openSeatModal(modalSeat.row, modalSeat.col);
  renderSeatmap();
  renderServiceFlow();
  updateServeMealButtonState();
});


$("#serveMeal").addEventListener("click", ()=>{
  if(!modalSeat) return;
  const L = I18N[store.config.lang||"EN"];
  const d = modalSeat.data;
  if(!d.occupied){ alert(L.alertSeatEmpty); return; }

let wasServed = !!d.served.meal;
const wasNone = !!(d.served && d.served.mealNone);
if (wasNone) wasServed = false;  // <- si c'Ã©tait â€œRienâ€, on traite comme â€œpas encore serviâ€

  // On regarde le choix actuel, mais on utilisera surtout le flag trayUsed
  const chosenMeal = ($("#m_normalMeal")?.value || d.normalMeal || "").trim();
  const hasChoice =
    !!d.spml ||
    !!d.preLabel ||
    ["viande","vege","plateau"].includes(chosenMeal);

  if (!hasChoice && !wasServed) { alert(L.alertChoose); return; }

  const needsTray = (m, seat)=> (
    m === 'plateau' || m === 'viande' || m === 'vege' ||
    !!seat.spml || !!seat.preLabel
  );

  if(!wasServed){
    // PREMIER CLIC = servir
const consumeTray = needsTray(chosenMeal, d);
if (consumeTray) {
  const hadReservedTray = (chosenMeal === "plateau") && !!(d.alloc && d.alloc.trayReserved);

  if (hadReservedTray) {
    // on utilise la rÃ©servation, donc on NE re-dÃ©crÃ©mente PAS
    d.served.trayUsed = true;
    d.served.trayFromReservation = true;   // nouveau flag pour l'annulation
    // la rÃ©servation reste consommÃ©e : plus de seat.alloc.trayReserved
    d.alloc.trayReserved = false;
  } else {
    // cas normal (viande/vÃ©gÃ©/SPML/Pre, ou plateau sans rÃ©servation)
    if ((store.inventory.plateaux || 0) <= 0) { alert(L.alertNoTrays); return; }
    store.inventory.plateaux--;
    d.served.trayUsed = true;
    d.served.trayFromReservation = false;
    refreshBadges();
  }
} else {
  d.served.trayUsed = false;
  d.served.trayFromReservation = false;
}


    d.served.meal = Date.now();
d.served.mealNone = false;       // <- on sort de lâ€™Ã©tat â€œRienâ€

const label = d.spml ? d.spml
  : (d.preLabel ? d.preLabel
     : (chosenMeal==="viande" ? (store.menu.viandeLabel || I18N[store.config.lang||"EN"].optNormalMeat)
        : (chosenMeal==="vege" ? (store.menu.vegeLabel || I18N[store.config.lang||"EN"].optNormalVeg)
           : (chosenMeal==="plateau" ? "__TRAY__" : ""))));
addHistoryEvt({ type:"mealServed", seat: modalSeat.key, label });

    // (Historique dÃ©jÃ  gÃ©rÃ© ailleurs si besoin)
  }else{
// DEUXIÃˆME CLIC = annuler le service (dÃ©cliquer)
if (d.served.trayUsed) {
  // si le tray venait d'une rÃ©servation, on NE rajoute PAS 1 au stock
  if (!d.served.trayFromReservation) {
    store.inventory.plateaux = (store.inventory.plateaux || 0) + 1;
    refreshBadges();
  }
  d.served.trayUsed = false;
  d.served.trayFromReservation = false;
}
d.served.meal = null;

    addHistoryEvt({ type:"serviceCanceled", seat: modalSeat.key });
  }

  playBeep(); save();
resetDrinkUI(true);
reactivateDrinkGrid();
initDrinkGrid?.();
openSeatModal(modalSeat.row, modalSeat.col);
  renderSeatmap();
renderServiceFlow(); 
updateServeMealButtonState();

});

$("#m_later").addEventListener("change", (e)=>{ const val=e.target.value; const timeInput=$("#m_later_time"); timeInput.style.display=(val==="custom")?"inline-block":"none"; });

function scheduleReminderFor(seat, minutes, atTimeStr=null){ const now=new Date(); let target=null; if(atTimeStr){ const [hh,mm]=atTimeStr.split(":").map(x=>parseInt(x,10)); target=new Date(); target.setHours(hh,mm,0,0); if(target.getTime()<now.getTime()) target=new Date(target.getTime()+24*3600*1000);} else { target=new Date(now.getTime()+minutes*60*1000);} seat.serveLaterAt=target.getTime(); store.reminders.push({key:modalSeat.key, at:seat.serveLaterAt}); save(); renderReminders(); renderServiceFlow(); }

function setLaterButtonState(){
  const btn   = document.getElementById("m_later_apply");
  const cancel= document.getElementById("m_later_cancel");
  const view  = document.getElementById("m_later_view");
  const sel   = document.getElementById("m_later")?.value;
  const tVal  = document.getElementById("m_later_time")?.value;

  if (!btn || !modalSeat) return;
  const seat = modalSeat.data || {};
  const now = Date.now();
  const hasActive = !!(seat.serveLaterAt && seat.serveLaterAt > now);

  // Bouton SET activÃ© seulement si "Timeâ€¦" + heure saisie + aucun timer actif
  btn.disabled = hasActive || sel !== "custom" || !tVal;

  // Bouton CANCEL visible uniquement si un timer est actif
  if (cancel) cancel.style.display = hasActive ? "" : "none";

  // Affichage de lâ€™heure programmÃ©e
  if (view){
    if (hasActive) {
      const hhmm = new Date(seat.serveLaterAt)
        .toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"});
      view.textContent = "ğŸ•°ï¸ " + hhmm;
      view.style.display = "";
    } else {
      view.textContent = "";
      view.style.display = "none";
    }
  }
}

$("#m_later_time").addEventListener("change", ()=>{
  if (typeof setLaterButtonState==='function') setLaterButtonState();
});

$("#m_later_apply").addEventListener("click", ()=>{
  if (!modalSeat) return;
  const L = I18N[store.config.lang || "EN"];
  const t = $("#m_later_time").value;
  if (!t) { alert(L.alertPickTime); return; }
  scheduleReminderFor(modalSeat.data, 0, t);
  if (typeof setLaterButtonState==='function') setLaterButtonState();
});

document.getElementById("m_later_cancel")?.addEventListener("click", ()=>{
  if (!modalSeat) return;
  const key = modalSeat.key;
  // supprimer tous les rappels pour ce siÃ¨ge
  store.reminders = (store.reminders || []).filter(r => r.key !== key);
  // vider le timer du siÃ¨ge
  modalSeat.data.serveLaterAt = null;
  save(); renderReminders(); renderSeatmap(); renderServiceFlow();
  setLaterButtonState();
});


$("#closeModal").addEventListener("click", ()=>{ persistModal(); closeSeatModal(); });
// champs encore prÃ©sents
["m_status","m_lang","m_notes","m_aperoNotes","m_eatWith"].forEach(id=>{
  const el = document.getElementById(id);
  if (el) el.addEventListener("change", persistModal);
const elTcNotes = document.getElementById("m_tcNotes");
if (elTcNotes) elTcNotes.addEventListener("change", persistModal);

});

// nouveaux contrÃ´les
document.getElementById("m_occ_chk")?.addEventListener("change", persistModal);
document.getElementById("m_sleep_chk")?.addEventListener("change", persistModal);
document.querySelectorAll('input[name="m_type"]').forEach(r=>{
  r.addEventListener("change", persistModal);
});

$("#m_later").addEventListener("change", ()=>{
  if (!modalSeat) return;
  const val = $("#m_later").value;

  if (val === "") {
    // annule tout rappel existant
    modalSeat.data.serveLaterAt = null;
    save(); renderReminders(); renderSeatmap(); renderServiceFlow();
    if (typeof setLaterButtonState==='function') setLaterButtonState();
    return;
  }

  if (val === "custom") {
    // on attend le clic sur le bouton "Set time"
    if (typeof setLaterButtonState==='function') setLaterButtonState();
    return;
  }

  // +5 / +10 / +20 â†’ planifie directement
  scheduleReminderFor(modalSeat.data, parseInt(val, 10));
  if (typeof setLaterButtonState==='function') setLaterButtonState();
});

function renderReminders(){ 
const lang = store.config.lang || "EN";
const cancelTxt = (lang==="FR") ? "Annuler" : (lang==="DE" ? "LÃ¶schen" : "Cancel");
const box=$("#remindersList"); box.innerHTML=""; const now=Date.now(); store.reminders=store.reminders.filter(r=> (r.at && r.at>now)); const arr=[...store.reminders].sort((a,b)=>a.at-b.at); for(const r of arr){ const div=document.createElement("div"); div.className="row"; const seat=store.seats[r.key]; const at=new Date(r.at).toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"}); const txt=document.createElement("div"); txt.textContent=r.key+" â†’ "+at+(seat?.sleep?" (ğŸ˜´)":""); const del=document.createElement("button"); del.className="btn"; del.textContent=cancelTxt; del.addEventListener("click", ()=>{ const idx=store.reminders.findIndex(x=>x.key===r.key && x.at===r.at); if(idx>=0) store.reminders.splice(idx,1); if(store.seats[r.key]) store.seats[r.key].serveLaterAt=null; save(); renderReminders(); renderSeatmap(); renderServiceFlow(); }); div.appendChild(txt); div.appendChild(del); box.appendChild(div);} save(); }
setInterval(()=>{ const now=Date.now(); for(const r of store.reminders){ if(r.at && now>=r.at){ const L = I18N[store.config.lang||"EN"];
addHistory(L.remindServe + " " + r.key); playBeep(); r.at=null; if(store.seats[r.key]) store.seats[r.key].serveLaterAt=null; renderSeatmap(); renderServiceFlow(); } } store.reminders=store.reminders.filter(r=> r.at); renderReminders(); renderServiceFlow(); }, 1000);

// === Service Flow ===
const COL_ORDER = ["A","B","C","D","E","F"];
function colExists(c){
  if (c==="B") return (store.config.layout==="A320"); // B absent sur A220
  return true; // A,C,D,E,F existent
}
// PrioritÃ© pour la PRISE DE COMMANDE uniquement :
// CHML (0) â†’ HON (1) â†’ SEN (2) â†’ autres (3) â†’ PAD (4 = tout Ã  la fin)
function seatCategoryRank(seat){
  if (seat.spml === "CHML") return 0;
  if (seat.status === "HON") return 1;
  if (seat.status === "SEN") return 2;
  if (seat.status === "PAD") return 4;   // PAD en dernier pour la prise de commande
  return 3;
}

function currentPhaseKey(){
  if (store.phase === "aperitif") return "aperitif";
  if (store.phase === "tc")       return "tc";      // â† AJOUT clÃ© TC
  return "meal";                                   // "repas"
}

// --- Service Flow (UNIQUE, propre) ---

function computeServiceFlow(){
  const now = Date.now();
  const rows = store.config.rowsBiz || 0;
  const phaseKey = currentPhaseKey(); // "aperitif" | "meal"
  const isMealPhase = (store.phase === "repas"); // true = Plat, false = ApÃ©ritif/TC

  // Candidats = occupÃ©s, non servis sur la phase, pas "plus tard"
  const candidates = [];
  for (let r = 1; r <= rows; r++){
    for (const c of COL_ORDER){
      if (!colExists(c)) continue;
      const seat = seatObj(r, c);
      if (!seat.occupied) continue;
      if (seat.served[phaseKey]) continue;
      if (seat.serveLaterAt && seat.serveLaterAt > now) continue;
      candidates.push({ key: r + c, r, c, seat });
    }
  }

  // Chemin de service : Ã©veillÃ©s d'abord, puis CHML, puis 1â†’X, Aâ†’F
 let serveList = [...candidates].sort((a,b)=>{
  // 0) Ã©veillÃ©s d'abord, dormeurs Ã  la fin (inchangÃ©)
  const sa = a.seat.sleep ? 1 : 0;
  const sb = b.seat.sleep ? 1 : 0;
  if (sa !== sb) return sa - sb;

  // 1) PrioritÃ© CHML UNIQUEMENT pendant le PLAT
  if (isMealPhase) {
    const pa = (a.seat.spml === "CHML") ? 0 : 1;
    const pb = (b.seat.spml === "CHML") ? 0 : 1;
    if (pa !== pb) return pa - pb;
  }

  // 2) Ordre cabine normal (rang 1â†’X, puis Aâ†’F)
  if (a.r !== b.r) return a.r - b.r;
  return COL_ORDER.indexOf(a.c) - COL_ORDER.indexOf(b.c);
});

serveList = groupEatWith(serveList);

  // Ã€ commander = aucun choix (ni SPML, ni prÃ©co, ni normal)
  const needsOrder = candidates.filter(x=>{
    const s = x.seat;
    return !(s.spml || s.preLabel || s.normalMeal);
  });

  // Prise de commande : Ã©veillÃ©s â†’ dormeurs, puis CHMLâ†’HONâ†’SENâ†’autresâ†’PAD, puis 1â†’X, Aâ†’F
  let orderList = needsOrder.sort((a,b)=>{
  // 0) Ã©veillÃ©s d'abord
  const sa = a.seat.sleep ? 1 : 0;
  const sb = b.seat.sleep ? 1 : 0;
  if (sa !== sb) return sa - sb;

  // 1) Rang VIP/HON/SEN/PAD UNIQUEMENT pendant le PLAT
  if (isMealPhase) {
    const ra = seatCategoryRank(a.seat); // CHML=0, HON=1, SEN=2, autres=3, PAD=4
    const rb = seatCategoryRank(b.seat);
    if (ra !== rb) return ra - rb;
  }

  // 2) Ordre cabine normal (rang 1â†’X, puis Aâ†’F)
  if (a.r !== b.r) return a.r - b.r;
  return COL_ORDER.indexOf(a.c) - COL_ORDER.indexOf(b.c);
});

orderList = groupEatWith(orderList);

  // Ã€ dÃ©barrasser = repas servi mais plateau NON dÃ©barrassÃ©
  const clearList = [];
  for (let r = 1; r <= rows; r++){
    for (const c of COL_ORDER){
      if (!colExists(c)) continue;
      const seat = seatObj(r, c);
if (!seat.occupied) continue;
// Ã€ dÃ©barrasser seulement si un plateau a Ã©tÃ© utilisÃ© ET pas encore dÃ©barrassÃ©
if (seat.served?.meal && seat.served?.trayUsed && !seat.served?.trayCleared){
  clearList.push({ key: r + c, r, c, seat });
}
    }
  }
  clearList.sort((a,b)=>{
    if (a.r !== b.r) return a.r - b.r;
    return COL_ORDER.indexOf(a.c) - COL_ORDER.indexOf(b.c);
  });
// Regroupe les pax "eat together" en les mettant cÃ´te Ã  cÃ´te dans la liste
function groupEatWith(list){
  const idx = new Map(list.map((x,i)=>[x.key, i]));
  const seen = new Set();
  const out = [];
  for (const x of list){
    if (seen.has(x.key)) continue;
    out.push(x);
    seen.add(x.key);
    const partnerKey = x.seat?.eatWith;
    if (partnerKey && idx.has(partnerKey) && !seen.has(partnerKey)){
      out.push(list[idx.get(partnerKey)]);
      seen.add(partnerKey);
    }
  }
  return out;
}

  return { serveList, orderList, clearList };
}

function escapeHTML(s){ return String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

// Construit le tag de CHOIX REPAS pour le service path
function mealChoiceTagHTML(d){
  // d = seat.data
  // PrioritÃ© : SPML > Pre-order > Normal
  if (d.spml) {
    const cls = (d.spml === "CHML") ? 'tag chml' : 'tag';
    return `<span class="${cls}">${escapeHTML(d.spml)}</span>`;
  }
  if (d.preLabel) {
    return `<span class="tag">${escapeHTML(d.preLabel)}</span>`;
  }
  const nm = (d.normalMeal || "").trim();  // "viande" | "vege" | "plateau" | ""
  if (!nm) return "";
  const emoji = (nm === "viande") ? "1ï¸âƒ£" : (nm === "vege") ? "2ï¸âƒ£" : "ğŸ±"; // plateau = ğŸ±
  return `<span class="tag">${emoji}</span>`;
}

function renderServiceFlow(){
  const L = I18N[store.config.lang || "EN"];
  const boxNow   = document.getElementById("flowNow");     // chemin de service
  const boxLater = document.getElementById("flowLater");   // commandes Ã  prendre
  const boxClear = document.getElementById("flowClear");   // Ã  dÃ©barrasser
  if (!boxNow || !boxLater) return;

// Masquer / afficher sections selon la phase
const laterSection = document.getElementById("flowLaterTitle")?.parentElement; // "Orders to take"
const nowSection   = document.getElementById("flowNowTitle")?.parentElement;   // "Service path"
const clearSection = document.getElementById("flowClearTitle")?.parentElement; // "Ã€ dÃ©barrasser"

const isApero = (store.phase === "aperitif");
const isTC    = (store.phase === "tc");
const isFiche = (store.phase === "fiche");

// ApÃ©ritif & T&C : cacher Service path + Ã€ dÃ©barrasser
if (nowSection)   nowSection.style.display   = (isApero || isTC || isFiche) ? "none" : "";
if (clearSection) clearSection.style.display = (isApero || isTC || isFiche) ? "none" : "";

// Fiche pax : cacher aussi Orders to take
if (laterSection) laterSection.style.display = isFiche ? "none" : "";

  // nettoie les 3 colonnes
  boxNow.innerHTML = "";
  boxLater.innerHTML = "";
  if (boxClear) boxClear.innerHTML = "";

  const { serveList, orderList, clearList } = computeServiceFlow();

// --- Colonne du haut (TOP) ---
{
  const t = document.getElementById("flowLaterTitle");
  if (t) {
    t.textContent =
      (store.phase === "aperitif") ? (L.flowAperoTakenTitle || "Orders taken â¬‡ï¸") :
      (store.phase === "tc")       ? (L.flowTCTakenTitle    || "Tea & coffee taken â¬‡ï¸") :
                                     (L.flowLaterTitle      || "Orders to take â¬‡ï¸");
  }

  if (store.phase === "aperitif" || store.phase === "tc") {
    // En apÃ©ritif : apServed ; en T&C : tcServed
    const evtType = (store.phase === "aperitif") ? "apServed" : "tcServed";  // â† clÃ© historique existante
const list = (Array.isArray(store.history) ? store.history : [])
  .filter(ev => ev && ev.type === evtType && (evtType !== "tcServed" || ev.ctx !== "repas"));

    if (list.length === 0) {
      const p = document.createElement("div");
      p.style.color = "var(--muted)";
      p.textContent = L.flowEmptyTaken || "No orders taken yet";
      boxLater.appendChild(p);
    } else {
      for (const ev of list) {
        // RÃ©cup tags statut/drapeaux/sleep depuis le siÃ¨ge courant (si encore prÃ©sent)
        let d = null;
        if (typeof parseSeatKey === "function") {
          const [r, c] = parseSeatKey(ev.seat || "");
          if (r && c && typeof seatObj === "function") d = seatObj(r, c);
        }
        const tags = [];
        if (d) {
          if (d.status === "HON") tags.push('<span class="tag hon">HON</span>');
          else if (d.status === "SEN") tags.push('<span class="tag sen">SEN</span>');
          else if (d.status === "VIP") tags.push('<span class="tag vip">VIP</span>');
          else if (d.status === "FCL") tags.push('<span class="tag fcl">FCL</span>');
          else if (d.status === "PAD") tags.push('<span class="tag pad">PAD</span>');
          else if (d.status === "FTL") tags.push('<span class="tag ftl">FTL</span>');
          if (d.eatWith) tags.push('<span class="tag">ğŸ¤ ' + d.eatWith + '</span>');
          if (d.sleep)   tags.push('<span class="tag sleep">ğŸ˜´</span>');
        }

        // LibellÃ© boisson + notes â€” on rÃ©utilise ton rÃ©sumeur + emoji
        const em    = (typeof drinkEmoji === "function") ? (drinkEmoji(ev.ap) || "") : "";
        const label = (typeof summarizeApDrink === "function") ? (summarizeApDrink(ev.ap, L, store.config.lang) || "") : "";
        const notes = (ev.notes || "").trim();
        const sub   = [label, notes].filter(Boolean).join(" â€” ");
        const subHtml = sub ? `<div class="flow-sub">${(em ? em + " " : "")}${escapeHTML(sub)}</div>` : "";

        const row = document.createElement("div");
        row.className = "flow-item";
        row.dataset.key = ev.seat || "";
        row.innerHTML = `
          <div class="flow-seat">${ev.seat || ""}</div>
          <div class="flow-desc">${tags.join(" ")}${subHtml}</div>
          <div class="tag">${L.flowTaken || "Taken"}</div>
        `;
        row.addEventListener("click", ()=> onSeatClick?.(ev.seat || ""));
        boxLater.appendChild(row);
      }
    }
  } else {
    // COMPORTEMENT NORMAL (non-apÃ©ritif) = commandes Ã  prendre
    if (orderList.length === 0){
      const p = document.createElement("div");
      p.style.color = "var(--muted)";
      p.textContent = L.flowEmptyLater || "Aucune commande Ã  prendre";
      boxLater.appendChild(p);
    } else {
      for (const item of orderList){
        const d = item.seat;
        const tags = [];
        if (d.status === "HON") tags.push('<span class="tag hon">HON</span>');
        else if (d.status === "SEN") tags.push('<span class="tag sen">SEN</span>');
        else if (d.status === "VIP") tags.push('<span class="tag vip">VIP</span>');
        else if (d.status === "FCL") tags.push('<span class="tag fcl">FCL</span>');
        else if (d.status === "PAD") tags.push('<span class="tag pad">PAD</span>');
        else if (d.status === "FTL") tags.push('<span class="tag ftl">FTL</span>');
        if (d.eatWith) tags.push('<span class="tag">ğŸ¤ '+d.eatWith+'</span>');
        if (d.sleep)   tags.push('<span class="tag sleep">ğŸ˜´</span>');

        const row = document.createElement("div");
        row.className = "flow-item";
        row.dataset.key = item.key;

        const mealTag = mealChoiceTagHTML?.(d);
        if (mealTag) tags.unshift(mealTag);

        row.innerHTML = `
          <div class="flow-seat">${item.key}</div>
          <div class="flow-desc">${tags.join(" ")}</div>
          <div class="tag">${L.flowTakeOrder || "Order"}</div>
        `;
        row.addEventListener("click", ()=> onSeatClick(item.key));
        boxLater.appendChild(row);
      }
    }
  }
}

  // --- Chemin de service (BOTTOM)
  if (serveList.length === 0){
    const p = document.createElement("div");
    p.style.color = "var(--muted)";
    p.textContent = L.flowEmptyLater || "No passenger to serve";
    boxNow.appendChild(p);
  } else {
    for (const item of serveList){
      const d = item.seat;
      const tags = [];
      if (d.status === "HON") tags.push('<span class="tag hon">HON</span>');
      else if (d.status === "SEN") tags.push('<span class="tag sen">SEN</span>');
      else if (d.status === "VIP") tags.push('<span class="tag vip">VIP</span>');
      else if (d.status === "FCL") tags.push('<span class="tag fcl">FCL</span>');
      else if (d.status === "PAD") tags.push('<span class="tag pad">PAD</span>');
      else if (d.status === "FTL") tags.push('<span class="tag ftl">FTL</span>');
      if (d.eatWith) tags.push('<span class="tag">ğŸ¤ ' + d.eatWith + '</span>');
      if (d.sleep) tags.push('<span class="tag sleep">ğŸ˜´</span>');

      const row = document.createElement("div");
      row.className = "flow-item";
      row.dataset.key = item.key;

      // â† AJOUT : mettre le choix de repas en premier
const mealTag = mealChoiceTagHTML(d);
if (mealTag) tags.unshift(mealTag);

const drinkLineNow = mealDrinkLineHTML(item.key);
row.innerHTML = `
  <div class="flow-seat">${item.key}</div>
  <div class="flow-desc">${tags.join(" ")}</div>
  <div class="tag">${L.flowServeTag || "Serve"}</div>
  ${drinkLineNow}
`;

row.addEventListener("click", ()=> onSeatClick(item.key));
      boxNow.appendChild(row);
    }
  }

  // --- Ã€ dÃ©barrasser (MIDDLE)
  if (boxClear){
    if (!clearList || clearList.length === 0){
      const p = document.createElement("div");
      p.style.color = "var(--muted)";
      p.textContent = L.flowEmptyClear || "Rien Ã  dÃ©barrasser";
      boxClear.appendChild(p);
    } else {
      for (const item of clearList){
        const d = item.seat;
        const tags = [];
        if (d.status === "HON") tags.push('<span class="tag hon">HON</span>');
        else if (d.status === "SEN") tags.push('<span class="tag sen">SEN</span>');
        else if (d.status === "VIP") tags.push('<span class="tag vip">VIP</span>');
        else if (d.status === "FCL") tags.push('<span class="tag fcl">FCL</span>');
        else if (d.status === "PAD") tags.push('<span class="tag pad">PAD</span>');
        else if (d.status === "FTL") tags.push('<span class="tag ftl">FTL</span>');
        if (d.sleep) tags.push('<span class="tag sleep">ğŸ˜´</span>');

        const row = document.createElement("div");
        row.className = "flow-item";
        row.dataset.key = item.key;
        row.innerHTML = `
          <div class="flow-seat">${item.key}</div>
          <div class="flow-desc">${tags.join(" ")}</div>
          <div class="tag">ğŸ§¹ ${L.flowClearTag || "Ã€ dÃ©barrasser"}</div>
        `;
row.addEventListener("click", ()=> onSeatClick(item.key));
        boxClear.appendChild(row);
      }
    }
  }
}


// Header & exports

function initLangButtons(){
  const wrap  = document.getElementById("langDropdown");
  const active= document.getElementById("langActive");
  const menu  = document.getElementById("langMenu");

  if (!wrap || !active || !menu) return;

  // Affiche la langue courante sur le bouton
const setActiveLabel = () => {
  const flags = { EN:"ğŸ‡¬ğŸ‡§", DE:"ğŸ‡©ğŸ‡ª", FR:"ğŸ‡«ğŸ‡·" };
  const code  = (store.config.lang || "EN");
  active.textContent = (flags[code] || "ğŸ‡¬ğŸ‡§") + " â–¾";
};
  setActiveLabel();

  // Ouvre/ferme le menu
  active.addEventListener("click", (e)=>{
    e.stopPropagation();
    const open = wrap.classList.toggle("open");
    active.setAttribute("aria-expanded", String(open));
    // highlight lâ€™option courante
    menu.querySelectorAll("[data-lang]").forEach(b=>{
      b.classList.toggle("primary", b.dataset.lang === (store.config.lang || "EN"));
    });
  });

  // Choix dâ€™une langue
  menu.querySelectorAll("[data-lang]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const code = btn.dataset.lang;
      if (!code) return;

      store.config.lang = code;
      save();
      applyI18n();
      renderHistory();
      renderSeatmap();
      renderServiceFlow();

      // Si la modale siÃ¨ge est ouverte, re-ouvre proprement (comme tu le fais dÃ©jÃ )
      if (document.getElementById("modalBack")?.style.display === "flex") {
        if (typeof reopenSameSeat === "function") reopenSameSeat();
      }

      setActiveLabel();
      wrap.classList.remove("open");
      active.setAttribute("aria-expanded", "false");
    });
  });

  // Fermer en cliquant ailleurs
  document.addEventListener("click", (e)=>{
    if (!wrap.contains(e.target)) {
      wrap.classList.remove("open");
      active.setAttribute("aria-expanded", "false");
    }
  });
}

// ----- ThÃ¨me jour/nuit -----
function applyTheme(){
  const dark = (store.config.theme === "dark");
  document.body.classList.toggle("theme-dark", dark);
  document.body.classList.toggle("theme-light", !dark);
  const tBtn = document.getElementById("themeToggle");
  if (tBtn) tBtn.textContent = dark ? "â˜€ï¸" : "ğŸŒ™";
}
const themeBtn = document.getElementById("themeToggle");
if (themeBtn){
  themeBtn.addEventListener("click", ()=>{
    store.config.theme = (store.config.theme === "dark") ? "light" : "dark";
    save();
    applyTheme();
  });
}

// SÃ©lecteur de layout cabine
const layoutSel = document.getElementById("layoutSelect");
if (layoutSel){
layoutSel.addEventListener("change", ()=>{
  store.config.layout = layoutSel.value;
  save();
  renderSeatmap();
  renderServiceFlow();   // â† AJOUT
});

}

// boutons inventaire (plateaux/viande/vÃ©gÃ©)
document.querySelectorAll('[data-inv]').forEach(btn=> btn.addEventListener("click", ()=>{ const key=btn.dataset.key; const delta=btn.dataset.inv==="+1"?1:-1; if(key && (key.startsWith("hot_") || key==="plateaux")){ store.inventory[key]=Math.max(0,(store.inventory[key]||0)+delta);} save(); refreshBadges(); }));
// --- ContrÃ´les + / - pour "RangÃ©es CCL" ---
const rowsBizDisplay = document.getElementById("rowsBizDisplay");

document.getElementById("rowsBizMinus").addEventListener("click", ()=>{
  store.config.rowsBiz = Math.max(0, (store.config.rowsBiz||0) - 1);
  rowsBizDisplay.textContent = store.config.rowsBiz;
  save();
  renderSeatmap();
renderServiceFlow();
});

document.getElementById("rowsBizPlus").addEventListener("click", ()=>{
  store.config.rowsBiz = Math.min(15, (store.config.rowsBiz||0) + 1);
  rowsBizDisplay.textContent = store.config.rowsBiz;
  save();
  renderSeatmap();
});

$("#spmlAddBtn").addEventListener("click", ()=>{
  const L = I18N[store.config.lang || "EN"] || I18N.EN;
  const code = ($("#spmlAddCode").value||"").trim().toUpperCase();
  const qty = Math.max(1, parseInt($("#spmlAddQty").value||"1",10));

  if (!code){ alert(L.spmlCodeRequired); return; }

  store.inventory.spml[code] = (store.inventory.spml[code]||0) + qty;
  $("#spmlAddCode").value = "";
  save();
});

document.getElementById("spmlAddCode")
  ?.addEventListener("change", (e)=> e.target.blur());

$("#preAddBtn").addEventListener("click", ()=>{
  const L = I18N[store.config.lang || "EN"] || I18N.EN;
  const label = ($("#preAddLabel").value||"").trim();
  const qty = Math.max(1, parseInt($("#preAddQty").value||"1",10));

  if (!label){ alert(L.preAddLabelRequired); return; }

  store.inventory.pre[label] = (store.inventory.pre[label]||0) + qty;
  $("#preAddLabel").value = "";
  save();
});

$("#filterSelect").addEventListener("change", ()=>{
  renderSeatmap();
  renderServiceFlow();       // â† AJOUT
});
document.querySelectorAll('#phaseChips .chip').forEach(ch=> ch.addEventListener("click", ()=>{ document.querySelectorAll('#phaseChips .chip').forEach(c=>c.classList.remove("active")); ch.classList.add("active"); store.phase=ch.dataset.phase; renderSeatmap(); renderServiceFlow();  updateServeDrinkLabel();// â† AJOUT
 }));

$("#exportPNG").addEventListener("click", ()=>{
  const rows = store.config.rowsBiz || 0;
  const cellW=72, cellH=48, pad=40;
  const leftCols = ["F","E","D"];
  const rCols = rightCols(); // ["C","A"] ou ["C","B","A"]
  const totalCols = leftCols.length + rCols.length;
  const width = pad + (totalCols*cellW) + 28 + 20; // 28 = couloir, 20 = marge sup.
  const height = pad + rows*cellH + 20;

  const canvas=document.createElement("canvas");
  canvas.width=width; canvas.height=height;
  const ctx=canvas.getContext("2d");
  ctx.fillStyle="#ffffff"; ctx.fillRect(0,0,width,height);
  ctx.fillStyle="#000000"; ctx.font="12px system-ui";

  // En-tÃªtes
  let x = pad;
  const headers = leftCols.concat([""]).concat(rCols);
  for(const h of headers){
    if(h===""){ x+=28; continue; }
    ctx.fillText(h, x + cellW/2 - 4, pad-12);
    x += cellW;
  }

  // Lignes
  for (let r = rows; r >= 1; r--) {
    const y = pad + (rows - r) * cellH;
    ctx.fillText(String(r), 10, y + 28);

    // Groupe gauche : F, E, D
    for (let i = 0; i < leftCols.length; i++) {
      const x = pad + i * cellW;
      drawSeatPNG(ctx, r, leftCols[i], x, y, cellW, cellH);
    }

    // Groupe droit : rCols (2 ou 3 cols)
    const rightBase = pad + leftCols.length * cellW + 28;
    for (let i = 0; i < rCols.length; i++) {
      const x = rightBase + i * cellW;
      drawSeatPNG(ctx, r, rCols[i], x, y, cellW, cellH);
    }
  }

  const a=document.createElement("a");
  a.href=canvas.toDataURL("image/png");
  const name=(store.title.flightNo||"vol")+"_"+(store.title.date||"date")+"_seatmap.png";
  a.download=name;
  a.click();
});

function drawSeatPNG(ctx, r, col, x, y, w, h) {
  // Cadre + fond si occupÃ©
  ctx.strokeStyle = "#888";
  ctx.strokeRect(x, y, w - 6, h - 6);

  const seat = seatObj(r, col);

  if (seat.occupied) {
    ctx.fillStyle = "#dce6ff";
    ctx.fillRect(x + 1, y + 1, w - 8, h - 8);
  }

  // LibellÃ© siÃ¨ge (en haut-gauche)
  ctx.fillStyle = "#000";
  ctx.font = "12px system-ui";
  ctx.textBaseline = "alphabetic";
  ctx.fillText(r + col, x + 8, y + 18);

  // === TAG REPAS (en bas-droite) ===
  // (On n'affiche rien si le plateau est dÃ©jÃ  dÃ©barrassÃ©)
  let tag = "";
  if (!(seat?.served?.trayCleared)) {
    const mealEmoji = seat.spml ? null
      : (seat.preLabel ? null
         : (seat.normalMeal === "viande" ? "1ï¸âƒ£"
            : (seat.normalMeal === "vege" ? "2ï¸âƒ£"
               : (seat.normalMeal === "plateau" ? "ğŸ±" : null))));
    tag = seat.spml ? seat.spml : (seat.preLabel ? seat.preLabel : (mealEmoji || ""));
  }

  if (tag) {
    ctx.font = "12px system-ui";
    ctx.fillStyle = "#000";
    ctx.textBaseline = "bottom";
    // lÃ©ger recul du bord droit / bas
    ctx.fillText(tag, x + w - 32, y + h - 6);
    ctx.textBaseline = "alphabetic";
  }

  // === PASTILLE STATUT (en haut-droite) ===
  if (seat.status !== "none") {
    if (seat.status === "FTL") ctx.fillStyle = "#9aa4b2";
    else if (seat.status === "SEN") ctx.fillStyle = "#ffd24d";
    else if (seat.status === "HON") ctx.fillStyle = "#000000";
    else if (seat.status === "VIP") ctx.fillStyle = "#9b5cff";   // violet
    else if (seat.status === "FCL") ctx.fillStyle = "#ff5757";   // rouge
    else if (seat.status === "PAD") ctx.fillStyle = "#39d98a";   // vert
    else ctx.fillStyle = "#666";

    ctx.beginPath();
    ctx.arc(x + w - 20, y + 16, 6, 0, 2 * Math.PI);
    ctx.fill();

    // remettre par dÃ©faut
    ctx.fillStyle = "#000";
  }
}

$("#clientView").addEventListener("click", ()=>{
  // bascule le flag
  store.clientView = !store.clientView;
  save();

  // applique la classe .client (cache seatmap via CSS)
  document.body.classList.toggle("client", store.clientView);

  // NE TOUCHE PLUS AU THEME ICI : on laisse l'utilisateur choisir ğŸŒ™/â˜€ï¸
  // donc pas de store.config.theme = "light", pas de _themeBeforeClient, etc.
  // et on ne dÃ©sactive PAS le bouton de thÃ¨me

  applyTheme();   // applique le thÃ¨me courant (light/dark) sur toute la page
  applyI18n();
  renderSeatmap();
  renderServiceFlow();
});



// --- RÃ©initialisation sans confirm() (double-clic pour confirmer) ---
let resetArmed = false;
let resetTimer = null;

function performFullReset(){
  // 1) RÃ©initialise les donnÃ©es
  store.inventory.plateaux = 0;
  store.inventory.hot_viande = 0;
  store.inventory.hot_vege = 0;
  for (const c of SPML_CODES){ store.inventory.spml[c] = 0; }
  store.inventory.hot_special = 0;
  store.inventory.pre = {};

  store.menu.viandeLabel = "";
  store.menu.vegeLabel   = "";
  store.reminders = [];
  store.history   = [];

  for (const k of Object.keys(store.seats)){
    store.seats[k] = ensureSeatShape({});
  }

  // 2) Force "apÃ©ro" pour cohÃ©rence UI
  store.phase = "fiche";

  // 3) Vide les champs texte visibles
  document.querySelectorAll("input[type='text'], textarea").forEach(el => el.value = "");

  // 4) RÃ©aligne les libellÃ©s visibles avec store.menu
  const lv = document.getElementById("labelViande");
  const lg = document.getElementById("labelVege");
  if (lv) lv.value = "";
  if (lg) lg.value = "";

  // 5) Remet le chip de phase
  document.querySelectorAll('#phaseChips .chip').forEach(c=>c.classList.remove('active'));
  document.querySelector('#phaseChips .chip[data-phase="fiche"]')?.classList.add('active');

  // 6) Re-render
  save();
  renderSeatmap();
  refreshBadges();
  renderHistory();
  renderReminders();

  // Remplace l'alert() finale par un petit log (Ã©vite blocage WebView)
addHistoryEvt({ type:"reset" });

}

const resetBtn = document.getElementById("resetFlight");
if (resetBtn){
  resetBtn.addEventListener("click", ()=>{
    const L = I18N[store.config.lang || "EN"] || I18N.EN;

    if (!resetArmed){
      resetArmed = true;
      const original = L.reset;               // â† texte normal traduit
      resetBtn.textContent = L.resetConfirm;  // â† texte "cliquer Ã  nouveau..." traduit

      // SÃ©curitÃ© : annule l'armement au bout de 5s
      clearTimeout(resetTimer);
      resetTimer = setTimeout(()=>{
        resetArmed = false;
        resetBtn.textContent = original;
      }, 5000);
    } else {
      // 2e clic = exÃ©cution
      clearTimeout(resetTimer);
      resetArmed = false;
      resetBtn.textContent = L.reset;         // â† retour au texte normal traduit
      performFullReset();
    }
  });
}


function migrateHistoryToEvents(){
  if (!Array.isArray(store.history)) return;
  const out = [];
  for (const raw of store.history){
    // dÃ©jÃ  en format objet â†’ on garde
    if (raw && typeof raw === "object" && raw.type){
      out.push(raw); continue;
    }
    // ancien format string
    if (typeof raw !== "string"){ out.push(raw); continue; }

    // on enlÃ¨ve un Ã©ventuel prÃ©fixe [HH:MM]
    const s = raw.replace(/^\s*\[\d{2}:\d{2}\]\s*/,"");

    // essais de mapping FR/EN/DE
    let m;
    if ((m = s.match(/^(ApÃ©ritif servi Ã |Aperitif served at|Aperitif serviert bei)\s+([0-9]+[A-F])/))){
      out.push({ ts: Date.now(), type:"apServed", seat: m[2] }); continue;
    }
    if ((m = s.match(/^(ApÃ©ritif annulÃ© pour|Aperitif canceled for|Aperitif storniert fÃ¼r)\s+([0-9]+[A-F])/))){
      out.push({ ts: Date.now(), type:"apCanceled", seat: m[2] }); continue;
    }
    if ((m = s.match(/^(Plat servi Ã |Main served at|Hauptgang serviert bei)\s+([0-9]+[A-F])(?:\s+â€”\s+(.+))?/))){
      out.push({ ts: Date.now(), type:"mealServed", seat: m[2], label: (m[3]||"") }); continue;
    }
    if ((m = s.match(/^(Service annulÃ© pour|Service canceled for|Service storniert fÃ¼r)\s+([0-9]+[A-F])/))){
      out.push({ ts: Date.now(), type:"serviceCanceled", seat: m[2] }); continue;
    }
    if (/(Vol rÃ©initialisÃ©\.|Flight reset\.|Flug zurÃ¼ckgesetzt\.)/.test(s)){
      out.push({ ts: Date.now(), type:"reset" }); continue;
    }

    // dÃ©faut : on garde en texte brut
    out.push({ ts: Date.now(), type:"text", text: s });
  }
  store.history = out;
}

(function init(){
      const ALWAYS_FRESH_START = true;  // â† dÃ©marrage vierge systÃ©matique

      if (!ALWAYS_FRESH_START){
  try {
    const last = localStorage.getItem("serviceflow::lastKey");
    if (last) {
      const data = loadKeyData(last);
      if (data) Object.assign(store, data);
    }
  } catch(e){}
}

if (!ALWAYS_FRESH_START){
  const keys=Object.keys(localStorage).filter(k=>k.startsWith("cabinboard::")).sort();
  if(keys.length){ const latest=loadKeyData(keys[keys.length-1]); if(latest){ Object.assign(store, latest); } }
}
  if(store.seats && typeof store.seats==='object'){ for(const k of Object.keys(store.seats)){ store.seats[k]=ensureSeatShape(store.seats[k]); } }
  for(const code of SPML_CODES){ if(typeof store.inventory.spml[code]!=="number") store.inventory.spml[code]=0; }
$("#flightNo").value = store.title.flightNo || "";
document.getElementById("flightDateISO").value = store.title.date || "";         // ISO cachÃ©
$("#flightDate").value = fmtDateLocalized(store.title.date || "");               // visible localisÃ©
document.getElementById("flightDate")?.addEventListener("input", updateFlightDatePretty);
updateFlightDatePretty();
const disp = document.getElementById("rowsBizDisplay");
const layoutSel2 = document.getElementById("layoutSelect");
if (layoutSel2) layoutSel2.value = store.config.layout || "A220";
const langSel2 = document.getElementById("langSelect");
if (langSel2) langSel2.value = store.config.lang || "EN";
applyI18n();
renderHistory();
migrateHistoryToEvents();   // â† AJOUT
renderHistory();            // â† AJOUT (rÃ©affiche tout de suite avec la langue courante)
initLangButtons();
// DÃ©faut : dark si rien n'est encore dÃ©fini
store.config.theme = "dark";
applyTheme();
updateSeatmapTitle();
renderSeatmap();
if (disp) disp.textContent = store.config.rowsBiz || 0;
 $("#labelViande").value=store.menu.viandeLabel||""; $("#labelVege").value=store.menu.vegeLabel||"";
  $("#labelViande").addEventListener("change", ()=>{ store.menu.viandeLabel=$("#labelViande").value; save(); });
  $("#labelVege").addEventListener("change", ()=>{ store.menu.vegeLabel=$("#labelVege").value; save(); });
document.body.classList.toggle("client", store.clientView);

// Aligne le chip actif sur la phase rÃ©ellement stockÃ©e
document.querySelectorAll('#phaseChips .chip').forEach(c=>c.classList.remove('active'));
document.querySelector(`#phaseChips .chip[data-phase="${store.phase}"]`)?.classList.add('active');
  renderSeatmap(); refreshBadges(); renderHistory(); renderReminders();
})();

// === Nouveaux Ã©couteurs pour la navigation en 2 Ã©tages ===
document.getElementById("tc_group")?.addEventListener("change", tc_updateGroupUI);
document.getElementById("tc_alcool_type")?.addEventListener("change", tc_updateAlcoolUI);
document.getElementById("tc_chaud_type")?.addEventListener("change", tc_updateChaudUI);
// â€” Forcer la rÃ©Ã©val du bouton "Servir" sur tous les sous-choix visibles â€”
["tc_soft_type","tc_soft_eau","tc_soft_jus","tc_soft_coca","tc_soft_sprite",
"tc_beer","tc_vin_rouge","tc_vin_blanc",
"tc_digestif_type","tc_the_type",
"tc_group","tc_alcool_type","tc_chaud_type"]
.forEach(id => document.getElementById(id)?.addEventListener("change", updateServeDrinkButtons));

// Sync #tc_cat avec le flux 2 Ã©tages
document.getElementById("tc_group")?.addEventListener("change", function(){
  const cat = document.getElementById("tc_cat"); if (cat) cat.value = "";
  updateServeDrinkButtons();
});
document.getElementById("tc_alcool_type")?.addEventListener("change", function(){
  const cat = document.getElementById("tc_cat"); if (cat) cat.value = this.value || "";
  updateServeDrinkButtons();
});
document.getElementById("tc_chaud_type")?.addEventListener("change", function(){
  const cat = document.getElementById("tc_cat"); if (cat) cat.value = this.value || "";
  updateServeDrinkButtons();
});
document.getElementById("tc_soft_type")?.addEventListener("change", function(){
  const cat = document.getElementById("tc_cat"); if (cat) cat.value = "soft";
  updateServeDrinkButtons();
});

// === Forcer la mise Ã  jour du bouton "Servir" sur tous les sous-choix ===
document.getElementById("tc_soft_eau")?.addEventListener("change", updateServeDrinkButtons);
document.getElementById("tc_soft_coca")?.addEventListener("change", updateServeDrinkButtons);
document.getElementById("tc_soft_sprite")?.addEventListener("change", updateServeDrinkButtons);

document.getElementById("tc_beer")?.addEventListener("change", updateServeDrinkButtons);
document.getElementById("tc_vin_rouge")?.addEventListener("change", updateServeDrinkButtons);
document.getElementById("tc_vin_blanc")?.addEventListener("change", updateServeDrinkButtons);
document.getElementById("tc_cocktail_type")?.addEventListener("change", updateServeDrinkButtons);
  // === Dictionnaire de recettes par cocktail et par langue ===
  const COCKTAIL_TIPS = {
    FR: {
      campari: [
        "<b>Campari Orange</b> : GlaÃ§ons, Campari, Jus d'orange",
        "<b>Campari Soda</b> : GlaÃ§ons, Campari, Eau gazeuse"
      ],
      bloody_mary: ["GlaÃ§ons, Vodka, Jus de tomate, sel, poivre, citron"],
screwdriver: ["GlaÃ§ons, Vodka, Jus d'orange"],
      gin_tonic: ["GlaÃ§ons, Gin, Citron, Tonic"],
      cuba_libre: ["GlaÃ§ons, Rhum, Citron, Coca-Cola"]
    },
    EN: {
      campari: [
        "<b>Campari Orange</b>: Ice, Campari, Orange juice",
        "<b>Campari Soda</b>: Ice, Campari, Sparkling water"
      ],
      bloody_mary: ["Ice, Vodka, Tomato juice, salt, pepper, lemon"],
      screwdriver: ["Ice, Vodka, Orange juice"],
      gin_tonic: ["Ice, Gin, Lemon, Tonic"],
      cuba_libre: ["Ice, Rum, Lemon, Coca-Cola"]
    },
    DE: {
      campari: [
        "<b>Campari Orange</b>: Eis, Campari, Orangensaft",
        "<b>Campari Soda</b>: Eis, Campari, Sodawasser"
      ],
      bloody_mary: ["Eis, Wodka, Tomatensaft, Salz, Pfeffer, Zitrone"],
      screwdriver: ["Eis, Wodka, Orangensaft"],
      gin_tonic: ["Eis, Gin, Zitrone, Tonic"],
      cuba_libre: ["Eis, Rum, Zitrone, Coca-Cola"]
    }
  };

  function _tipLang() {
    return (store?.config?.lang || "EN").toUpperCase();
  }
  
function _fillTip(val) {
  const tip = document.getElementById("tc_tip");
  const L = _tipLang();
  const lines = COCKTAIL_TIPS[L]?.[val] || null;
  const bullets = Array.isArray(lines) && lines.length > 1; // puces seulement si >1 ligne (Campari)
  tip.innerHTML = lines
    ? lines.map(l => `<div>${bullets ? "â€¢ " : ""}${l}</div>`).join("")
    : "";
}

  function _showTipButton(val) {
    const btn = document.getElementById("tc_tipBtn");
    const tip = document.getElementById("tc_tip");
    if (!btn || !tip) return;
    if (val) {
      btn.style.display = "inline-flex";
      tip.style.display = "none"; // on ferme si on change
    } else {
      btn.style.display = "none";
      tip.style.display = "none";
    }
  }

  // Remplace l'Ã©couteur existant :
  (function replaceCocktailChangeHandler(){
    const sel = document.getElementById("tc_cocktail_type");
    if (!sel) return;

    // On enlÃ¨ve les anciens listeners potentiels en clonant
    const clone = sel.cloneNode(true);
    sel.parentNode.replaceChild(clone, sel);
    const s = document.getElementById("tc_cocktail_type");

    s.addEventListener("change", e => {
      const val = e.target.value;

      // (1) Sel/poivre uniquement pour Bloody Mary (comme avant)
      const showBM = (val === "bloody_mary");
      document.querySelectorAll("#tc_cocktail .bm-only").forEach(el => {
        el.style.display = showBM ? "inline-flex" : "none";
        if (!showBM) el.querySelector("input").checked = false;
      });

      // (2) Bulle recettes
      _showTipButton(val);
      _fillTip(val);

      // (3) Conduite existante : re-calcul du bouton "Servir"
      updateServeDrinkButtons?.();
      tc_save?.();
    });

    // Bouton (i) : toggle bulle
    document.getElementById("tc_tipBtn")?.addEventListener("click", () => {
      const tip = document.getElementById("tc_tip");
      if (!tip) return;
      tip.style.display = (tip.style.display === "none" || !tip.style.display) ? "block" : "none";
    });

    // Clique hors bulle => fermer
    document.addEventListener("click", (ev) => {
      const wrap = document.getElementById("tc_cocktail_tipwrap");
      const tip  = document.getElementById("tc_tip");
      if (wrap && tip && !wrap.contains(ev.target)) tip.style.display = "none";
    });

    // Init au chargement (au cas oÃ¹ un cocktail est dÃ©jÃ  prÃ©-sÃ©lectionnÃ© quand on rouvre une fenÃªtre siÃ¨ge)
    s.dispatchEvent(new Event("change"));
  })();

// On garde ceux qui existent dÃ©jÃ  :
document.getElementById("tc_soft_type")?.addEventListener("change", function(){
  tc_updateSoftUI();
  updateServeDrinkButtons();
});
document.addEventListener("DOMContentLoaded", () => {
  ensureLegalBanner();      // le crÃ©e dÃ¨s le dÃ©part
  // si applyI18n() est appelÃ©e plus tard par ton code, la phrase se traduira automatiquement
});

// === Sauvegarde disquette â†’ export JSON instantanÃ© ===
document.getElementById("saveSnapshot")?.addEventListener("click", () => {
  // construit un nom de fichier lisible
  const fn  = (store?.title?.flightNo || "no-flight").replace(/\W+/g,"_");
  const d   = (store?.title?.date || "no-date").replace(/\W+/g,"_");
  const name = `SWISS_ServiceFlow-${fn}-${d}.json`;

  // contenu : l'Ã©tat complet (store)
  const blob = new Blob([ JSON.stringify(store, null, 2) ], { type: "application/json" });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement("a");
  a.href = url; a.download = name;
  document.body.appendChild(a); a.click();
  setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 500);
});

function lastMealDrinkEventForSeat(seatKey){
  // Historique newest-first â‡’ le 1er match est le bon
  for (let i = 0; i < store.history.length; i++){
    const ev = store.history[i];
    if (!ev) continue;
    if (ev.type === "tcServed" && ev.seat === seatKey && ev.ctx === "repas"){
      return ev;
    }
  }
  return null;
}
function drinkEmoji(ap){
  if (!ap) return "";
  // Hot
  if (ap.cat === "cafe")      return "â˜•";
  if (ap.cat === "deca")      return "ğŸš«â˜•";
  if (ap.cat === "the")       return "ğŸ«–";
  if (ap.cat === "chocolat")  return "ğŸ«";
  // Soft (dÃ©pend du sous-type)
  if (ap.cat === "soft") {
    if (ap.softType === "eau")    return "ğŸ’§";
    if (ap.softType === "coca")   return "ğŸ¥¤";
    if (ap.softType === "jus")    return "ğŸ§ƒ";
    if (ap.softType === "sprite") return "ğŸŸ¢";
    if (ap.softType === "tonic")  return "ğŸ«§";
  }
  // Alcool
  if (ap.cat === "champagne") return "ğŸ¾";
  if (ap.cat === "vin_rouge") return "ğŸ·";
  if (ap.cat === "vin_blanc") return "ğŸ¥‚";
  if (ap.cat === "biere")     return "ğŸº";
  if (ap.cat === "cocktail")  return "ğŸ¹";
  if (ap.cat === "digestif")  return "ğŸ¥ƒ";
  return "";
}

function mealDrinkLineHTML(seatKey){
  // DerniÃ¨re boisson servie en contexte "repas"
  const ev = lastMealDrinkEventForSeat(seatKey);
  if (!ev) return ""; // rien Ã  afficher si pas encore servie

  const L = I18N[store.config.lang || "EN"];
  let label = "";
  if (ev.ap){
    // RÃ©utilise ton rÃ©sumÃ© boisson existant
    label = summarizeApDrink(ev.ap, L, store.config.lang || "EN") || "";
  }
  const notes = (ev.notes || "").trim();
const txt = [label, notes].filter(Boolean).join(" â€” ");
const em = drinkEmoji(ev.ap);
const withEmoji = (em ? (em + " ") : "") + txt;
return txt ? `<div class="flow-sub">${withEmoji}</div>` : "";
}

function updateMealDrinkInline(seatKey){
  const span = document.getElementById("mhMealDrinkInline");
  if (!span) return;

  const L = I18N[store.config.lang || "EN"];
  const ev = lastMealDrinkEventForSeat(seatKey);
  const prefix = (L.mealDrinkTitle || "Meal drinks") + ": ";

  if (!ev){
    // Affiche le libellÃ© + tiret long quand pas d'event
    span.textContent = prefix + "â€”";
    return;
  }

  const ts = ev.ts || ev.t || null;
  const timeTxt = ts
    ? new Date(ts).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"})
    : "â€”";

  let label = "";
  if (ev.ap){
    label = summarizeApDrink(ev.ap, L, store.config.lang || "EN") || "";
  }

  // Affiche "Meal drinks: HH:MM â€” libellÃ©" si dispo, sinon juste "HH:MM"
  span.textContent = prefix + (label ? `${timeTxt} â€” ${label}` : `${timeTxt}`);
}

// Dernier Ã©vÃ¨nement TC (hors contexte "repas")
function lastTcEventForSeat(seatKey){
  for (let i = 0; i < store.history.length; i++){
    const ev = store.history[i];
    if (!ev) continue;
    if (ev.type === "tcServed" && ev.seat === seatKey && ev.ctx !== "repas"){
      return ev; // premier match = le plus rÃ©cent (newest-first)
    }
  }
  return null;
}

// Met Ã  jour le petit horodateur en phase TC (span #mhTCInline)
function updateTCInline(seatKey){
  const span = document.getElementById("mhTCInline");
  if (!span) return;

  const L = I18N[store.config.lang || "EN"];
  const ev = lastTcEventForSeat(seatKey);
  const prefix = (L.chips_tc || "Tea & Coffee") + ": ";

  if (!ev){
    // Affiche le libellÃ© + tiret long quand pas d'event
    span.textContent = prefix + "â€”";
    return;
  }

  const ts = ev.ts || ev.t || null; // addHistoryEvt met ts
  const timeTxt = ts
    ? new Date(ts).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"})
    : "â€”";

  let label = "";
  if (ev.ap){
    label = summarizeApDrink(ev.ap, L, store.config.lang || "EN") || "";
  }

  // Affiche "Tea & Coffee: HH:MM â€” libellÃ©" si dispo, sinon juste "HH:MM"
  span.textContent = prefix + (label ? `${timeTxt} â€” ${label}` : `${timeTxt}`);
}

if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js").catch(console.error);
  }

  // --- UI â†’ store : synchronise les champs libres avant export ---
function syncUIToStoreForExport(){
  // Vol / date (si lâ€™utilisateur nâ€™a pas cliquÃ© sur ğŸ’¾)
  const fn    = document.getElementById('flightNo');
  const fdISO = document.getElementById('flightDateISO');
  const fd    = document.getElementById('flightDate');
  if (!store.title) store.title = { flightNo:"", date:"" };
  if (fn)   store.title.flightNo = (fn.value || "").trim();
  if (fdISO && fdISO.value) store.title.date = fdISO.value;
  else if (fd)              store.title.date = fd.value;

  // LibellÃ©s Option 1 / Option 2 (les â€œintitulÃ©sâ€ dont tu parles)
  const lv = document.getElementById('labelViande');
  const lg = document.getElementById('labelVege');
  if (!store.menu) store.menu = {};
  if (lv) store.menu.viandeLabel = (lv.value || "").trim();
  if (lg) store.menu.vegeLabel   = (lg.value || "").trim();
}

</script>
</body>
</html>
